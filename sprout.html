<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprout - Access Point</title>
    <link rel="icon" type="image/x-icon" href="/src/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#353539',
                        'green-dark': '#0e3521',
                        'green-medium': '#006936',
                        'green-light': '#5fb14c',
                        'accent-yellow': '#f1ec33',
                        'green-muted': '#4a7c59'
                    },
                    fontFamily: {
                        'sans': ['Google Sans', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-primary-dark font-sans transition-colors duration-300">
    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 md:px-6 py-4 border-b border-green-muted/20 bg-white">
            <div class="flex items-center space-x-3">
                <img src="/src/logo.png" alt="Sprout Logo" class="w-8 h-8">
                <h1 class="text-xl font-medium text-green-dark">Sprout</h1>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4">
                <!-- Current Model Display -->
                <div id="currentModel" class="hidden sm:flex items-center space-x-2 bg-green-light/10 px-3 py-1 rounded-full border border-green-light/20">
                    <div class="w-2 h-2 bg-green-light rounded-full"></div>
                    <span class="text-sm text-green-dark font-medium">Corea Inner Support V1</span>
                </div>
                
                <!-- New Chat Button -->
                <button onclick="clearChat()" class="p-2 hover:bg-green-muted/10 rounded-lg transition-colors text-green-muted" title="New Chat">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>

                <!-- Mood Tracker Button -->
                <button onclick="showMoodTracker()" class="p-2 hover:bg-green-muted/10 rounded-lg transition-colors text-green-muted" title="Mood Tracker">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>

                <!-- Dark Mode Toggle -->
                <button id="darkModeToggle" class="p-2 hover:bg-green-muted/10 rounded-lg transition-colors text-green-muted" title="Toggle Dark Mode">
                    <svg id="darkModeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>

                <!-- Crisis Help Button -->
                <button onclick="showCrisisHelp()" class="p-2 hover:bg-green-muted/10 rounded-lg transition-colors text-green-muted" title="Crisis Help">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </button>

                <!-- Feedback Button -->
                <button onclick="showFeedbackModal()" class="p-2 hover:bg-green-muted/10 rounded-lg transition-colors text-green-muted" title="Provide Feedback">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <main class="flex flex-col h-[calc(100vh-80px)] bg-white">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex flex-col items-center justify-center flex-1 px-4 md:px-6">
                <div class="text-center mb-8 md:mb-12">
                    <h2 class="text-3xl md:text-4xl font-normal text-green-medium mb-4 md:mb-8">Yoohoo, stranger!</h2>
                    <p class="text-green-muted text-lg">I'm here to support your mental wellness journey</p>
                </div>

                <!-- Suggestion Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-4xl mb-8 md:mb-12">
                    <div onclick="sendMessage('I\'m feeling anxious and need some coping strategies')" class="bg-white hover:bg-green-muted/5 rounded-2xl p-4 cursor-pointer transition-colors border border-green-muted/20 hover:border-green-medium/40 shadow-sm">
                        <div class="text-sm font-medium text-green-dark mb-1">Anxiety support</div>
                        <div class="text-sm text-green-muted">coping strategies and techniques</div>
                    </div>
                    
                    <div onclick="sendMessage('Can you help me with mindfulness exercises for stress relief?')" class="bg-white hover:bg-green-muted/5 rounded-2xl p-4 cursor-pointer transition-colors border border-green-muted/20 hover:border-green-medium/40 shadow-sm">
                        <div class="text-sm font-medium text-green-dark mb-1">Mindfulness practice</div>
                        <div class="text-sm text-green-muted">stress relief exercises</div>
                    </div>
                    
                    <div onclick="sendMessage('I\'m having trouble sleeping and need some guidance')" class="bg-white hover:bg-green-muted/5 rounded-2xl p-4 cursor-pointer transition-colors border border-green-muted/20 hover:border-green-medium/40 shadow-sm sm:col-span-2 lg:col-span-1">
                        <div class="text-sm font-medium text-green-dark mb-1">Sleep support</div>
                        <div class="text-sm text-green-muted">better rest and recovery</div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-hidden hidden">
                <div class="h-full overflow-y-auto px-4 md:px-6 py-6" id="scrollContainer">
                    <div class="max-w-4xl mx-auto space-y-6" id="messagesContainer"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="px-4 md:px-6 py-4 md:py-6 bg-white">
                <div class="w-full max-w-3xl mx-auto">
                    <div class="relative bg-white border border-green-muted/20 rounded-2xl shadow-sm">
                        <div class="flex items-center px-4 md:px-6 py-3 md:py-4">
                            <input 
                                id="messageInput"
                                type="text" 
                                placeholder="Share what's on your mind..." 
                                class="flex-1 bg-transparent text-primary-dark placeholder-green-muted/60 outline-none text-base md:text-lg"
                                onkeypress="handleKeyPress(event)"
                            />
                            
                            <!-- Tools Button -->
                            <div class="relative">
                                <button id="toolsButton" onclick="toggleModelDropdown()" class="flex items-center space-x-2 px-2 md:px-4 py-2 hover:bg-green-muted/10 rounded-full transition-colors mr-2 md:mr-3 text-green-muted" title="Tools">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"></path>
                                    </svg>
                                    <span class="text-sm hidden sm:inline">Helpers</span>
                                    <svg class="w-3 h-3 transition-transform" id="dropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                                <!-- Model Dropdown -->
                                <div id="modelDropdown" class="absolute bottom-full right-0 mb-2 w-64 sm:w-72 bg-white border border-green-muted/20 rounded-2xl shadow-lg hidden z-50">
                                    <div class="p-2">
                                        <div class="text-xs font-medium text-green-muted px-3 py-2 mb-1">Powered by Corea Starstroupe</div>
                                        <div onclick="selectModel('wellness', 'Corea Inner Support V1', 'general mental health support')" class="flex items-start p-3 hover:bg-green-muted/5 rounded-xl cursor-pointer transition-colors model-option" data-model="wellness">
                                            <div class="w-2 h-2 bg-green-light rounded-full mt-2 mr-3 flex-shrink-0"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-green-dark text-sm">Corea Inner Support V1</div>
                                                <div class="text-xs text-green-muted mt-0.5 truncate">general mental health support</div>
                                            </div>
                                        </div>
                                        <div onclick="selectModel('anxiety', 'Corea Resilience 2B', 'anxiety & stress management')" class="flex items-start p-3 hover:bg-green-muted/5 rounded-xl cursor-pointer transition-colors model-option" data-model="anxiety">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-green-dark text-sm">Corea Resilience 2B</div>
                                                <div class="text-xs text-green-muted mt-0.5 truncate">anxiety & stress management</div>
                                            </div>
                                        </div>
                                        <div onclick="selectModel('mood', 'Corea Mindcare 7S', 'depression & emotional support')" class="flex items-start p-3 hover:bg-green-muted/5 rounded-xl cursor-pointer transition-colors model-option" data-model="mood">
                                            <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-green-dark text-sm">Corea Mindcare 7S</div>
                                                <div class="text-xs text-green-muted mt-0.5 truncate">depression & emotional support</div>
                                            </div>
                                        </div>
                                        <div onclick="selectModel('sleep', 'Corea Rest Advisor 3C', 'sleep & relaxation guidance')" class="flex items-start p-3 hover:bg-green-muted/5 rounded-xl cursor-pointer transition-colors model-option" data-model="sleep">
                                            <div class="w-2 h-2 bg-indigo-500 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-green-dark text-sm">Corea Rest Advisor 3C</div>
                                                <div class="text-xs text-green-muted mt-0.5 truncate">sleep & relaxation guidance</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="sendCurrentMessage()" class="p-2 hover:bg-green-muted/10 rounded-full transition-colors text-green-muted" title="Send Message">
                                <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <p class="text-xs text-green-muted/70">
                            Sprout can make mistakes. Please verify important information and consider professional help when needed.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Crisis Help Modal -->
        <div id="crisisModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-2xl max-w-md w-full mx-4">
                <h3 class="text-xl font-medium text-green-dark mb-4">Crisis Support</h3>
                <p class="text-green-muted mb-4">If you're in crisis, please seek professional help immediately or contact a trusted person for support.</p>
                <button onclick="closeCrisisModal()" class="w-full bg-green-medium text-white py-3 rounded-xl">Close</button>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedbackModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-2xl max-w-md w-full mx-4">
                <h3 class="text-xl font-medium text-green-dark mb-4">Provide Feedback</h3>
                <textarea id="feedbackInput" class="w-full h-32 p-3 border border-green-muted/20 rounded-xl mb-4" placeholder="Share your feedback or suggestions..."></textarea>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeFeedbackModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl">Cancel</button>
                    <button onclick="submitFeedback()" class="px-4 py-2 bg-green-medium text-white rounded-xl">Submit</button>
                </div>
            </div>
        </div>

        <!-- Mood Tracker Modal -->
        <div id="moodModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-2xl max-w-md w-full mx-4">
                <h3 class="text-xl font-medium text-green-dark mb-4">Log Your Mood</h3>
                <div class="flex justify-center space-x-4 mb-6">
                    <button onclick="logMood('😊')" class="text-2xl p-2 hover:bg-green-muted/10 rounded">😊</button>
                    <button onclick="logMood('😐')" class="text-2xl p-2 hover:bg-green-muted/10 rounded">😐</button>
                    <button onclick="logMood('😔')" class="text-2xl p-2 hover:bg-green-muted/10 rounded">😔</button>
                    <button onclick="logMood('😣')" class="text-2xl p-2 hover:bg-green-muted/10 rounded">😣</button>
                </div>
                <div id="moodHistory" class="text-sm text-green-muted mb-4 max-h-40 overflow-y-auto"></div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeMoodModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_KEY = "z99HUO9u2vu9E4YTRRfeue6hbdkdOcM8zWQDfbcq";
        const MODEL = "command-r";
        const API_URL = "https://api.cohere.ai/v1/chat";
        let chatHistory = [];
        let moodHistory = [];
        let isAIResponding = false;
        let currentTypewriterTimeout = null;
        let abortController = null;
        let currentModel = 'wellness';
        let breathingInterval = null;

        // AI Model Configurations
        const aiModels = {
            wellness: {
                name: 'Corea Inner Support V1',
                role: 'general mental health support',
                color: 'green-light',
                preamble: "You are a compassionate AI mental health support assistant. Provide empathetic, helpful responses while encouraging users to seek professional help when needed. Focus on emotional support, coping strategies, and wellness techniques."
            },
            anxiety: {
                name: 'Corea Resilience 2B',
                role: 'anxiety & stress management',
                color: 'blue-500',
                preamble: "You are an AI specialist in anxiety and stress management. Focus on providing calming techniques, breathing exercises, grounding methods, and cognitive strategies to help users manage anxiety and stress. Always be gentle and reassuring in your approach."
            },
            mood: {
                name: 'Corea Mindcare 7S',
                role: 'depression & emotional support',
                color: 'purple-500',
                preamble: "You are an AI specialist in mood support and depression assistance. Provide compassionate emotional support, help users identify negative thought patterns, suggest mood-lifting activities, and encourage healthy coping mechanisms. Always validate their feelings and provide hope."
            },
            sleep: {
                name: 'Corea Rest Advisor 3C',
                role: 'sleep & relaxation guidance',
                color: 'indigo-500',
                preamble: "You are an AI specialist in sleep and relaxation. Focus on sleep hygiene, relaxation techniques, bedtime routines, and strategies for better rest. Provide calming guidance and practical tips for improving sleep quality and managing insomnia."
            }
        };

        // Model Selection Functions
        function toggleModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            const arrow = document.getElementById('dropdownArrow');
            dropdown.classList.toggle('hidden');
            arrow.style.transform = dropdown.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function selectModel(modelId, modelName, modelRole) {
            currentModel = modelId;
            const currentModelDisplay = document.getElementById('currentModel');
            currentModelDisplay.innerHTML = `
                <div class="w-2 h-2 bg-${aiModels[modelId].color} rounded-full"></div>
                <span class="text-sm text-green-dark font-medium">${modelName}</span>
            `;
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('bg-green-muted/10');
            });
            document.querySelector(`[data-model="${modelId}"]`).classList.add('bg-green-muted/10');
            toggleModelDropdown();
            if (chatHistory.length > 0) {
                addSystemMessage(`Switched to ${modelName} - ${modelRole}`);
            }
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('modelDropdown');
            const toolsButton = document.getElementById('toolsButton');
            if (!dropdown.contains(event.target) && !toolsButton.contains(event.target)) {
                dropdown.classList.add('hidden');
                document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
            }
        });

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendCurrentMessage();
            }
        }

        // Send message from input
        function sendCurrentMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message) {
                input.value = '';
                sendMessage(message);
            }
        }

        // Send message to AI
        async function sendMessage(message) {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');

            addMessage(message, 'user');
            isAIResponding = true;
            updateSendButton();

            const loadingId = addMessage('Thinking...', 'assistant', true);

            try {
                const cohereHistory = chatHistory.map(msg => ({
                    role: msg.role === 'assistant' ? 'CHATBOT' : 'USER',
                    message: msg.content
                }));

                abortController = new AbortController();
                const startTime = performance.now();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        message: message,
                        chat_history: cohereHistory,
                        temperature: 0.7,
                        max_tokens: 800,
                        preamble: aiModels[currentModel].preamble
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.text;

                const endTime = performance.now();
                console.log(`[v0] API response time: ${(endTime - startTime).toFixed(0)}ms`);

                removeMessage(loadingId);
                addMessage(aiResponse, 'assistant');
                chatHistory.push({ role: "user", content: message });
                chatHistory.push({ role: "assistant", content: aiResponse });
                saveChatHistory();
            } catch (error) {
                if (error.name === 'AbortError') {
                    removeMessage(loadingId);
                    addMessage('Response stopped.', 'assistant');
                } else {
                    console.error('Error:', error);
                    removeMessage(loadingId);
                    addMessage('I apologize, but I\'m having trouble connecting right now. Please try again in a moment.', 'assistant');
                }
                isAIResponding = false;
                updateSendButton();
            } finally {
                abortController = null;
            }
        }

        function stopAIResponse() {
            if (isAIResponding) {
                if (abortController) {
                    abortController.abort();
                }
                if (currentTypewriterTimeout) {
                    clearTimeout(currentTypewriterTimeout);
                    currentTypewriterTimeout = null;
                }
                isAIResponding = false;
                updateSendButton();
            }
        }

        function updateSendButton() {
            const button = document.querySelector('button[onclick="sendCurrentMessage()"]') || document.querySelector('button[onclick="stopAIResponse()"]');
            if (isAIResponding) {
                button.onclick = stopAIResponse;
                button.innerHTML = `
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2" stroke-width="2"></rect>
                    </svg>
                `;
                button.title = "Stop response";
            } else {
                button.onclick = sendCurrentMessage;
                button.innerHTML = `
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                `;
                button.title = "Send message";
            }
        }

        // Add system message
        function addSystemMessage(content) {
            const messagesContainer = document.getElementById('messagesContainer');
            const scrollContainer = document.getElementById('scrollContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-center mb-4';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'bg-green-muted/10 text-green-muted px-4 py-2 rounded-full text-sm border border-green-muted/20';
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            setTimeout(() => {
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }, 10);
        }

        // Add message to chat
        function addMessage(content, role, isLoading = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const scrollContainer = document.getElementById('scrollContainer');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start items-start'} mb-4 group`;
            
            if (role === 'assistant') {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'flex-shrink-0 mr-3';
                avatarDiv.innerHTML = `
                    <img src="/src/logo.png" alt="AI Assistant" class="w-8 h-8 rounded-full border border-green-muted/20">
                `;
                messageDiv.appendChild(avatarDiv);
            }
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'relative';
            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-xs sm:max-w-md md:max-w-3xl px-4 py-3 ${
                role === 'user' ? 'bg-green-medium text-white ml-4 sm:ml-12 rounded-2xl' : 'text-primary-dark mr-4 sm:mr-12'
            }`;
            
            if (isLoading) {
                contentDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-green-medium rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-green-medium rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-green-medium rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        <span class="text-green-muted">Thinking...</span>
                    </div>
                `;
            } else if (role === 'assistant') {
                contentDiv.innerHTML = '';
                typeWriter(contentDiv, content, 10);
            } else {
                contentDiv.textContent = content;
            }

            contentWrapper.appendChild(contentDiv);

            // Add copy, regenerate, and reaction buttons for assistant messages
            if (role === 'assistant' && !isLoading) {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'absolute top-2 right-2 flex space-x-1 opacity-0 group-hover:opacity-100';
                
                const copyButton = document.createElement('button');
                copyButton.className = 'p-1 hover:bg-green-muted/10 rounded transition-colors text-green-muted';
                copyButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                `;
                copyButton.onclick = () => copyToClipboard(content);

                const regenerateButton = document.createElement('button');
                regenerateButton.className = 'p-1 hover:bg-green-muted/10 rounded transition-colors text-green-muted';
                regenerateButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9.582M4 20v-5h.582m15.356 2A8.001 8.001 0 014.582 14.582"></path>
                    </svg>
                `;
                regenerateButton.onclick = () => regenerateMessage(messageId);

                const reactionButton = document.createElement('button');
                reactionButton.className = 'p-1 hover:bg-green-muted/10 rounded transition-colors text-green-muted';
                reactionButton.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                `;
                reactionButton.onclick = () => toggleReactionMenu(messageId, buttonWrapper);

                buttonWrapper.appendChild(copyButton);
                buttonWrapper.appendChild(regenerateButton);
                buttonWrapper.appendChild(reactionButton);
                contentWrapper.appendChild(buttonWrapper);
            }
            
            messageDiv.appendChild(contentWrapper);
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }, 10);
            
            return messageId;
        }

        // Reaction menu
        function toggleReactionMenu(messageId, buttonWrapper) {
            let reactionMenu = document.getElementById(`reaction-menu-${messageId}`);
            if (reactionMenu) {
                reactionMenu.remove();
                return;
            }

            reactionMenu = document.createElement('div');
            reactionMenu.id = `reaction-menu-${messageId}`;
            reactionMenu.className = 'absolute right-0 mt-8 bg-white border border-green-muted/20 rounded-xl shadow-lg z-50';
            reactionMenu.innerHTML = `
                <div class="flex space-x-2 p-2">
                    <button onclick="addReaction('${messageId}', '👍')" class="p-1 hover:bg-green-muted/10 rounded">👍</button>
                    <button onclick="addReaction('${messageId}', '❤️')" class="p-1 hover:bg-green-muted/10 rounded">❤️</button>
                    <button onclick="addReaction('${messageId}', '😊')" class="p-1 hover:bg-green-muted/10 rounded">😊</button>
                </div>
            `;
            buttonWrapper.appendChild(reactionMenu);
        }

        function addReaction(messageId, emoji) {
            const messageDiv = document.getElementById(messageId);
            let reactionContainer = messageDiv.querySelector('.reaction-container');
            if (!reactionContainer) {
                reactionContainer = document.createElement('div');
                reactionContainer.className = 'reaction-container text-sm mt-2';
                messageDiv.querySelector('.relative').appendChild(reactionContainer);
            }
            const existingReactions = reactionContainer.textContent.split(' ');
            if (!existingReactions.includes(emoji)) {
                reactionContainer.textContent = existingReactions.filter(r => r).concat(emoji).join(' ');
            }
            document.getElementById(`reaction-menu-${messageId}`)?.remove();
        }

        function typeWriter(element, text, speed = 10) {
            let i = 0;
            element.innerHTML = '';
            const formattedText = formatMarkdown(text);
            const typingStart = performance.now();
            
            function type() {
                if (i < formattedText.length) {
                    element.innerHTML = formattedText.substring(0, i + 1);
                    i++;
                    currentTypewriterTimeout = setTimeout(type, speed);
                    const scrollContainer = document.getElementById('scrollContainer');
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                } else {
                    const typingEnd = performance.now();
                    console.log(`[v0] Typing animation completed in: ${(typingEnd - typingStart).toFixed(0)}ms`);
                    isAIResponding = false;
                    updateSendButton();
                    currentTypewriterTimeout = null;
                }
            }
            
            type();
        }

        function formatMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/^\* (.*$)/gim, '• $1')
                .replace(/^- (.*$)/gim, '• $1')
                .replace(/\. /g, '. ')
                .replace(/: /g, ': ');
        }

        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messageInput').value = '';
            localStorage.removeItem('sproutChatHistory');
        }

        function saveChatHistory() {
            localStorage.setItem('sproutChatHistory', JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            const savedHistory = localStorage.getItem('sproutChatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                if (chatHistory.length > 0) {
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('chatMessages').classList.remove('hidden');
                    chatHistory.forEach(msg => {
                        addMessage(msg.content, msg.role);
                    });
                }
            }
        }

        function saveMoodHistory() {
            localStorage.setItem('sproutMoodHistory', JSON.stringify(moodHistory));
        }

        function loadMoodHistory() {
            const savedHistory = localStorage.getItem('sproutMoodHistory');
            if (savedHistory) {
                moodHistory = JSON.parse(savedHistory);
                updateMoodHistory();
            }
        }

        function logMood(emoji) {
            const timestamp = new Date().toLocaleString();
            moodHistory.push({ emoji, timestamp });
            if (moodHistory.length > 10) moodHistory.shift(); // Keep last 10 entries
            saveMoodHistory();
            updateMoodHistory();
            showToast('Mood logged!');
        }

        function updateMoodHistory() {
            const historyDiv = document.getElementById('moodHistory');
            historyDiv.innerHTML = moodHistory.length > 0 
                ? moodHistory.map(m => `${m.emoji} ${m.timestamp}`).join('<br>')
                : 'No mood entries yet.';
        }

        function showMoodTracker() {
            document.getElementById('moodModal').classList.remove('hidden');
        }

        function closeMoodModal() {
            document.getElementById('moodModal').classList.add('hidden');
        }

        function showBreathingExercise() {
            document.getElementById('breathingModal').classList.remove('hidden');
        }

        function closeBreathingModal() {
            document.getElementById('breathingModal').classList.add('hidden');
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
            }
            const circle = document.getElementById('breathingCircle');
            circle.style.transform = 'scale(1)';
        }

        function startBreathing() {
            const circle = document.getElementById('breathingCircle');
            const instruction = document.getElementById('breathingInstruction');
            let phase = 0;

            if (breathingInterval) clearInterval(breathingInterval);

            breathingInterval = setInterval(() => {
                if (phase === 0) {
                    circle.style.transform = 'scale(1.5)';
                    instruction.textContent = 'Breathe In';
                    phase = 1;
                } else if (phase === 1) {
                    circle.style.transform = 'scale(1)';
                    instruction.textContent = 'Hold';
                    phase = 2;
                } else if (phase === 2) {
                    circle.style.transform = 'scale(1)';
                    instruction.textContent = 'Breathe Out';
                    phase = 3;
                } else {
                    circle.style.transform = 'scale(1)';
                    instruction.textContent = 'Hold';
                    phase = 0;
                }
            }, 4000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function regenerateMessage(messageId) {
            const index = chatHistory.findIndex((_, i) => chatHistory[i+1]?.messageId === messageId);
            if (index >= 0 && chatHistory[index].role === 'user') {
                const userMessage = chatHistory[index].content;
                chatHistory.splice(index + 1, 1);
                removeMessage(messageId);
                sendMessage(userMessage);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 right-4 bg-green-medium text-white px-4 py-2 rounded-xl shadow-lg';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('sproutDarkMode', isDark ? 'true' : 'false');
            const icon = document.getElementById('darkModeIcon');
            icon.innerHTML = isDark ? 
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>` :
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`;
        }

        function loadDarkMode() {
            const isDark = localStorage.getItem('sproutDarkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark');
                document.getElementById('darkModeIcon').innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`;
            }
        }

        function showCrisisHelp() {
            document.getElementById('crisisModal').classList.remove('hidden');
        }

        function closeCrisisModal() {
            document.getElementById('crisisModal').classList.add('hidden');
        }

        function showFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('hidden');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
            document.getElementById('feedbackInput').value = '';
        }

        function submitFeedback() {
            const feedback = document.getElementById('feedbackInput').value.trim();
            if (feedback) {
                console.log('Feedback submitted:', feedback);
                showToast('Thank you for your feedback!');
                closeFeedbackModal();
            }
        }

        function exportChatHistory() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chatHistory));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute('href', dataStr);
            downloadAnchor.setAttribute('download', 'sprout_chat_history.json');
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
            showToast('Chat history exported!');
        }

        function importChatHistory(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedHistory = JSON.parse(e.target.result);
                        if (Array.isArray(importedHistory)) {
                            chatHistory = importedHistory.filter(msg => msg.role && msg.content);
                            clearChat();
                            loadChatHistory();
                            showToast('Chat history imported!');
                        } else {
                            showToast('Invalid chat history format');
                        }
                    } catch (error) {
                        showToast('Error importing chat history');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            selectModel('wellness', 'Corea Inner Support V1', 'general mental health support');
            loadChatHistory();
            loadDarkMode();
            loadMoodHistory();
            document.getElementById('darkModeToggle').onclick = toggleDarkMode;
            
            // Add import/export to tools dropdown
            const modelDropdown = document.getElementById('modelDropdown');
            const toolsDiv = document.createElement('div');
            toolsDiv.className = 'p-2 border-t border-green-muted/20 mt-2';
            toolsDiv.innerHTML = `
                <div class="flex items-center space-x-2 px-3 py-2 hover:bg-green-muted/5 rounded-xl cursor-pointer" onclick="document.getElementById('importInput').click()">
                    <svg class="w-4 h-4 text-green-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                    </svg>
                    <span class="text-sm text-green-muted">Import Chat</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-2 hover:bg-green-muted/5 rounded-xl cursor-pointer" onclick="exportChatHistory()">
                    <svg class="w-4 h-4 text-green-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16V4m0 0l-4 4m4-4l4 4m-10 0v12m0 0l-4-4m4 4l4-4"></path>
                    </svg>
                    <span class="text-sm text-green-muted">Export Chat</span>
                </div>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importChatHistory(event)">
            `;
            modelDropdown.appendChild(toolsDiv);
        });
    </script>

    <style>
        /* Dark Mode Styles */
        body.dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        body.dark header {
            background-color: #1a1a1a;
            border-color: #4a7c59/20;
        }
        body.dark main {
            background-color: #1a1a1a;
        }
        body.dark .bg-white {
            background-color: #1a1a1a !important;
        }
        body.dark .text-primary-dark {
            color: #ffffff;
        }
        body.dark .text-green-dark {
            color: #ffffff;
        }
        body.dark .text-green-medium {
            color: #ffffff;
        }
        body.dark .text-green-muted {
            color: #ffffff;
        }
        body.dark .border-green-muted\/20 {
            border-color: #4a7c59/20;
        }
        body.dark .bg-green-muted\/10 {
            background-color: #4a7c59/10;
        }
        body.dark .bg-green-light\/10 {
            background-color: #5fb14c/10;
        }
        body.dark .border-green-light\/20 {
            border-color: #5fb14c/20;
        }
        body.dark .hover\:bg-green-muted\/5:hover {
            background-color: #4a7c59/5;
        }
        body.dark .hover\:border-green-medium\/40:hover {
            border-color: #006936/40;
        }
        body.dark .placeholder-green-muted\/60::placeholder {
            color: #ffffff/60;
        }
        body.dark #crisisModal .bg-white,
        body.dark #feedbackModal .bg-white,
        body.dark #moodModal .bg-white,
        body.dark #breathingModal .bg-white {
            background-color: #2a2a2a;
        }
        body.dark #feedbackModal textarea {
            background-color: #3a3a3a;
            color: #ffffff;
            border-color: #4a7c59/20;
        }
    </style>
</body>
</html>
