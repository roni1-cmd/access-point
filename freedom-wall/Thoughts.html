<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commons</title>
  <link rel="icon" href="/src/godc.png">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Cloudinary Upload Widget Script -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #006936;
      --primary-light: #f1ec33;
      --primary-dark: #006936;
      --secondary-color: #FFFFFF;
      --background-color: #F7F9FA;
      --text-color: #14171A;
      --text-secondary: #657786;
      --border-color: #E1E8ED;
      --accent-color: #4E9F3D;
      --error-color: #E0245E;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 9999px;
      --transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      --header-height: 60px;
      --sidebar-width: 275px;
      --right-sidebar-width: 350px;
      --online-color: #4CAF50;
      --message-sidebar-width: 320px;
    }
    
    /* Dark mode variables */
    .dark-mode {
      --primary-color: #006936;
      --primary-light: #f1ec33;
      --primary-dark: #004d30;
      --secondary-color: #1E1E1E;
      --background-color: #121212;
      --text-color: #F5F5F5;
      --text-secondary: #AAAAAA;
      --border-color: #333333;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.25);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Google Sans', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* Layout */
    .app-container {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr var(--right-sidebar-width);
      grid-template-rows: var(--header-height) 1fr;
      grid-template-areas: 
        "sidebar main right-sidebar"
        "sidebar main right-sidebar";
      min-height: 100vh;
      transition: grid-template-columns 0.3s ease;
    }
    
    .app-container.hide-right-sidebar {
      grid-template-columns: var(--sidebar-width) 1fr 0;
    }
    
    .app-container.show-message-sidebar {
      grid-template-columns: var(--sidebar-width) 1fr var(--message-sidebar-width);
    }
    
    /* Sidebar */
    .sidebar {
      grid-area: sidebar;
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background-color: var(--secondary-color);
      padding: 1rem 0;
      z-index: 90;
      transition: var(--transition);
      overflow-y: auto;
      scrollbar-width: thin;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      padding: 0.5rem 1.5rem;
      margin-bottom: 1rem;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .logo-text {
      font-family: 'Google Sans', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-left: 0.8rem;
      color: var(--primary-color);
    }
    
    .nav-links {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 0.9rem 1.5rem;
      color: var(--text-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      transition: var(--transition);
      border-radius: var(--radius-full);
      margin: 0.2rem 0.8rem;
    }
    
    .nav-link:hover {
      background-color: rgba(230, 81, 0, 0.1);
      color: var(--primary-color);
    }
    
    .nav-link.active {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .nav-link i {
      font-size: 1.3rem;
      margin-right: 1.2rem;
      width: 24px;
      text-align: center;
    }
    
    .tweet-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 0.9rem;
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      margin: 0.8rem 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .tweet-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .tweet-btn i {
      margin-right: 0.5rem;
    }
    
    .user-profile {
      margin-top: auto;
      padding: 0.8rem 1.5rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-radius: var(--radius-full);
      margin: 0.5rem 0.8rem;
      transition: var(--transition);
    }
    
    .user-profile:hover {
      background-color: rgba(230, 81, 0, 0.1);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .user-info {
      margin-left: 0.8rem;
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-color);
    }
    
    .user-handle {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .user-profile i {
      color: var(--text-secondary);
    }
    
    /* Main Content */
    .main-content {
      grid-area: main;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      min-height: 100vh;
      background-color: var(--secondary-color);
    }
    
    .main-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      background-color: var(--secondary-color);
      backdrop-filter: blur(5px);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .main-header h1 {
      font-family: 'Google Sans', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .toggle-sidebar-btn {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.2rem;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .toggle-sidebar-btn:hover {
      background-color: rgba(230, 81, 0, 0.1);
      color: var(--primary-color);
    }
    
    .toggle-dark-mode {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.2rem;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .toggle-dark-mode:hover {
      background-color: rgba(230, 81, 0, 0.1);
      color: var(--primary-color);
    }
    
    /* Compose Tweet */
    .compose-tweet {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
    }
    
    .compose-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      margin-right: 1rem;
      object-fit: cover;
    }
    
    .compose-form {
      flex: 1;
    }
    
    .compose-input {
      width: 100%;
      border: none;
      resize: none;
      font-family: 'Google Sans', sans-serif;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      outline: none;
      min-height: 80px;
      background-color: transparent;
      color: var(--text-color);
    }
    
    .compose-input::placeholder {
      color: var(--text-secondary);
    }
    
    .compose-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .compose-tools {
      display: flex;
      gap: 1rem;
    }
    
    .compose-tool {
      color: var(--primary-color);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .compose-tool:hover {
      background-color: rgba(230, 81, 0, 0.1);
    }
    
    .compose-submit {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 0.6rem 1.2rem;
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .compose-submit:hover {
      background-color: var(--primary-dark);
    }
    
    /* Anonymous posting toggle */
    .anonymous-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      cursor: pointer;
    }
    
    .anonymous-toggle input {
      margin-right: 0.5rem;
    }
    
    .anonymous-toggle-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    /* Tweets */
    .tweets-container {
      display: flex;
      flex-direction: column;
    }
    
    .tweet {
      padding: 1.2rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      transition: var(--transition);
      cursor: pointer;
    }
    
    .tweet:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .dark-mode .tweet:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .tweet-header {
      display: flex;
      margin-bottom: 0.5rem;
    }
    
    .tweet-avatar-container {
      position: relative;
      margin-right: 1rem;
    }
    
    .tweet-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .online-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 2px solid var(--secondary-color);
    }
    
    .tweet-user-info {
      flex: 1;
    }
    
    .tweet-user-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-color);
      display: inline;
    }
    
    .tweet-user-handle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-left: 0.3rem;
      display: inline;
    }
    
    .tweet-time {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-left: 0.3rem;
    }
    
    .last-active {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }
    
    .tweet-more {
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      width: 30px;
      height: 30px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .tweet-more:hover {
      background-color: rgba(230, 81, 0, 0.1);
      color: var(--primary-color);
    }
    
    .tweet-content {
      margin-left: 60px;
      margin-bottom: 0.8rem;
    }
    
    .tweet-text {
      font-family: 'Google Sans', sans-serif;
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 0.5rem;
      word-break: break-word;
    }
    
    .tweet-title {
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
      color: var(--text-color);
    }
    
    .tweet-category {
      display: inline-block;
      font-size: 0.85rem;
      color: var(--primary-color);
      background-color: rgba(230, 81, 0, 0.1);
      padding: 0.2rem 0.8rem;
      border-radius: var(--radius-full);
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .tweet-tag {
      display: inline-block;
      font-size: 0.85rem;
      color: var(--accent-color);
      background-color: rgba(78, 159, 61, 0.1);
      padding: 0.2rem 0.8rem;
      border-radius: var(--radius-full);
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .tweet-actions {
      display: flex;
      justify-content: space-between;
      max-width: 400px;
      margin-left: 60px;
    }
    
    .tweet-action {
      display: flex;
      align-items: center;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }
    
    .tweet-action i {
      font-size: 1.1rem;
      margin-right: 0.3rem;
      width: 18px;
      text-align: center;
    }
    
    .tweet-action:hover {
      color: var(--primary-color);
    }
    
    .tweet-action.liked {
      color: var(--primary-color);
    }
    
    .tweet-action.disliked {
      color: var(--error-color);
    }
    
    /* Anonymous post styling */
    .anonymous-post .tweet-avatar {
      background-color: #333;
    }
    
    .anonymous-post .tweet-user-name {
      font-style: italic;
    }
    
    .anonymous-post .tweet-user-handle {
      font-style: italic;
    }
    
    .anonymous-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      background-color: #333;
      color: white;
      font-size: 1.5rem;
    }
    
    /* Comments */
    .comments-section {
      margin-left: 60px;
      margin-top: 0.8rem;
      display: none;
    }
    
    .comments-section.show {
      display: block;
    }
    
    .comment {
      display: flex;
      padding: 0.8rem 0;
      border-top: 1px solid var(--border-color);
    }
    
    .comment-avatar-container {
      position: relative;
      margin-right: 0.8rem;
    }
    
    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .comment-online-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 2px solid var(--secondary-color);
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-user-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-color);
      display: inline;
    }
    
    .comment-text {
      font-size: 0.95rem;
      margin-top: 0.2rem;
      word-break: break-word;
    }
    
    .comment-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.3rem;
    }
    
    .comment-action {
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
    }
    
    .comment-action i {
      font-size: 0.9rem;
      margin-right: 0.3rem;
    }
    
    .comment-action:hover {
      color: var(--primary-color);
    }
    
    .comment-form {
      display: flex;
      margin-top: 0.8rem;
      border-top: 1px solid var(--border-color);
      padding-top: 0.8rem;
    }
    
    .comment-input {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-full);
      padding: 0.6rem 1rem;
      font-family: 'Google Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    
    .comment-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);
    }
    
    .comment-submit {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .comment-submit:hover {
      background-color: var(--primary-dark);
    }
    
    /* Right Sidebar */
    .right-sidebar {
      grid-area: right-sidebar;
      padding: 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      scrollbar-width: thin;
      background-color: var(--secondary-color);
      transition: transform 0.3s ease, width 0.3s ease;
    }
    
    .app-container.hide-right-sidebar .right-sidebar {
      transform: translateX(100%);
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    
    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }
    
    .search-input {
      width: 100%;
      padding: 0.8rem 3rem 0.8rem 1rem;
      border: none;
      border-radius: var(--radius-full);
      background-color: #EFF3F4;
      font-family: 'Google Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      color: var(--text-color);
    }
    
    .dark-mode .search-input {
      background-color: #2A2A2A;
    }
    
    .search-input:focus {
      background-color: var(--secondary-color);
      box-shadow: 0 0 0 1px var(--primary-color), 0 0 0 4px rgba(230, 81, 0, 0.1);
    }
    
    .search-icon {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    /* Active Followers Section */
    .active-followers-section {
      background-color: var(--background-color);
      border-radius: var(--radius-md);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .active-followers-header {
      padding: 0.8rem 1rem;
      font-family: 'Google Sans', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .active-followers-header-toggle {
      color: var(--primary-color);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      width: 30px;
      height: 30px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .active-followers-header-toggle:hover {
      background-color: rgba(230, 81, 0, 0.1);
    }
    
    .active-followers-item {
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .active-followers-item:last-child {
      border-bottom: none;
    }
    
    .active-followers-item:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    .dark-mode .active-followers-item:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .active-followers-avatar-container {
      position: relative;
      margin-right: 0.8rem;
    }
    
    .active-followers-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .active-followers-online-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 2px solid var(--background-color);
    }
    
    .active-followers-info {
      flex: 1;
    }
    
    .active-followers-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }
    
    .active-followers-handle {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .active-followers-last-active {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }
    
    .follow-btn {
      background-color: var(--text-color);
      color: var(--secondary-color);
      border: none;
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .follow-btn:hover {
      opacity: 0.9;
    }
    
    /* Message Sidebar */
    .message-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: var(--message-sidebar-width);
      height: 100vh;
      background-color: var(--secondary-color);
      border-left: 1px solid var(--border-color);
      z-index: 95;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .message-sidebar.show {
      transform: translateX(0);
    }
    
    .message-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message-header-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .message-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .message-close:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--primary-color);
    }
    
    .message-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .message-tab {
      flex: 1;
      text-align: center;
      padding: 0.8rem 0;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .message-tab.active {
      color: var(--primary-color);
    }
    
    .message-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background-color: var(--primary-color);
    }
    
    .message-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .message-item {
      display: flex;
      padding: 0.8rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .message-item:hover {
      background-color: var(--background-color);
    }
    
    .message-item.active {
      background-color: rgba(230, 81, 0, 0.1);
    }
    
    .message-avatar-container {
      position: relative;
      margin-right: 0.8rem;
    }
    
    .message-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .message-online-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 2px solid var(--secondary-color);
    }
    
    .message-info {
      flex: 1;
    }
    
    .message-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }
    
    .message-preview {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-left: auto;
      white-space: nowrap;
    }
    
    .message-unread-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: var(--radius-full);
      background-color: var(--primary-color);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: auto;
    }
    
    .message-chat {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .message-chat.show {
      display: flex;
    }
    
    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }
    
    .chat-back {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.5rem;
      transition: var(--transition);
    }
    
    .chat-back:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--primary-color);
    }
    
    .chat-user-info {
      flex: 1;
    }
    
    .chat-user-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .chat-user-status {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .chat-message {
      max-width: 80%;
      padding: 0.8rem;
      border-radius: var(--radius-md);
      position: relative;
    }
    
    .chat-message.sent {
      align-self: flex-end;
      background-color: var(--primary-color);
      color: white;
      border-bottom-right-radius: 0;
    }
    
    .chat-message.received {
      align-self: flex-start;
      background-color: var(--background-color);
      border-bottom-left-radius: 0;
    }
    
    .chat-message-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 0.3rem;
      text-align: right;
    }
    
    .chat-message.sent .chat-message-time {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chat-input {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-full);
      padding: 0.8rem 1rem;
      font-family: 'Google Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    
    .chat-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);
    }
    
    .chat-send {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-send:hover {
      background-color: var(--primary-dark);
    }
    
    /* Profile Dropdown */
    .profile-dropdown {
      position: absolute;
      bottom: 70px;
      left: 20px;
      width: 240px;
      background-color: var(--secondary-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      overflow: hidden;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }
    
    .profile-dropdown.show {
      display: block;
    }
    
    .dropdown-item {
      padding: 1rem;
      display: flex;
      align-items: center;
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
    }
    
    .dropdown-item:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    .dark-mode .dropdown-item:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .dropdown-item i {
      margin-right: 0.8rem;
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }
    
    .dropdown-item.logout {
      color: var(--error-color);
    }
    
    /* Mobile Navigation */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--secondary-color);
      display: none;
      justify-content: space-around;
      padding: 0.8rem 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 90;
      border-top: 1px solid var(--border-color);
    }
    
    .mobile-nav-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.7rem;
      transition: var(--transition);
      padding: 0.5rem 0;
    }
    
    .mobile-nav-link i {
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      transition: var(--transition);
    }
    
    .mobile-nav-link.active {
      color: var(--primary-color);
    }
    
    .mobile-nav-link.active i {
      color: var(--primary-color);
    }
    
    .mobile-nav-link:hover {
      color: var(--primary-color);
    }
    
    .mobile-nav-link:hover i {
      color: var(--primary-color);
    }
    
    /* Mobile Menu Button */
    .mobile-menu-btn {
      position: relative;
    }
    
    .mobile-menu-dropdown {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      background-color: var(--secondary-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      overflow: hidden;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }
    
    .mobile-menu-dropdown.show {
      display: block;
    }
    
    /* Floating Tweet Button */
    .float-tweet-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: var(--radius-full);
      background-color: var(--primary-color);
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      z-index: 89;
      transition: var(--transition);
      font-size: 1.5rem;
    }
    
    .float-tweet-btn:hover {
      background-color: var(--primary-dark);
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background-color: var(--primary-color);
      color: var(--secondary-color);
      padding: 1rem 1.5rem;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-md);
      animation: toastIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), toastOut 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) 4.7s forwards;
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    
    .toast::before {
      content: '\f058';
      font-family: 'Google Sans', sans-serif;
      font-weight: 900;
      margin-right: 0.8rem;
      font-size: 1.2rem;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      backdrop-filter: blur(3px);
    }
    
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--secondary-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 500px;
      z-index: 1001;
      display: none;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .modal-close:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--primary-color);
    }
    
    .dark-mode .modal-close:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
    }
    
    .modal-btn {
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius-full);
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .modal-btn-secondary {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }
    
    .modal-btn-secondary:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .dark-mode .modal-btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .modal-btn-primary {
      background-color: var(--primary-color);
      border: none;
      color: white;
    }
    
    .modal-btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    /* Notifications Panel */
    .notifications-panel {
      display: none;
    }
    
    .notification-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: flex-start;
      transition: var(--transition);
    }
    
    .notification-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .dark-mode .notification-item:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .notification-item.unread {
      background-color: rgba(230, 81, 0, 0.05);
    }
    
    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background-color: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 1.2rem;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-text {
      font-size: 0.95rem;
      margin-bottom: 0.3rem;
    }
    
    .notification-time {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .notification-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .notification-action {
      font-size: 0.85rem;
      color: var(--primary-color);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius-full);
      transition: var(--transition);
    }
    
    .notification-action:hover {
      background-color: rgba(230, 81, 0, 0.1);
    }
    
    /* User Profile Page */
    .profile-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .profile-cover {
      height: 150px;
      background-color: var(--primary-light);
      border-radius: var(--radius-md);
      margin-bottom: -50px;
      position: relative;
    }
    
    .profile-avatar-container {
      position: relative;
      margin-left: 1rem;
    }
    
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: var(--radius-full);
      border: 4px solid var(--secondary-color);
      background-color: var(--secondary-color);
      object-fit: cover;
    }
    
    .profile-online-indicator {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 3px solid var(--secondary-color);
    }
    
    .profile-info {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
    }
    
    .profile-name {
      font-weight: 700;
      font-size: 1.3rem;
      margin-bottom: 0.2rem;
    }
    
    .profile-handle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 0.8rem;
    }
    
    .profile-bio {
      font-size: 0.95rem;
      margin-bottom: 0.8rem;
      line-height: 1.5;
    }
    
    .profile-last-active {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.8rem;
    }
    
    .profile-stats {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .profile-stat {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .profile-stat-value {
      font-weight: 600;
      color: var(--text-color);
      margin-right: 0.3rem;
    }
    
    .profile-actions {
      display: flex;
      gap: 0.8rem;
      margin-top: 1rem;
    }
    
    .profile-action-btn {
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius-full);
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .profile-action-primary {
      background-color: var(--primary-color);
      color: white;
      border: none;
    }
    
    .profile-action-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .profile-action-secondary {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      display: flex;
      align-items: center;
    }
    
    .profile-action-secondary i {
      margin-right: 0.5rem;
    }
    
    .profile-action-secondary:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .dark-mode .profile-action-secondary:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .profile-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .profile-tab {
      flex: 1;
      text-align: center;
      padding: 1rem 0;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .profile-tab.active {
      color: var(--primary-color);
    }
    
    .profile-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background-color: var(--primary-color);
      border-radius: var(--radius-full);
    }
    
    .profile-tab:hover {
      background-color: rgba(0, 0, 0, 0.02);
      color: var(--primary-color);
    }
    
    .dark-mode .profile-tab:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    /* Settings Page */
    .settings-container {
      padding: 1.5rem;
    }
    
    .settings-section {
      margin-bottom: 2rem;
    }
    
    .settings-section-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .settings-item-title {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .settings-item-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.8rem;
    }
    
    .settings-input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-family: 'Google Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    
    .settings-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);
    }
    
    .settings-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    
    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .settings-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: var(--transition);
      border-radius: 34px;
    }
    
    .settings-toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }
    
    .settings-toggle input:checked + .settings-toggle-slider {
      background-color: var(--primary-color);
    }
    
    .settings-toggle input:checked + .settings-toggle-slider:before {
      transform: translateX(24px);
    }
    
    .settings-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 0.8rem 1.5rem;
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 1rem;
    }
    
    .settings-btn:hover {
      background-color: var(--primary-dark);
    }
    
    /* Report Modal */
    .report-options {
      margin-bottom: 1rem;
    }
    
    .report-option {
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .report-option:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .dark-mode .report-option:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .report-option.selected {
      border-color: var(--primary-color);
      background-color: rgba(230, 81, 0, 0.05);
    }
    
    .report-option-radio {
      margin-right: 0.5rem;
    }
    
    .report-details {
      margin-top: 1rem;
    }
    
    .report-textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-family: 'Google Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
      resize: vertical;
      min-height: 100px;
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    
    .report-textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);
    }
    
    /* Followers/Following Modal */
    .user-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .user-list-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .user-list-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .dark-mode .user-list-item:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .user-list-avatar-container {
      position: relative;
      margin-right: 1rem;
    }
    
    .user-list-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
    }
    
    .user-list-online-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online-color);
      border: 2px solid var(--secondary-color);
    }
    
    .user-list-info {
      flex: 1;
    }
    
    .user-list-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }
    
    .user-list-handle {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .user-list-last-active {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }
    
    /* Image Upload Styles */
    .image-upload-container {
      margin-top: 1rem;
      margin-bottom: 1rem;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
    }
    
    .image-upload-container:hover {
      border-color: var(--primary-color);
      background-color: rgba(230, 81, 0, 0.05);
    }
    
    .image-upload-icon {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .image-upload-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .image-upload-subtext {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .image-preview-container {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .image-preview-item {
      position: relative;
      display: inline-block;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 150px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    
    .image-remove-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      border-radius: var(--radius-full);
      background-color: var(--error-color);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    
    .image-remove-btn:hover {
      background-color: #f1ec33;
      transform: scale(1.1);
    }
    
    .tweet-images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .tweet-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .tweet-image:hover {
      opacity: 0.9;
    }
    
    /* Image Lightbox */
    .lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .lightbox-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    
    .lightbox-image {
      max-width: 100%;
      max-height: 90vh;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
    }
    
    .lightbox-close {
      position: absolute;
      top: -20px;
      right: -20px;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      font-size: 1.2rem;
      transition: var(--transition);
    }
    
    .lightbox-close:hover {
      background-color: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }
    
    /* Login Modal */
    .login-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      backdrop-filter: blur(5px);
      display: none;
    }
    
    .login-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--secondary-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 400px;
      z-index: 2001;
      display: none;
      overflow: hidden;
    }
    
    .login-modal-header {
      text-align: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .login-modal-logo {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-full);
      margin: 0 auto 1rem;
      display: block;
    }
    
    .login-modal-title {
      font-family: 'Google Sans', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .login-modal-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .login-modal-body {
      padding: 1.5rem;
    }
    
    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0.8rem;
      border-radius: var(--radius-full);
      background-color: #5fb14c;
      color: white;
      font-family: 'Google Sans', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      margin-bottom: 1rem;
    }
    
    .login-btn:hover {
      opacity: 0.9;
    }
    
    .login-btn i {
      margin-right: 0.8rem;
      font-size: 1.2rem;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(20px); }
    }
    
    /* Responsive Styles */
    @media (max-width: 1200px) {
      .app-container {
        grid-template-columns: var(--sidebar-width) 1fr var(--right-sidebar-width);
      }
      
      .app-container.hide-right-sidebar {
        grid-template-columns: var(--sidebar-width) 1fr 0;
      }
      
      .app-container.show-message-sidebar {
        grid-template-columns: var(--sidebar-width) 1fr var(--message-sidebar-width);
      }
    }
    
    @media (max-width: 992px) {
      .app-container {
        grid-template-columns: 0 1fr 0; /* Hide right sidebar on mobile */
      }
      
      .app-container.hide-right-sidebar {
        grid-template-columns: 0 1fr 0;
      }
      
      .app-container.show-message-sidebar {
        grid-template-columns: 0 1fr var(--message-sidebar-width);
      }
      
      .sidebar {
        transform: translateX(-100%);
        z-index: 100;
        box-shadow: var(--shadow-lg);
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .mobile-nav {
        display: flex;
      }
      
      .float-tweet-btn {
        display: flex;
      }
      
      .main-content {
        margin-bottom: 60px;
      }
      
      /* Hide right sidebar on mobile */
      .right-sidebar {
        display: none;
      }
    }
    
    @media (max-width: 576px) {
      .compose-tweet {
        padding: 1rem;
      }
      
      .tweet {
        padding: 1rem;
      }
      
      .main-header {
        padding: 0.8rem 1rem;
      }
      
      .main-header h1 {
        font-size: 1.2rem;
      }
      
      .compose-avatar {
        width: 40px;
        height: 40px;
      }
      
      .tweet-avatar {
        width: 40px;
        height: 40px;
      }
      
      .tweet-content {
        margin-left: 52px;
      }
      
      .tweet-actions {
        margin-left: 52px;
      }
      
      .comments-section {
        margin-left: 52px;
      }
      
      .message-sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container" id="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo-container">
        <img src="/src/godc.png" alt="Logo" class="logo">
        <span class="logo-text">COMMONS</span>
      </div>
      
      <div class="nav-links">
        <a href="#" class="nav-link active" id="home-link">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="#" class="nav-link" id="notifications-link">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </a>
        <a href="#" class="nav-link" id="messages-link">
          <i class="fas fa-envelope"></i>   
          <span>Messages</span>
        </a>
        <a href="#" class="nav-link" id="profile-link">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
        <a href="#" class="nav-link" id="settings-link">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </div>
      
      <button class="tweet-btn" id="compose-btn">
        <i class="fas fa-feather-alt"></i> Scrib
      </button>
      
      <div class="user-profile" id="user-profile-btn">
        <img src="/placeholder.svg?height=40&width=40" alt="Profile Picture" class="user-avatar" id="sidebar-avatar">
        <div class="user-info">
          <div class="user-name" id="sidebar-name">User Name</div>
          <div class="user-handle" id="sidebar-handle">@username</div>
        </div>
        <i class="fas fa-ellipsis-h"></i>
      </div>
      
      <div class="profile-dropdown" id="profile-dropdown">
        <a href="#" class="dropdown-item" id="dropdown-profile">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
        <a href="#" class="dropdown-item logout" id="dropdown-logout">
          <i class="fas fa-sign-out-alt"></i>
          <span>Log out</span>
        </a>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="main-header">
        <h1 id="page-title">Home</h1>
        <div class="header-actions">
          <button class="toggle-dark-mode" id="toggle-dark-mode">
            <i class="fas fa-moon"></i>
          </button>
          <button class="toggle-sidebar-btn" id="toggle-sidebar-btn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <!-- Home Page -->
      <div id="home-page">
        <!-- Compose Tweet -->
        <div class="compose-tweet" id="compose-tweet">
          <img src="/placeholder.svg?height=48&width=48" alt="Profile Picture" class="compose-avatar" id="compose-avatar">
          <div class="compose-form">
            <select id="category-select" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-full); border: 1px solid var(--border-color); margin-bottom: 0.5rem; font-family: 'Source Sans Pro', sans-serif; background-color: var(--secondary-color); color: var(--text-color);">
              <option value="">Select a category</option>
              <option value="general">General</option>
              <option value="technology">Technology</option>
              <option value="sports">Sports</option>
              <option value="entertainment">Entertainment</option>
            </select>
            <input type="text" id="tweet-title" placeholder="Title" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-full); border: 1px solid var(--border-color); margin-bottom: 0.5rem; font-family: 'Merriweather', serif; background-color: var(--secondary-color); color: var(--text-color);">
            <textarea class="compose-input" id="tweet-content" placeholder="What's happening?"></textarea>
            <input type="text" id="tweet-tags" placeholder="Add tags (comma-separated)" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-full); border: 1px solid var(--border-color); margin-bottom: 0.5rem; font-family: 'Source Sans Pro', sans-serif; background-color: var(--secondary-color); color: var(--text-color);">
            
            <!-- Anonymous posting toggle -->
            <div class="anonymous-toggle">
              <input type="checkbox" id="anonymous-post-toggle">
              <label for="anonymous-post-toggle" class="anonymous-toggle-label">Post anonymously</label>
            </div>
            
            <!-- Image Preview Container -->
            <div class="image-preview-container" id="image-preview-container" style="display: none;">
              <!-- Image previews will be added here dynamically -->
            </div>
            
            <div class="compose-actions">
              <div class="compose-tools">
                <button class="compose-tool" id="upload-image-btn">
                  <i class="far fa-image"></i>
                </button>
                <button class="compose-tool">
                  <i class="fas fa-poll"></i>
                </button>
                <button class="compose-tool">
                  <i class="far fa-smile"></i>
                </button>
              </div>
              <button class="compose-submit" id="tweet-submit">Scrib</button>
            </div>
          </div>
        </div>
        
        <!-- Tweets Container -->
        <div class="tweets-container" id="tweets-container">
          <!-- Tweets will be dynamically inserted here -->
        </div>
      </div>
      
      <!-- Notifications Page -->
      <div id="notifications-page" class="notifications-panel">
        <!-- Notifications will be dynamically inserted here -->
      </div>
      
      <!-- Messages Page -->
      <div id="messages-page" class="notifications-panel">
        <div class="message-list" id="message-list">
          <!-- Messages will be dynamically inserted here -->
        </div>
      </div>
      
      <!-- Profile Page -->
      <div id="profile-page" style="display: none;">
        <div class="profile-header">
          <div class="profile-cover"></div>
          <div class="profile-avatar-container">
            <img src="/placeholder.svg?height=100&width=100" alt="Profile Picture" class="profile-avatar" id="profile-avatar">
            <div class="profile-online-indicator" id="profile-online-indicator"></div>
          </div>
          <div class="profile-info">
            <h2 class="profile-name" id="profile-name">User Name</h2>
            <p class="profile-handle" id="profile-handle">@username</p>
            <p class="profile-last-active" id="profile-last-active">Last active: Just now</p>
            <p class="profile-bio" id="profile-bio">No bio yet.</p>
            <div class="profile-stats">
              <div class="profile-stat" id="profile-posts">
                <span class="profile-stat-value">0</span> Scribs
              </div>
              <div class="profile-stat followers-stat" id="profile-followers">
                <span class="profile-stat-value">0</span> Followers
              </div>
              <div class="profile-stat following-stat" id="profile-following">
                <span class="profile-stat-value">0</span> Following
              </div>
            </div>
            <div class="profile-actions" id="profile-actions">
              <button class="profile-action-btn profile-action-primary" id="follow-btn">Follow</button>
              <button class="profile-action-btn profile-action-secondary" id="message-btn">
                <i class="fas fa-envelope"></i> Message
              </button>
              <button class="profile-action-btn profile-action-secondary" id="report-user-btn">
                <i class="fas fa-flag"></i> Report
              </button>
            </div>
          </div>
        </div>
        <div class="profile-tabs">
          <div class="profile-tab active" data-tab="posts">Posts</div>
          <div class="profile-tab" data-tab="likes">Likes</div>
          <div class="profile-tab" data-tab="media">Media</div>
        </div>
        <div class="profile-content">
          <div class="tweets-container" id="profile-tweets-container">
            <!-- Profile tweets will be dynamically inserted here -->
          </div>
        </div>
      </div>
      
      <!-- Settings Page -->
      <div id="settings-page" style="display: none;">
        <div class="settings-container">
          <div class="settings-section">
            <h2 class="settings-section-title">Account Settings</h2>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Username</h3>
              </div>
              <p class="settings-item-description">Change your username</p>
              <input type="text" class="settings-input" id="settings-username" placeholder="Enter new username">
            </div>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Bio</h3>
              </div>
              <p class="settings-item-description">Tell others about yourself</p>
              <textarea class="settings-input" id="settings-bio" placeholder="Enter your bio" style="min-height: 100px; resize: vertical;"></textarea>
            </div>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Profile Picture</h3>
              </div>
              <p class="settings-item-description">Upload a new profile picture</p>
              <div class="image-upload-container" id="profile-image-upload">
                <div class="image-upload-icon">
                  <i class="fas fa-user-circle"></i>
                </div>
                <div class="image-upload-text">Click to upload a profile picture</div>
                <div class="image-upload-subtext">JPG, PNG up to 5MB</div>
              </div>
            </div>
          </div>
          
          <div class="settings-section">
            <h2 class="settings-section-title">Notification Settings</h2>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Email Notifications</h3>
                <label class="settings-toggle">
                  <input type="checkbox" id="email-notifications">
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <p class="settings-item-description">Receive email notifications for new followers and likes</p>
            </div>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Push Notifications</h3>
                <label class="settings-toggle">
                  <input type="checkbox" id="push-notifications" checked>
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <p class="settings-item-description">Receive push notifications for new followers and likes</p>
            </div>
          </div>
          
          <div class="settings-section">
            <h2 class="settings-section-title">Privacy Settings</h2>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Private Account</h3>
                <label class="settings-toggle">
                  <input type="checkbox" id="private-account">
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <p class="settings-item-description">Only approved followers can see your posts</p>
            </div>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Show Activity Status</h3>
                <label class="settings-toggle">
                  <input type="checkbox" id="activity-status" checked>
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <p class="settings-item-description">Let others see when you're active</p>
            </div>
          </div>
          
          <div class="settings-section">
            <h2 class="settings-section-title">Appearance</h2>
            <div class="settings-item">
              <div class="settings-item-header">
                <h3 class="settings-item-title">Dark Mode</h3>
                <label class="settings-toggle">
                  <input type="checkbox" id="dark-mode-toggle">
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <p class="settings-item-description">Switch between light and dark mode</p>
            </div>
          </div>
          
          <button class="settings-btn" id="save-settings">Save Changes</button>
        </div>
      </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="Search">
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <!-- Active Followers Section (replacing Trending Topics and Top Contributors) -->
      <div class="active-followers-section" id="active-followers-section">
        <div class="active-followers-header">
          <span>Active Followers</span>
          <button class="active-followers-header-toggle" id="active-followers-toggle">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div id="active-followers-list">
          <!-- Active followers will be dynamically inserted here -->
        </div>
      </div>
    </div>
    
    <!-- Message Sidebar -->
    <div class="message-sidebar" id="message-sidebar">
      <div class="message-header">
        <div class="message-header-title">Messages</div>
        <button class="message-close" id="message-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="message-content" id="message-content">
        <div class="message-list" id="message-sidebar-list">
          <!-- Messages will be dynamically inserted here -->
        </div>
      </div>
      
      <div class="message-chat" id="message-chat">
        <div class="chat-header">
          <button class="chat-back" id="chat-back">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div class="chat-user-info">
            <div class="chat-user-name" id="chat-user-name">User Name</div>
            <div class="chat-user-status" id="chat-user-status">Online</div>
          </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
          <!-- Chat messages will be dynamically inserted here -->
        </div>
        
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
          <button class="chat-send" id="chat-send">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mobile Navigation -->
  <div class="mobile-nav" id="mobile-nav">
    <a href="#" class="mobile-nav-link active" id="mobile-home">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="#" class="mobile-nav-link" id="mobile-notifications">
      <i class="fas fa-bell"></i>
      <span>Notifications</span>
    </a>
    <a href="#" class="mobile-nav-link" id="mobile-messages">
      <i class="fas fa-envelope"></i>
      <span>Messages</span>
    </a>
    <a href="#" class="mobile-nav-link mobile-menu-btn" id="mobile-menu">
      <i class="fas fa-bars"></i>
      <span>Menu</span>
      <div class="mobile-menu-dropdown" id="mobile-menu-dropdown">
        <a href="#" class="dropdown-item" id="mobile-profile-link">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
        <a href="#" class="dropdown-item" id="mobile-settings-link">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
        <a href="#" class="dropdown-item logout" id="mobile-logout-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Log out</span>
        </a>
      </div>
    </a>
  </div>
  
  <!-- Floating Tweet Button -->
  <div class="float-tweet-btn" id="float-tweet-btn">
    <i class="fas fa-feather-alt"></i>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container">
    <!-- Toast notifications will be dynamically inserted here -->
  </div>
  
  <!-- Edit Modal -->
  <div class="modal-overlay" id="edit-modal-overlay"></div>
  <div class="modal" id="edit-modal">
    <div class="modal-header">
      <div class="modal-title">Edit Scrib</div>
      <button class="modal-close" id="edit-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 1rem;">
        <input type="text" id="edit-title" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); font-family: 'Merriweather', serif; background-color: var(--secondary-color); color: var(--text-color);" placeholder="Title">
      </div>
      <div>
        <textarea id="edit-content" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); font-family: 'Source Sans Pro', sans-serif; min-height: 120px; resize: vertical; background-color: var(--secondary-color); color: var(--text-color);" placeholder="Content"></textarea>
      </div>
      
      <!-- Edit Image Preview Container -->
      <div class="image-preview-container" id="edit-image-preview-container">
        <!-- Edit image previews will be added here dynamically -->
      </div>
      
      <div class="compose-tools" style="margin-top: 1rem;">
        <button class="compose-tool" id="edit-upload-image-btn">
          <i class="far fa-image"></i>
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="edit-cancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="edit-save">Save</button>
    </div>
  </div>
  
  <!-- Report Modal -->
  <div class="modal-overlay" id="report-modal-overlay"></div>
  <div class="modal" id="report-modal">
    <div class="modal-header">
      <div class="modal-title">Report</div>
      <button class="modal-close" id="report-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 1rem;">Please select a reason for reporting:</p>
      <div class="report-options">
        <div class="report-option">
          <input type="radio" name="report-reason" id="report-spam" class="report-option-radio" value="spam">
          <label for="report-spam">Spam</label>
        </div>
        <div class="report-option">
          <input type="radio" name="report-reason" id="report-harassment" class="report-option-radio" value="harassment">
          <label for="report-harassment">Harassment</label>
        </div>
        <div class="report-option">
          <input type="radio" name="report-reason" id="report-inappropriate" class="report-option-radio" value="inappropriate">
          <label for="report-inappropriate">Inappropriate content</label>
        </div>
        <div class="report-option">
          <input type="radio" name="report-reason" id="report-other" class="report-option-radio" value="other">
          <label for="report-other">Other</label>
        </div>
      </div>
      <div class="report-details">
        <p style="margin-bottom: 0.5rem;">Additional details (optional):</p>
        <textarea class="report-textarea" id="report-details" placeholder="Please provide any additional information"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="report-cancel">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="report-submit">Submit</button>
    </div>
  </div>
  
  <!-- Followers Modal -->
  <div class="modal-overlay" id="followers-modal-overlay"></div>
  <div class="modal" id="followers-modal">
    <div class="modal-header">
      <div class="modal-title">Followers</div>
      <button class="modal-close" id="followers-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="user-list" id="followers-list">
        <!-- Followers will be dynamically inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Following Modal -->
  <div class="modal-overlay" id="following-modal-overlay"></div>
  <div class="modal" id="following-modal">
    <div class="modal-header">
      <div class="modal-title">Following</div>
      <button class="modal-close" id="following-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="user-list" id="following-list">
        <!-- Following users will be dynamically inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Image Lightbox -->
  <div class="lightbox-overlay" id="lightbox-overlay">
    <div class="lightbox-content">
      <img src="/placeholder.svg" alt="Full size image" class="lightbox-image" id="lightbox-image">
      <button class="lightbox-close" id="lightbox-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <!-- Login Modal -->
  <div class="login-modal-overlay" id="login-modal-overlay"></div>
  <div class="login-modal" id="login-modal">
    <div class="login-modal-header">
      <img src="/src/godc.png" alt="Logo" class="login-modal-logo">
      <h2 class="login-modal-title">Log in to Commons</h2>
      <p class="login-modal-subtitle">Join the conversation</p>
    </div>
    <div class="login-modal-body">
      <button class="login-btn" id="google-login-btn">
        <i class="fab fa-google"></i> Sign in with Google
      </button>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { 
      getAuth, 
      signOut, 
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
    import { 
      getFirestore,
      collection,
      doc,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      where,
      getDocs,
      getDoc,
      deleteDoc,
      updateDoc,
      increment,
      arrayUnion,
      arrayRemove,
      writeBatch,
      limit,
      Timestamp,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSe2c9-8xqShoHEW-D7BXXAyD5N9uXWEs",
      authDomain: "ang-silakbo.firebaseapp.com",
      projectId: "ang-silakbo",
      storageBucket: "ang-silakbo.appspot.com",
      messagingSenderId: "1006400633782",
      appId: "1:1006400633782:web:ef4a93c1d445cb825b9f17",
      measurementId: "G-TSDTG2YJ94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // Cloudinary configuration
    const cloudName = "dz3sdis2x";
    const uploadPreset = "Ang Silakbo 1";

    // Admin users mapping
    const adminUsers = {
      "angsilakbo1@uclm.com": "Miss Queen",
      "angsilakbo2@uclm.com": "Miss June",
      "angsilakbo3@uclm.com": "Miss Diana"
    };

    // Check if a user is an admin
    function isAdmin(email) {
      return Object.keys(adminUsers).includes(email);
    }

    // Get admin display name
    function getAdminDisplayName(email) {
      return adminUsers[email] || email;
    }

    // DOM Elements
    const tweetsContainer = document.getElementById('tweets-container');
    const tweetContent = document.getElementById('tweet-content');
    const tweetTitle = document.getElementById('tweet-title');
    const tweetTags = document.getElementById('tweet-tags');
    const categorySelect = document.getElementById('category-select');
    const tweetSubmit = document.getElementById('tweet-submit');
    const composeBtn = document.getElementById('compose-btn');
    const floatTweetBtn = document.getElementById('float-tweet-btn');
    const searchInput = document.getElementById('search-input');
    const activeFollowersList = document.getElementById('active-followers-list');
    const activeFollowersToggle = document.getElementById('active-followers-toggle');
    const userProfileBtn = document.getElementById('user-profile-btn');
    const profileDropdown = document.getElementById('profile-dropdown');
    const dropdownProfile = document.getElementById('dropdown-profile');
    const dropdownLogout = document.getElementById('dropdown-logout');
    const sidebarAvatar = document.getElementById('sidebar-avatar');
    const sidebarName = document.getElementById('sidebar-name');
    const sidebarHandle = document.getElementById('sidebar-handle');
    const composeAvatar = document.getElementById('compose-avatar');
    const homeLink = document.getElementById('home-link');
    const notificationsLink = document.getElementById('notifications-link');
    const messagesLink = document.getElementById('messages-link');
    const profileLink = document.getElementById('profile-link');
    const settingsLink = document.getElementById('settings-link');
    const mobileHome = document.getElementById('mobile-home');
    const mobileNotifications = document.getElementById('mobile-notifications');
    const mobileMessages = document.getElementById('mobile-messages');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuDropdown = document.getElementById('mobile-menu-dropdown');
    const mobileProfileLink = document.getElementById('mobile-profile-link');
    const mobileSettingsLink = document.getElementById('mobile-settings-link');
    const mobileLogoutLink = document.getElementById('mobile-logout-link');
    const pageTitle = document.getElementById('page-title');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    const appContainer = document.getElementById('app-container');
    const toggleDarkMode = document.getElementById('toggle-dark-mode');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const anonymousToggle = document.getElementById('anonymous-post-toggle');
    
    // Message Sidebar Elements
    const messageSidebar = document.getElementById('message-sidebar');
    const messageClose = document.getElementById('message-close');
    const messageSidebarList = document.getElementById('message-sidebar-list');
    const messageChat = document.getElementById('message-chat');
    const chatBack = document.getElementById('chat-back');
    const chatUserName = document.getElementById('chat-user-name');
    const chatUserStatus = document.getElementById('chat-user-status');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    
    // Messages Page
    const messagesPage = document.getElementById('messages-page');
    const messageList = document.getElementById('message-list');
    
    // Login Modal Elements
    const loginModalOverlay = document.getElementById('login-modal-overlay');
    const loginModal = document.getElementById('login-modal');
    const googleLoginBtn = document.getElementById('google-login-btn');
    
    // Image Upload Elements
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const uploadImageBtn = document.getElementById('upload-image-btn');
    
    // Edit Image Upload Elements
    const editImagePreviewContainer = document.getElementById('edit-image-preview-container');
    const editUploadImageBtn = document.getElementById('edit-upload-image-btn');
    
    // Profile Image Upload
    const profileImageUpload = document.getElementById('profile-image-upload');
    
    // Lightbox Elements
    const lightboxOverlay = document.getElementById('lightbox-overlay');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxClose = document.getElementById('lightbox-close');
    
    // Pages
    const homePage = document.getElementById('home-page');
    const notificationsPage = document.getElementById('notifications-page');
    const profilePage = document.getElementById('profile-page');
    const settingsPage = document.getElementById('settings-page');
    
    // Modals
    const editModal = document.getElementById('edit-modal');
    const editModalOverlay = document.getElementById('edit-modal-overlay');
    const editModalClose = document.getElementById('edit-modal-close');
    const editTitle = document.getElementById('edit-title');
    const editContent = document.getElementById('edit-content');
    const editSave = document.getElementById('edit-save');
    const editCancel = document.getElementById('edit-cancel');
    
    const reportModal = document.getElementById('report-modal');
    const reportModalOverlay = document.getElementById('report-modal-overlay');
    const reportModalClose = document.getElementById('report-modal-close');
    const reportSubmit = document.getElementById('report-submit');
    const reportCancel = document.getElementById('report-cancel');
    const reportOptions = document.querySelectorAll('.report-option');
    const reportDetails = document.getElementById('report-details');
    
    const followersModal = document.getElementById('followers-modal');
    const followersModalOverlay = document.getElementById('followers-modal-overlay');
    const followersModalClose = document.getElementById('followers-modal-close');
    const followersList = document.getElementById('followers-list');
    
    const followingModal = document.getElementById('following-modal');
    const followingModalOverlay = document.getElementById('following-modal-overlay');
    const followingModalClose = document.getElementById('following-modal-close');
    const followingList = document.getElementById('following-list');
    
    // Profile Elements
    const profileAvatar = document.getElementById('profile-avatar');
    const profileName = document.getElementById('profile-name');
    const profileHandle = document.getElementById('profile-handle');
    const profileBio = document.getElementById('profile-bio');
    const profileLastActive = document.getElementById('profile-last-active');
    const profileOnlineIndicator = document.getElementById('profile-online-indicator');
    const profilePostsCount = document.getElementById('profile-posts').querySelector('.profile-stat-value');
    const profileFollowersCount = document.getElementById('profile-followers').querySelector('.profile-stat-value');
    const profileFollowingCount = document.getElementById('profile-following').querySelector('.profile-stat-value');
    const profileActions = document.getElementById('profile-actions');
    const followBtn = document.getElementById('follow-btn');
    const messageBtn = document.getElementById('message-btn');
    const reportUserBtn = document.getElementById('report-user-btn');
    const profileTabs = document.querySelectorAll('.profile-tab');
    const profileTweetsContainer = document.getElementById('profile-tweets-container');
    
    // Settings Elements
    const settingsUsername = document.getElementById('settings-username');
    const settingsBio = document.getElementById('settings-bio');
    const emailNotifications = document.getElementById('email-notifications');
    const pushNotifications = document.getElementById('push-notifications');
    const privateAccount = document.getElementById('private-account');
    const activityStatus = document.getElementById('activity-status');
    const saveSettings = document.getElementById('save-settings');

    // Variables for image upload
    let uploadedImages = [];
    let editImages = [];
    let profileImageUrl = null;
    
    // Online users tracking
    const onlineUsers = new Map();
    const lastActiveTimestamps = new Map();
    
    // Current chat user
    let currentChatUser = null;
    let currentChatType = 'message'; // 'message' only since poke is now equivalent to message

    // Helper Functions
    function generateAvatarUrl(seed) {
      return `https://api.dicebear.com/7.x/bottts/svg?seed=${seed}`;
    }
    
    // Generate incognito avatar for anonymous posts
    function generateIncognitoAvatar() {
      return `<div class="anonymous-icon"><i class="fas fa-user-secret"></i></div>`;
    }

    function showToast(message) {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }
    
    // Toggle Dark Mode
    function toggleDarkModeFunc() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      
      // Update toggle button icon
      toggleDarkMode.innerHTML = isDarkMode ? 
        '<i class="fas fa-sun"></i>' : 
        '<i class="fas fa-moon"></i>';
      
      // Update settings toggle
      darkModeToggle.checked = isDarkMode;
      
      // Save preference to localStorage
      localStorage.setItem('darkMode', isDarkMode);
    }
    
    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      toggleDarkMode.innerHTML = '<i class="fas fa-sun"></i>';
      darkModeToggle.checked = true;
    }
    
    // Dark mode toggle event listeners
    toggleDarkMode.addEventListener('click', toggleDarkModeFunc);
    darkModeToggle.addEventListener('change', toggleDarkModeFunc);
    
    // Toggle Right Sidebar
    toggleSidebarBtn.addEventListener('click', () => {
      appContainer.classList.toggle('hide-right-sidebar');
      
      // Update toggle button icon
      const isHidden = appContainer.classList.contains('hide-right-sidebar');
      toggleSidebarBtn.innerHTML = isHidden ? 
        '<i class="fas fa-chevron-left"></i>' : 
        '<i class="fas fa-chevron-right"></i>';
    });
    
    // Toggle Message Sidebar
    function toggleMessageSidebar(show = true) {
      if (show) {
        messageSidebar.classList.add('show');
        appContainer.classList.add('show-message-sidebar');
      } else {
        messageSidebar.classList.remove('show');
        appContainer.classList.remove('show-message-sidebar');
        // Hide chat view
        messageChat.classList.remove('show');
      }
    }
    
    // Message sidebar event listeners
    messageClose.addEventListener('click', () => {
      toggleMessageSidebar(false);
    });
    
    // Chat back button
    chatBack.addEventListener('click', () => {
      messageChat.classList.remove('show');
    });
    
    // Send message
    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    function sendMessage() {
      const messageText = chatInput.value.trim();
      if (!messageText) return;
      
      if (currentChatUser && auth.currentUser) {
        // Add message to Firestore
        addDoc(collection(db, 'messages'), {
          senderId: auth.currentUser.uid,
          receiverId: currentChatUser,
          text: messageText,
          type: 'message', // Always use 'message' type since poke is now equivalent to message
          timestamp: new Date(),
          read: false
        }).then(() => {
          chatInput.value = '';
          
          // Add notification for the receiver
          addNotification(
            currentChatUser, 
            `${auth.currentUser.displayName || auth.currentUser.email} sent you a message.`, 
            'message', 
            auth.currentUser.uid
          );
        }).catch(error => {
          console.error('Error sending message:', error);
          showToast('Failed to send message. Please try again.');
        });
      }
    }

    // Cloudinary Upload Widget
    function initCloudinaryUploadWidget(callback) {
      const options = {
        cloudName: cloudName,
        uploadPreset: uploadPreset,
        sources: ['local', 'url', 'camera'],
        multiple: true,
        maxFiles: 5,
        maxFileSize: 10000000, // 10MB
        resourceType: 'image',
        cropping: false,
        styles: {
          palette: {
            window: "#FFFFFF",
            sourceBg: "#F7F9FA",
            windowBorder: "#E1E8ED",
            tabIcon: "#E65100",
            inactiveTabIcon: "#657786",
            menuIcons: "#E65100",
            link: "#E65100",
            action: "#E65100",
            inProgress: "#E65100",
            complete: "#4E9F3D",
            error: "#E0245E",
            textDark: "#14171A",
            textLight: "#FFFFFF"
          }
        }
      };
      
      return cloudinary.createUploadWidget(options, (error, result) => {
        if (!error && result && result.event === "success") {
          const imageUrl = result.info.secure_url;
          callback(imageUrl);
        }
        
        if (error) {
          console.error('Cloudinary upload error:', error);
          showToast('Error uploading image. Please try again.');
        }
      });
    }

    // Initialize Cloudinary Upload Widgets
    const uploadWidget = initCloudinaryUploadWidget((imageUrl) => {
      uploadedImages.push(imageUrl);
      updateImagePreview(imagePreviewContainer, uploadedImages, (index) => {
        uploadedImages.splice(index, 1);
        updateImagePreview(imagePreviewContainer, uploadedImages);
      });
      showToast('Image uploaded successfully!');
    });
    
    const editUploadWidget = initCloudinaryUploadWidget((imageUrl) => {
      editImages.push(imageUrl);
      updateImagePreview(editImagePreviewContainer, editImages, (index) => {
        editImages.splice(index, 1);
        updateImagePreview(editImagePreviewContainer, editImages);
      });
      showToast('Image uploaded successfully!');
    });
    
    const profileUploadWidget = initCloudinaryUploadWidget((imageUrl) => {
      profileImageUrl = imageUrl;
      
      // Update user's profile picture in Firebase
      updateDoc(doc(db, 'users', auth.currentUser.uid), {
        photoURL: imageUrl
      }).then(() => {
        // Update UI
        sidebarAvatar.src = imageUrl;
        composeAvatar.src = imageUrl;
        profileAvatar.src = imageUrl;
        showToast('Profile picture updated successfully!');
      }).catch((error) => {
        console.error('Error updating profile picture:', error);
        showToast('Error updating profile picture. Please try again.');
      });
    });

    // Update Image Preview
    function updateImagePreview(container, images, removeCallback) {
      container.innerHTML = '';
      
      if (images.length > 0) {
        container.style.display = 'flex';
        
        images.forEach((imageUrl, index) => {
          const previewItem = document.createElement('div');
          previewItem.className = 'image-preview-item';
          
          const previewImage = document.createElement('img');
          previewImage.className = 'image-preview';
          previewImage.src = imageUrl;
          previewImage.alt = 'Preview';
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'image-remove-btn';
          removeBtn.innerHTML = '<i class="fas fa-times"></i>';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (removeCallback) {
              removeCallback(index);
            }
          });
          
          previewItem.appendChild(previewImage);
          previewItem.appendChild(removeBtn);
          container.appendChild(previewItem);
        });
      } else {
        container.style.display = 'none';
      }
    }

    // Image Upload Event Listeners
    uploadImageBtn.addEventListener('click', () => {
      uploadWidget.open();
    });
    
    editUploadImageBtn.addEventListener('click', () => {
      editUploadWidget.open();
    });
    
    profileImageUpload.addEventListener('click', () => {
      profileUploadWidget.open();
    });
    
    // Lightbox Event Listeners
    lightboxClose.addEventListener('click', () => {
      lightboxOverlay.style.display = 'none';
    });
    
    lightboxOverlay.addEventListener('click', (e) => {
      if (e.target === lightboxOverlay) {
        lightboxOverlay.style.display = 'none';
      }
    });

    // Toggle Profile Dropdown
    userProfileBtn.addEventListener('click', () => {
      profileDropdown.classList.toggle('show');
    });

    // Toggle Mobile Menu Dropdown
    mobileMenu.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      mobileMenuDropdown.classList.toggle('show');
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!userProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.remove('show');
      }
      
      if (!mobileMenu.contains(e.target) && !mobileMenuDropdown.contains(e.target)) {
        mobileMenuDropdown.classList.remove('show');
      }
    });

    // Dropdown Actions
    dropdownProfile.addEventListener('click', (e) => {
      e.preventDefault();
      profileDropdown.classList.remove('show');
      setActiveNavItem('profile');
      loadUserProfile(auth.currentUser.uid);
    });

    dropdownLogout.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to log out?')) {
        // Update user's online status to offline
        if (auth.currentUser) {
          updateDoc(doc(db, 'users', auth.currentUser.uid), {
            online: false,
            lastActive: serverTimestamp()
          }).then(() => {
            signOut(auth)
              .then(() => {
                showLoginModal();
              })
              .catch((error) => showToast(error.message));
          }).catch((error) => {
            console.error('Error updating online status:', error);
            signOut(auth)
              .then(() => {
                showLoginModal();
              })
              .catch((error) => showToast(error.message));
          });
        }
      }
    });

    // Mobile Menu Actions
    mobileProfileLink.addEventListener('click', (e) => {
      e.preventDefault();
      mobileMenuDropdown.classList.remove('show');
      loadUserProfile(auth.currentUser.uid);
    });

    mobileSettingsLink.addEventListener('click', (e) => {
      e.preventDefault();
      mobileMenuDropdown.classList.remove('show');
      pageTitle.textContent = 'Settings';
      setActiveNavItem('settings');
      showPage('settings-page');
      loadUserSettings();
    });

    mobileLogoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to log out?')) {
        // Update user's online status to offline
        if (auth.currentUser) {
          updateDoc(doc(db, 'users', auth.currentUser.uid), {
            online: false,
            lastActive: serverTimestamp()
          }).then(() => {
            signOut(auth)
              .then(() => {
                showLoginModal();
              })
              .catch((error) => showToast(error.message));
          }).catch((error) => {
            console.error('Error updating online status:', error);
            signOut(auth)
              .then(() => {
                showLoginModal();
              })
              .catch((error) => showToast(error.message));
          });
        }
      }
    });

    // Toggle Active Followers Section
    activeFollowersToggle.addEventListener('click', () => {
      const followersList = document.getElementById('active-followers-list');
      if (followersList.style.display === 'none') {
        followersList.style.display = 'block';
        activeFollowersToggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
      } else {
        followersList.style.display = 'none';
        activeFollowersToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
      }
    });
    
    // Login Modal
    function showLoginModal() {
      loginModalOverlay.style.display = 'block';
      loginModal.style.display = 'block';
    }
    
    function hideLoginModal() {
      loginModalOverlay.style.display = 'none';
      loginModal.style.display = 'none';
    }
    
    // Google Login
    googleLoginBtn.addEventListener('click', () => {
      signInWithPopup(auth, provider)
        .then((result) => {
          hideLoginModal();
        })
        .catch((error) => {
          console.error('Login error:', error);
          showToast('Login failed. Please try again.');
        });
    });

    // Auth State Change
    onAuthStateChanged(auth, (user) => {
      if (user) {
        hideLoginModal();
        
        // Update user info in sidebar
        let displayName = user.displayName || user.email.split('@')[0];
        let userHandle = '@' + (user.displayName || user.email.split('@')[0]).toLowerCase().replace(/\s+/g, '');
        
        // Check if user is an admin and update display name
        if (isAdmin(user.email)) {
          displayName = getAdminDisplayName(user.email);
          userHandle = '@admin_' + displayName.toLowerCase().replace(/\s+/g, '');
        }
        
        sidebarName.textContent = displayName;
        sidebarHandle.textContent = userHandle;
        sidebarAvatar.src = user.photoURL || generateAvatarUrl(user.uid);
        composeAvatar.src = user.photoURL || generateAvatarUrl(user.uid);
        
        // Initialize user data if it doesn't exist
        initializeUserData(user);
        
        // Update user's online status
        updateDoc(doc(db, 'users', user.uid), {
          online: true,
          lastActive: serverTimestamp()
        });
        
        // Track online users
        const onlineUsersRef = collection(db, 'users');
        const onlineQuery = query(onlineUsersRef, where('online', '==', true));
        
        onSnapshot(onlineQuery, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            const userData = change.doc.data();
            const userId = change.doc.id;
            
            if (change.type === 'added' || change.type === 'modified') {
              onlineUsers.set(userId, userData.online);
              if (userData.lastActive) {
                lastActiveTimestamps.set(userId, userData.lastActive.toDate());
              }
            }
            
            if (change.type === 'removed') {
              onlineUsers.delete(userId);
            }
          });
          
          // Update UI for any visible users
          updateOnlineIndicators();
        });
        
        // Track last active timestamps
        const lastActiveQuery = query(onlineUsersRef);
        
        onSnapshot(lastActiveQuery, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            const userData = change.doc.data();
            const userId = change.doc.id;
            
            if (userData.lastActive && (change.type === 'added' || change.type === 'modified')) {
              lastActiveTimestamps.set(userId, userData.lastActive.toDate());
            }
          });
          
          // Update UI for any visible users
          updateLastActiveTimestamps();
        });
        
        loadPosts();
        loadActiveFollowers();
        loadNotifications();
        loadMessages();
      } else {
        showLoginModal();
      }
    });
    
    // Update online indicators in the UI
    function updateOnlineIndicators() {
      // Add null check for displayName
      function getDisplayName(user) {
        return user.displayName || user.email?.split('@')[0] || 'Anonymous User';
      }

      // Update online indicators for tweets
      document.querySelectorAll('.tweet-avatar-container').forEach(container => {
        const userId = container.querySelector('.tweet-avatar')?.dataset?.userId;
        if (userId) {
          const onlineIndicator = container.querySelector('.online-indicator');
          if (onlineIndicator) {
            onlineIndicator.style.display = onlineUsers.get(userId) ? 'block' : 'none';
          }
        }
      });
      
      // Update online indicators for comments
      document.querySelectorAll('.comment-avatar-container').forEach(container => {
        const userId = container.querySelector('.comment-avatar').dataset.userId;
        const indicator = container.querySelector('.comment-online-indicator');
                if (indicator) {
          if (onlineUsers.get(userId)) {
            indicator.style.display = 'block';
          } else {
            indicator.style.display = 'none';
          }
        }
      });
      
      // Update online indicators for profile
      if (profileOnlineIndicator) {
        const userId = profileAvatar.dataset.userId;
        
        if (userId && onlineUsers.get(userId)) {
          profileOnlineIndicator.style.display = 'block';
        } else {
          profileOnlineIndicator.style.display = 'none';
        }
      }
      
      // Update online indicators for active followers
      document.querySelectorAll('.active-followers-avatar-container').forEach(container => {
        const userId = container.querySelector('.active-followers-avatar').dataset.userId;
        const indicator = container.querySelector('.active-followers-online-indicator');
        
        if (indicator) {
          if (onlineUsers.get(userId)) {
            indicator.style.display = 'block';
          } else {
            indicator.style.display = 'none';
          }
        }
      });
      
      // Update online indicators for user lists (followers/following)
      document.querySelectorAll('.user-list-avatar-container').forEach(container => {
        const userId = container.querySelector('.user-list-avatar').dataset.userId;
        const indicator = container.querySelector('.user-list-online-indicator');
        
        if (indicator) {
          if (onlineUsers.get(userId)) {
            indicator.style.display = 'block';
          } else {
            indicator.style.display = 'none';
          }
        }
      });
      
      // Update online indicators for messages
      document.querySelectorAll('.message-avatar-container').forEach(container => {
        const userId = container.querySelector('.message-avatar').dataset.userId;
        const indicator = container.querySelector('.message-online-indicator');
        
        if (indicator) {
          if (onlineUsers.get(userId)) {
            indicator.style.display = 'block';
          } else {
            indicator.style.display = 'none';
          }
        }
      });
      
      // Update chat user status
      if (currentChatUser && chatUserStatus) {
        if (onlineUsers.get(currentChatUser)) {
          chatUserStatus.textContent = 'Online';
          chatUserStatus.style.color = 'var(--online-color)';
        } else if (lastActiveTimestamps.has(currentChatUser)) {
          const lastActive = lastActiveTimestamps.get(currentChatUser);
          chatUserStatus.textContent = `Last active: ${formatLastActive(lastActive)}`;
          chatUserStatus.style.color = 'var(--text-secondary)';
        } else {
          chatUserStatus.textContent = 'Offline';
          chatUserStatus.style.color = 'var(--text-secondary)';
        }
      }
    }
    
    // Update last active timestamps in the UI
    function updateLastActiveTimestamps() {
      // Update last active for tweets
      document.querySelectorAll('.last-active').forEach(element => {
        const userId = element.dataset.userId;
        
        if (userId && lastActiveTimestamps.has(userId)) {
          const lastActive = lastActiveTimestamps.get(userId);
          element.textContent = `Last active: ${formatLastActive(lastActive)}`;
        }
      });
      
      // Update last active for profile
      if (profileLastActive) {
        const userId = profileAvatar.dataset.userId;
        
        if (userId) {
          if (onlineUsers.get(userId)) {
            profileLastActive.textContent = 'Online now';
          } else if (lastActiveTimestamps.has(userId)) {
            const lastActive = lastActiveTimestamps.get(userId);
            profileLastActive.textContent = `Last active: ${formatLastActive(lastActive)}`;
          }
        }
      }
      
      // Update last active for active followers
      document.querySelectorAll('.active-followers-last-active').forEach(element => {
        const userId = element.dataset.userId;
        
        if (userId) {
          if (onlineUsers.get(userId)) {
            element.textContent = 'Online now';
          } else if (lastActiveTimestamps.has(userId)) {
            const lastActive = lastActiveTimestamps.get(userId);
            element.textContent = `Last active: ${formatLastActive(lastActive)}`;
          }
        }
      });
      
      // Update last active for user lists (followers/following)
      document.querySelectorAll('.user-list-last-active').forEach(element => {
        const userId = element.dataset.userId;
        
        if (userId) {
          if (onlineUsers.get(userId)) {
            element.textContent = 'Online now';
          } else if (lastActiveTimestamps.has(userId)) {
            const lastActive = lastActiveTimestamps.get(userId);
            element.textContent = `Last active: ${formatLastActive(lastActive)}`;
          }
        }
      });
      
      // Update last active for messages
      document.querySelectorAll('.message-time').forEach(element => {
        const userId = element.dataset.userId;
        
        if (userId) {
          if (onlineUsers.get(userId)) {
            element.textContent = 'Online now';
          } else if (lastActiveTimestamps.has(userId)) {
            const lastActive = lastActiveTimestamps.get(userId);
            element.textContent = `Last active: ${formatLastActive(lastActive)}`;
          }
        }
      });
    }
    
    // Format last active time
    function formatLastActive(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000); // seconds
      
      if (diff < 60) {
        return 'Just now';
      } else if (diff < 3600) {
        const minutes = Math.floor(diff / 60);
        return `${minutes} ${minutes === 1 ? 'minute' : 'minutes'} ago`;
      } else if (diff < 86400) {
        const hours = Math.floor(diff / 3600);
        return `${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
      } else if (diff < 604800) {
        const days = Math.floor(diff / 86400);
        return `${days} ${days === 1 ? 'day' : 'days'} ago`;
      } else {
        return date.toLocaleDateString();
      }
    }

    // Initialize user data
    async function initializeUserData(user) {
      const userRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userRef);
      
      if (!userDoc.exists()) {
        // Create user document if it doesn't exist
        await setDoc(userRef, {
          displayName: isAdmin(user.email) ? getAdminDisplayName(user.email) : (user.displayName || user.email.split('@')[0]),
          email: user.email,
          photoURL: user.photoURL || generateAvatarUrl(user.uid),
          bio: '',
          followers: [],
          following: [],
          createdAt: new Date(),
          isAdmin: isAdmin(user.email),
          online: true,
          lastActive: serverTimestamp(),
          settings: {
            emailNotifications: false,
            pushNotifications: true,
            privateAccount: false,
            activityStatus: true
          }
        });
      } else {
        // Update online status and last active
        await updateDoc(userRef, {
          online: true,
          lastActive: serverTimestamp()
        });
      }
    }

    // Tweet Submission
    tweetSubmit.addEventListener('click', submitTweet);
    
    function submitTweet() {
      const title = tweetTitle.value.trim();
      const content = tweetContent.value.trim();
      const category = categorySelect.value;
      const tagsList = tweetTags.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      const isAnonymous = anonymousToggle.checked;
      
      if (title && content && category) {
        tweetSubmit.disabled = true;
        
        const postData = {
          title: title,
          content: content,
          category: category,
          tags: tagsList,
          timestamp: new Date(),
          userId: auth.currentUser.uid,
          userName: isAdmin(auth.currentUser.email) ? 
                    getAdminDisplayName(auth.currentUser.email) : 
                    (auth.currentUser.displayName || auth.currentUser.email),
          likes: 0,
          dislikes: 0,
          likedBy: [],
          dislikedBy: [],
          isAnonymous: isAnonymous
        };
        
        // Add image URLs if uploaded
        if (uploadedImages.length > 0) {
          postData.imageUrls = uploadedImages;
        }
        
        addDoc(collection(db, 'posts'), postData)
        .then(() => {
          // Clear form fields
          tweetTitle.value = '';
          tweetContent.value = '';
          categorySelect.value = '';
          tweetTags.value = '';
          anonymousToggle.checked = false;
          uploadedImages = [];
          imagePreviewContainer.innerHTML = '';
          imagePreviewContainer.style.display = 'none';
          
          showToast('Scrib posted successfully!');
          tweetSubmit.disabled = false;
          
          // Update active followers
          loadActiveFollowers();
        })
        .catch((error) => {
          showToast(error.message);
          tweetSubmit.disabled = false;
        });
      } else {
        showToast('Please fill in all required fields');
      }
    }

    // Load Posts
    let unsubscribePosts = null;
    let currentQuery = null;
    let currentCategory = 'all';

    function loadPosts(userId = null, category = currentCategory) {
      // Unsubscribe from previous listener if exists
      if (unsubscribePosts) {
        unsubscribePosts();
        unsubscribePosts = null;
      }

      // If the query is the same as the current one, don't reload
      const queryString = userId ? `user-${userId}-${category}` : `all-${category}`;
      if (queryString === currentQuery) {
        return;
      }
      currentQuery = queryString;
      currentCategory = category;
      
      let q;
      if (userId) {
        if (category !== 'all') {
          q = query(
            collection(db, 'posts'), 
            where('userId', '==', userId),
            where('category', '==', category),
            orderBy('timestamp', 'desc')
          );
        } else {
          q = query(
            collection(db, 'posts'), 
            where('userId', '==', userId), 
            orderBy('timestamp', 'desc')
          );
        }
      } else {
        if (category !== 'all') {
          q = query(
            collection(db, 'posts'),
            where('category', '==', category),
            orderBy('timestamp', 'desc')
          );
        } else {
          q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
        }
      }
      
      const container = userId ? profileTweetsContainer : tweetsContainer;
      container.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading posts...</div>';
      
      unsubscribePosts = onSnapshot(q, (querySnapshot) => {
        container.innerHTML = ''; // Clear container before rendering
        
        if (querySnapshot.empty) {
          container.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">No scribs found.</p></div>';
          return;
        }
        
        querySnapshot.forEach((doc) => {
          const post = doc.data();
          const tweetElement = document.createElement('div');
          tweetElement.className = 'tweet';
          if (post.isAnonymous) {
            tweetElement.classList.add('anonymous-post');
          }
          tweetElement.dataset.postId = doc.id;
          
          // Check if current user is admin or post owner
          const isCurrentUserAdmin = isAdmin(auth.currentUser.email);
          const isPostOwner = post.userId === auth.currentUser.uid;
          
          // Determine if delete/edit buttons should be shown
          const showDeleteButton = isCurrentUserAdmin || isPostOwner;
          const showEditButton = isPostOwner;
          
          // Format date
          const postDate = post.timestamp?.toDate();
          const formattedDate = postDate ? formatDate(postDate) : '';
          
          // Check if user is admin to add badge
          const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
            return adminUsers[adminEmail] === post.userName;
          });
          
          const adminBadgeHtml = isUserAdmin ? 
            `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
          
          // Create tags HTML
          const tagsHtml = post.tags && post.tags.length > 0 ? 
            post.tags.map(tag => `<span class="tweet-tag">${tag}</span>`).join('') : '';
          
          // Create images HTML if post has images
          let imagesHtml = '';
          if (post.imageUrls && post.imageUrls.length > 0) {
            imagesHtml = '<div class="tweet-images">';
            post.imageUrls.forEach(imageUrl => {
              imagesHtml += `<img src="${imageUrl}" alt="Post image" class="tweet-image" data-full-image="${imageUrl}">`;
            });
            imagesHtml += '</div>';
          } else if (post.imageUrl) {
            // For backward compatibility with old posts
            imagesHtml = `<img src="${post.imageUrl}" alt="Post image" class="tweet-image" data-full-image="${post.imageUrl}">`;
          }
          
          // Check if user is online
          const isUserOnline = onlineUsers.get(post.userId) || false;
          
          // Get last active time
          let lastActiveHtml = '';
          if (!isUserOnline && lastActiveTimestamps.has(post.userId)) {
            const lastActive = lastActiveTimestamps.get(post.userId);
            lastActiveHtml = `<div class="last-active" data-user-id="${post.userId}">Last active: ${formatLastActive(lastActive)}</div>`;
          }
          
          // Handle anonymous posts
          const avatarHtml = post.isAnonymous ? 
            generateIncognitoAvatar() : 
            `<img src="${generateAvatarUrl(post.userId)}" alt="Profile Picture" class="tweet-avatar" data-user-id="${post.userId}">`;
          
          const userNameHtml = post.isAnonymous ? 
            `<p class="tweet-user-name">Anonymous</p>` : 
            `<p class="tweet-user-name" data-user-id="${post.userId}">${post.userName}</p>${adminBadgeHtml}`;
          
          const userHandleHtml = post.isAnonymous ? 
            `<span class="tweet-user-handle">@anonymous</span>` : 
            `<span class="tweet-user-handle">@${post.userName.toLowerCase().replace(/\s+/g, '')}</span>`;
          
          tweetElement.innerHTML = `
            <div class="tweet-header">
              <div class="tweet-avatar-container">
                ${avatarHtml}
                ${!post.isAnonymous ? `<div class="online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>` : ''}
              </div>
              <div class="tweet-user-info">
                <div>
                  ${userNameHtml}
                  ${userHandleHtml}
                </div>
                <p class="tweet-time">${formattedDate}</p>
                ${!post.isAnonymous ? lastActiveHtml : ''}
              </div>
              ${showDeleteButton || showEditButton ? `
                <div class="tweet-more-container" style="position: relative;">
                  <button class="tweet-more">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <div class="tweet-dropdown" style="position: absolute; right: 0; top: 30px; background: var(--secondary-color); border-radius: var(--radius-md); box-shadow: var(--shadow-md); width: 150px; z-index: 10; display: none;">
                    ${showEditButton ? `
                      <div class="dropdown-item edit-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                        <i class="fas fa-edit" style="margin-right: 0.8rem;"></i> Edit
                      </div>
                    ` : ''}
                    ${showDeleteButton ? `
                      <div class="dropdown-item delete-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer; color: var(--error-color);">
                        <i class="fas fa-trash" style="margin-right: 0.8rem;"></i> Delete
                      </div>
                    ` : ''}
                    <div class="dropdown-item report-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                      <i class="fas fa-flag" style="margin-right: 0.8rem;"></i> Report
                    </div>
                  </div>
                </div>
              ` : `
                <div class="tweet-more-container" style="position: relative;">
                  <button class="tweet-more">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <div class="tweet-dropdown" style="position: absolute; right: 0; top: 30px; background: var(--secondary-color); border-radius: var(--radius-md); box-shadow: var(--shadow-md); width: 150px; z-index: 10; display: none;">
                    <div class="dropdown-item report-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                      <i class="fas fa-flag" style="margin-right: 0.8rem;"></i> Report
                    </div>
                  </div>
                </div>
              `}
            </div>
            <div class="tweet-content">
              <h3 class="tweet-title">${post.title}</h3>
              <p class="tweet-text">${post.content}</p>
              ${imagesHtml}
              <div style="margin-top: 0.8rem;">
                <span class="tweet-category">${post.category}</span>
                ${tagsHtml}
              </div>
            </div>
            <div class="tweet-actions">
              <button class="tweet-action comment-btn">
                <i class="far fa-comment"></i>
                <span class="comment-count">0</span>
              </button>
              <button class="tweet-action like-btn ${post.likedBy?.includes(auth.currentUser.uid) ? 'liked' : ''}">
                <i class="${post.likedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-heart"></i>
                <span class="like-count">${post.likes || 0}</span>
              </button>
              <button class="tweet-action dislike-btn ${post.dislikedBy?.includes(auth.currentUser.uid) ? 'disliked' : ''}">
                <i class="${post.dislikedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-thumbs-down"></i>
                <span class="dislike-count">${post.dislikes || 0}</span>
              </button>
              <button class="tweet-action share-btn">
                <i class="far fa-share-square"></i>
              </button>
            </div>
            <div class="comments-section">
              <div class="comments-container"></div>
              <form class="comment-form">
                <input type="text" class="comment-input" placeholder="Scrib your reply">
                <button type="submit" class="comment-submit">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
            </div>
          `;
          
          container.appendChild(tweetElement);

          // Get comments count
          getCommentsCount(doc.id).then(count => {
            const commentCount = tweetElement.querySelector('.comment-count');
            if (commentCount) {
              commentCount.textContent = count;
            }
          });

          // Event Listeners for Tweet Elements
          if (!post.isAnonymous) {
            const tweetAvatar = tweetElement.querySelector('.tweet-avatar');
            const tweetUserName = tweetElement.querySelector('.tweet-user-name');
            
            if (tweetAvatar) {
              tweetAvatar.addEventListener('click', () => {
                loadUserProfile(tweetAvatar.dataset.userId);
              });
            }
            
            if (tweetUserName) {
              tweetUserName.addEventListener('click', () => {
                loadUserProfile(tweetUserName.dataset.userId);
              });
            }
          }

          // Image click event for lightbox
          const tweetImages = tweetElement.querySelectorAll('.tweet-image');
          if (tweetImages.length > 0) {
            tweetImages.forEach(img => {
              img.addEventListener('click', () => {
                lightboxImage.src = img.dataset.fullImage;
                lightboxOverlay.style.display = 'flex';
              });
            });
          }

          const commentsSection = tweetElement.querySelector('.comments-section');
          const commentBtn = tweetElement.querySelector('.comment-btn');
          commentBtn.addEventListener('click', () => {
            commentsSection.classList.toggle('show');
            if (commentsSection.classList.contains('show')) {
              loadComments(doc.id, commentsSection);
            }
          });

          const commentForm = tweetElement.querySelector('.comment-form');
          commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const commentInput = commentForm.querySelector('.comment-input');
            const commentContent = commentInput.value.trim();
            if (commentContent) {
              addComment(doc.id, commentContent);
              commentInput.value = '';
            } else {
              showToast('Comment cannot be empty');
            }
          });

          const tweetMore = tweetElement.querySelector('.tweet-more');
          const tweetDropdown = tweetElement.querySelector('.tweet-dropdown');
          
          if (tweetMore && tweetDropdown) {
            tweetMore.addEventListener('click', (e) => {
              e.stopPropagation();
              tweetDropdown.style.display = tweetDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
              if (tweetDropdown) {
                tweetDropdown.style.display = 'none';
              }
            });
            
            const deleteBtn = tweetElement.querySelector('.delete-tweet-btn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this scrib?')) {
                  deletePost(doc.id, post.imageUrls || (post.imageUrl ? [post.imageUrl] : []));
                }
              });
            }

            const editBtn = tweetElement.querySelector('.edit-tweet-btn');
            if (editBtn) {
              editBtn.addEventListener('click', () => {
                showEditModal(doc.id, post.title, post.content, post.imageUrls || (post.imageUrl ? [post.imageUrl] : []));
              });
            }
            
            const reportBtn = tweetElement.querySelector('.report-tweet-btn');
            if (reportBtn) {
              reportBtn.addEventListener('click', () => {
                showReportModal('post', doc.id);
              });
            }
          }

          const likeBtn = tweetElement.querySelector('.like-btn');
          const dislikeBtn = tweetElement.querySelector('.dislike-btn');
          
          likeBtn.addEventListener('click', async () => {
            if (likeBtn.disabled) return;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;
            
            try {
              await handleLike(doc.id);
              
              // Update UI immediately for better user experience
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              const dislikeIcon = dislikeBtn.querySelector('i');
              const dislikeCount = dislikeBtn.querySelector('.dislike-count');
              
              if (likeBtn.classList.contains('liked')) {
                // Unlike
                likeBtn.classList.remove('liked');
                likeIcon.className = 'far fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
              } else {
                // Like
                likeBtn.classList.add('liked');
                likeIcon.className = 'fas fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) + 1;
                
                // If was disliked, remove dislike
                if (dislikeBtn.classList.contains('disliked')) {
                  dislikeBtn.classList.remove('disliked');
                  dislikeIcon.className = 'far fa-thumbs-down';
                  dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
                }
              }
            } catch (error) {
              console.error('Error updating like:', error);
              showToast('Failed to update like. Please try again.');
            } finally {
              likeBtn.disabled = false;
              dislikeBtn.disabled = false;
            }
          });

          dislikeBtn.addEventListener('click', async () => {
            if (dislikeBtn.disabled) return;
            dislikeBtn.disabled = true;
            likeBtn.disabled = true;
            
            try {
              await handleDislike(doc.id);
              
              // Update UI immediately for better user experience
              const dislikeIcon = dislikeBtn.querySelector('i');
              const dislikeCount = dislikeBtn.querySelector('.dislike-count');
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              
              if (dislikeBtn.classList.contains('disliked')) {
                // Undislike
                dislikeBtn.classList.remove('disliked');
                dislikeIcon.className = 'far fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
              } else {
                // Dislike
                dislikeBtn.classList.add('disliked');
                dislikeIcon.className = 'fas fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
                
                // If was liked, remove like
                if (likeBtn.classList.contains('liked')) {
                  likeBtn.classList.remove('liked');
                  likeIcon.className = 'far fa-heart';
                  likeCount.textContent = parseInt(likeCount.textContent) - 1;
                }
              }
            } catch (error) {
              console.error('Error updating dislike:', error);
              showToast('Failed to update dislike. Please try again.');
            } finally {
              dislikeBtn.disabled = false;
              likeBtn.disabled = false;
            }
          });

          const shareBtn = tweetElement.querySelector('.share-btn');
          shareBtn.addEventListener('click', () => {
            // Simple share functionality - copy URL to clipboard
            const url = window.location.href.split('?')[0] + '?post=' + doc.id;
            navigator.clipboard.writeText(url).then(() => {
              showToast('Link copied to clipboard!');
            });
          });
        });
        
        // Update online indicators and last active timestamps
        updateOnlineIndicators();
        updateLastActiveTimestamps();
      });
    }

    // Format date for tweets
    function formatDate(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000); // seconds
      
      if (diff < 60) {
        return `${diff}s`;
      } else if (diff < 3600) {
        return `${Math.floor(diff / 60)}m`;
      } else if (diff < 86400) {
        return `${Math.floor(diff / 3600)}h`;
      } else if (diff < 604800) {
        return `${Math.floor(diff / 86400)}d`;
      } else {
        return date.toLocaleDateString();
      }
    }

    // Get comments count
    async function getCommentsCount(postId) {
      try {
        const commentsQuery = query(collection(db, 'posts', postId, 'comments'));
        const commentsSnapshot = await getDocs(commentsQuery);
        return commentsSnapshot.size;
      } catch (error) {
        console.error('Error getting comments count:', error);
        return 0;
      }
    }

    // Handle Likes and Dislikes
    async function handleLike(postId) {
      const postRef = doc(db, 'posts', postId);
      const postDoc = await getDoc(postRef);
      const post = postDoc.data();
      const userId = auth.currentUser.uid;
      const batch = writeBatch(db);

      if (post.likedBy && post.likedBy.includes(userId)) {
        // User has already liked, remove the like
        batch.update(postRef, {
          likes: increment(-1),
          likedBy: arrayRemove(userId)
        });
      } else {
        // User hasn't liked, add the like
        batch.update(postRef, {
          likes: increment(1),
          likedBy: arrayUnion(userId)
        });

        // If the user had previously disliked, remove the dislike
        if (post.dislikedBy && post.dislikedBy.includes(userId)) {
          batch.update(postRef, {
            dislikes: increment(-1),
            dislikedBy: arrayRemove(userId)
          });
        }
        
        // Add notification for the post owner if it's not the current user and not anonymous
        if (post.userId !== userId && !post.isAnonymous) {
          addNotification(post.userId, `${auth.currentUser.displayName || auth.currentUser.email} liked your scrib.`, 'like', postId);
        }
      }

      await batch.commit();
    }

    async function handleDislike(postId) {
      const postRef = doc(db, 'posts', postId);
      const postDoc = await getDoc(postRef);
      const post = postDoc.data();
      const userId = auth.currentUser.uid;
      const batch = writeBatch(db);

      if (post.dislikedBy && post.dislikedBy.includes(userId)) {
        // User has already disliked, remove the dislike
        batch.update(postRef, {
          dislikes: increment(-1),
          dislikedBy: arrayRemove(userId)
        });
      } else {
        // User hasn't disliked, add the dislike
        batch.update(postRef, {
          dislikes: increment(1),
          dislikedBy: arrayUnion(userId)
        });

        // If the user had previously liked, remove the like
        if (post.likedBy && post.likedBy.includes(userId)) {
          batch.update(postRef, {
            likes: increment(-1),
            likedBy: arrayRemove(userId)
          });
        }
      }

      await batch.commit();
    }

    // Edit Modal
    function showEditModal(postId, title, content, imageUrls = []) {
      editTitle.value = title;
      editContent.value = content;
      
      // Reset image preview
      editImages = [...imageUrls];
      updateImagePreview(editImagePreviewContainer, editImages, (index) => {
        editImages.splice(index, 1);
        updateImagePreview(editImagePreviewContainer, editImages);
      });
      
      editModal.style.display = 'block';
      editModalOverlay.style.display = 'block';

      editSave.onclick = () => {
        updatePost(postId, editTitle.value, editContent.value, editImages);
        closeEditModal();
      };
    }

    function closeEditModal() {
      editModal.style.display = 'none';
      editModalOverlay.style.display = 'none';
    }

    editModalClose.addEventListener('click', closeEditModal);
    editCancel.addEventListener('click', closeEditModal);
    editModalOverlay.addEventListener('click', closeEditModal);
    
    // Report Modal
    let reportType = '';
    let reportItemId = '';
    
    function showReportModal(type, itemId) {
      reportType = type;
      reportItemId = itemId;
      
      // Reset form
      document.querySelectorAll('input[name="report-reason"]').forEach(radio => {
        radio.checked = false;
      });
      reportDetails.value = '';
      reportOptions.forEach(option => {
        option.classList.remove('selected');
      });
      
      reportModal.style.display = 'block';
      reportModalOverlay.style.display = 'block';
    }
    
    function closeReportModal() {
      reportModal.style.display = 'none';
      reportModalOverlay.style.display = 'none';
    }
    
    reportModalClose.addEventListener('click', closeReportModal);
    reportCancel.addEventListener('click', closeReportModal);
    reportModalOverlay.addEventListener('click', closeReportModal);
    
    // Handle report option selection
    reportOptions.forEach(option => {
      option.addEventListener('click', () => {
        const radio = option.querySelector('input[type="radio"]');
        radio.checked = true;
        
        reportOptions.forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
      });
    });
    
    // Submit report
    reportSubmit.addEventListener('click', () => {
      const selectedReason = document.querySelector('input[name="report-reason"]:checked');
      
      if (!selectedReason) {
        showToast('Please select a reason for reporting');
        return;
      }
      
      const reason = selectedReason.value;
      const details = reportDetails.value.trim();
      
      submitReport(reportType, reportItemId, reason, details);
      closeReportModal();
    });
    
    async function submitReport(type, itemId, reason, details) {
      try {
        await addDoc(collection(db, 'reports'), {
          type: type,
          itemId: itemId,
          reason: reason,
          details: details,
          reportedBy: auth.currentUser.uid,
          reportedAt: new Date(),
          status: 'pending'
        });
        
        showToast('Report submitted successfully');
        
        // Save report to Feedback.html
        saveReportToFeedback(type, itemId, reason, details);
      } catch (error) {
        console.error('Error submitting report:', error);
        showToast('Failed to submit report. Please try again.');
      }
    }
    
    // Save report to Feedback.html
    function saveReportToFeedback(type, itemId, reason, details) {
      // Create a form to submit the report data
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'Feedback.html';
      form.style.display = 'none';
      
      // Add form fields
      const typeField = document.createElement('input');
      typeField.name = 'type';
      typeField.value = type;
      form.appendChild(typeField);
      
      const itemIdField = document.createElement('input');
      itemIdField.name = 'itemId';
      itemIdField.value = itemId;
      form.appendChild(itemIdField);
      
      const reasonField = document.createElement('input');
      reasonField.name = 'reason';
      reasonField.value = reason;
      form.appendChild(reasonField);
      
      const detailsField = document.createElement('input');
      detailsField.name = 'details';
      detailsField.value = details;
      form.appendChild(detailsField);
      
      const userIdField = document.createElement('input');
      userIdField.name = 'userId';
      userIdField.value = auth.currentUser.uid;
      form.appendChild(userIdField);
      
      const userNameField = document.createElement('input');
      userNameField.name = 'userName';
      userNameField.value = auth.currentUser.displayName || auth.currentUser.email;
      form.appendChild(userNameField);
      
      const dateField = document.createElement('input');
      dateField.name = 'date';
      dateField.value = new Date().toISOString();
      form.appendChild(dateField);
      
      // Submit the form
      document.body.appendChild(form);
      
      // Instead of submitting the form, we'll save the data to localStorage
      // This is a workaround since we can't actually submit to a different HTML file in this context
      const reportData = {
        type: type,
        itemId: itemId,
        reason: reason,
        details: details,
        userId: auth.currentUser.uid,
        userName: auth.currentUser.displayName || auth.currentUser.email,
        date: new Date().toISOString()
      };
      
      // Get existing reports or initialize empty array
      const existingReports = JSON.parse(localStorage.getItem('silakboReports') || '[]');
      existingReports.push(reportData);
      localStorage.setItem('silakboReports', JSON.stringify(existingReports));
      
      // Remove the form
      document.body.removeChild(form);
    }

    // Post CRUD Operations
    async function deletePost(postId, imageUrls = []) {
      try {
        await deleteDoc(doc(db, 'posts', postId));
        
        // If post has images, delete them from Cloudinary
        // Note: Cloudinary doesn't provide a direct way to delete images via client-side JavaScript
        // You would typically need a server-side function to handle this securely
        // For now, we'll just show a success message
        
        showToast('Scrib deleted successfully');
        loadActiveFollowers();
      } catch (error) {
        console.error('Error deleting post:', error);
        showToast('Failed to delete scrib. Please try again.');
      }
    }

    async function updatePost(postId, newTitle, newContent, newImageUrls = []) {
      try {
        const postRef = doc(db, 'posts', postId);
        const postDoc = await getDoc(postRef);
        
        if (!postDoc.exists()) {
          throw new Error('Post does not exist!');
        }
        
        const updateData = {
          title: newTitle,
          content: newContent
        };
        
        // Handle image update
        if (newImageUrls.length > 0) {
          updateData.imageUrls = newImageUrls;
          // Remove old imageUrl field if it exists (for backward compatibility)
          if (postDoc.data().imageUrl) {
            updateData.imageUrl = null;
          }
        } else {
          // If all images were removed
          updateData.imageUrls = [];
          if (postDoc.data().imageUrl) {
            updateData.imageUrl = null;
          }
        }
        
        await updateDoc(postRef, updateData);
        showToast('Scrib updated successfully');
      } catch (error) {
        console.error('Error updating post:', error);
        showToast('Failed to update scrib. Please try again.');
      }
    }

    // Comments
    async function addComment(postId, content) {
      try {
        const postRef = doc(db, 'posts', postId);
        const postSnapshot = await getDoc(postRef);

        if (!postSnapshot.exists()) {
          throw new Error('Post does not exist!');
        }

        const postData = postSnapshot.data();

        // Use admin display name if user is admin
        const commentUserName = isAdmin(auth.currentUser.email) ? 
                               getAdminDisplayName(auth.currentUser.email) : 
                               (auth.currentUser.displayName || auth.currentUser.email);

        await addDoc(collection(db, 'posts', postId, 'comments'), {
          content: content,
          timestamp: new Date(),
          userId: auth.currentUser.uid,
          userName: commentUserName
        });

        // Add notification for the post owner if not anonymous
        if (postData.userId !== auth.currentUser.uid && !postData.isAnonymous) {
          addNotification(postData.userId, `${commentUserName} commented on your scrib.`, 'comment', postId);
        }
        
        showToast('Reply sent successfully');
        
        // Update comment count
        const tweetElement = document.querySelector(`[data-post-id="${postId}"]`);
        if (tweetElement) {
          const commentCount = tweetElement.querySelector('.comment-count');
          if (commentCount) {
            commentCount.textContent = parseInt(commentCount.textContent) + 1;
          }
        }
      } catch (error) {
        showToast(error.message);
      }
    }

    const unsubscribeMap = new Map();

    function loadComments(postId, commentsSection) {
      // Unsubscribe from previous listener for this postId if exists
      if (unsubscribeMap.has(postId)) {
        unsubscribeMap.get(postId)();
      }

      const commentsContainer = commentsSection.querySelector('.comments-container');
      const q = query(collection(db, 'posts', postId, 'comments'), orderBy('timestamp', 'asc'));
      
      const unsubscribe = onSnapshot(q, (querySnapshot) => {
        commentsContainer.innerHTML = '';
        
        if (querySnapshot.empty) {
          commentsContainer.innerHTML = '<p style="padding: 1rem 0; color: var(--text-secondary);">No replies yet. Be the first to reply!</p>';
          return;
        }
        
        querySnapshot.forEach((doc) => {
          const comment = doc.data();
          const commentElement = document.createElement('div');
          commentElement.className = 'comment';
          
          // Check if current user is admin or comment owner
          const isCurrentUserAdmin = isAdmin(auth.currentUser.email);
          const isCommentOwner = comment.userId === auth.currentUser.uid;
          
          // Check if comment user is admin to add badge
          const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
            return adminUsers[adminEmail] === comment.userName;
          });
          
          const adminBadgeHtml = isUserAdmin ? 
            `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
          
          // Check if user is online
          const isUserOnline = onlineUsers.get(comment.userId) || false;
          
          commentElement.innerHTML = `
            <div class="comment-avatar-container">
              <img src="${generateAvatarUrl(comment.userId)}" alt="Profile Picture" class="comment-avatar" data-user-id="${comment.userId}">
              <div class="comment-online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>
            </div>
            <div class="comment-content">
              <div>
                <span class="comment-user-name" data-user-id="${comment.userId}">${comment.userName}</span>
                ${adminBadgeHtml}
                <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.3rem;">${formatDate(comment.timestamp.toDate())}</span>
              </div>
              <p class="comment-text">${comment.content}</p>
              <div class="comment-actions">
                <button class="comment-action reply-btn">
                  <i class="far fa-comment"></i> Reply
                </button>
                ${isCommentOwner || isCurrentUserAdmin ? `
                  <button class="comment-action delete-comment-btn">
                    <i class="far fa-trash-alt"></i> Delete
                  </button>
                ` : ''}
                ${isCommentOwner ? `
                  <button class="comment-action edit-comment-btn">
                    <i class="far fa-edit"></i> Edit
                  </button>
                ` : ''}
                <button class="comment-action report-comment-btn">
                  <i class="far fa-flag"></i> Report
                </button>
              </div>
            </div>
          `;
          
          commentsContainer.appendChild(commentElement);

          // Event listeners for comment elements
          const commentAvatar = commentElement.querySelector('.comment-avatar');
          const commentUserName = commentElement.querySelector('.comment-user-name');
          
          commentAvatar.addEventListener('click', () => {
            loadUserProfile(commentAvatar.dataset.userId);
          });
          
          commentUserName.addEventListener('click', () => {
            loadUserProfile(commentUserName.dataset.userId);
          });

          const deleteCommentBtn = commentElement.querySelector('.delete-comment-btn');
          if (deleteCommentBtn) {
            deleteCommentBtn.addEventListener('click', () => {
              if (confirm('Are you sure you want to delete this reply?')) {
                deleteComment(postId, doc.id);
              }
            });
          }

          const editCommentBtn = commentElement.querySelector('.edit-comment-btn');
          if (editCommentBtn) {
            editCommentBtn.addEventListener('click', () => {
              const commentText = commentElement.querySelector('.comment-text');
              const currentContent = commentText.textContent;
              
              // Inline edit
              commentText.innerHTML = `
                <input type="text" value="${currentContent}" style="width: 100%; padding: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-bottom: 0.5rem; background-color: var(--secondary-color); color: var(--text-color);">
                <div style="display: flex; gap: 0.5rem;">
                  <button class="save-edit-btn" style="background-color: var(--primary-color); color: white; border: none; border-radius: var(--radius-full); padding: 0.3rem 0.8rem; cursor: pointer;">Save</button>
                  <button class="cancel-edit-btn" style="background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--radius-full); padding: 0.3rem 0.8rem; cursor: pointer; color: var(--text-color);">Cancel</button>
                </div>
              `;
              
              const saveEditBtn = commentText.querySelector('.save-edit-btn');
              const cancelEditBtn = commentText.querySelector('.cancel-edit-btn');
              const editInput = commentText.querySelector('input');
              
              saveEditBtn.addEventListener('click', () => {
                updateComment(postId, doc.id, editInput.value);
                commentText.textContent = editInput.value;
              });
              
              cancelEditBtn.addEventListener('click', () => {
                commentText.textContent = currentContent;
              });
            });
          }
          
          const reportCommentBtn = commentElement.querySelector('.report-comment-btn');
          if (reportCommentBtn) {
            reportCommentBtn.addEventListener('click', () => {
              showReportModal('comment', doc.id);
            });
          }
        });
        
        // Update online indicators
        updateOnlineIndicators();
      });
      
      unsubscribeMap.set(postId, unsubscribe);
    }

    // Comment CRUD Operations
    async function deleteComment(postId, commentId) {
      try {
        await deleteDoc(doc(db, 'posts', postId, 'comments', commentId));
        showToast('Reply deleted successfully');
        
        // Update comment count
        const tweetElement = document.querySelector(`[data-post-id="${postId}"]`);
        if (tweetElement) {
          const commentCount = tweetElement.querySelector('.comment-count');
          if (commentCount) {
            const currentCount = parseInt(commentCount.textContent);
            if (currentCount > 0) {
              commentCount.textContent = currentCount - 1;
            }
          }
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        showToast('Failed to delete reply. Please try again.');
      }
    }

    async function updateComment(postId, commentId, newContent) {
      try {
        await updateDoc(doc(db, 'posts', postId, 'comments', commentId), {
          content: newContent
        });
        showToast('Reply updated successfully');
      } catch (error) {
        console.error('Error updating comment:', error);
        showToast('Failed to update reply. Please try again.');
      }
    }

    // Notifications
    function addNotification(userId, message, type, referenceId) {
      addDoc(collection(db, 'notifications'), {
        userId: userId,
        message: message,
        type: type,
        referenceId: referenceId,
        timestamp: new Date(),
        read: false
      }).then(() => {
        console.log('Notification added successfully');
      }).catch((error) => {
        console.error('Error adding notification:', error);
      });
    }
    
    // Load Notifications
    let unsubscribeNotifications = null;
    let notificationsOpened = false;
    
    function loadNotifications() {
      if (unsubscribeNotifications) {
        unsubscribeNotifications();
      }
      
      const q = query(
        collection(db, 'notifications'),
        where('userId', '==', auth.currentUser.uid),
        orderBy('timestamp', 'desc')
      );
      
      unsubscribeNotifications = onSnapshot(q, (querySnapshot) => {
        notificationsPage.innerHTML = '';
        
        if (querySnapshot.empty) {
          notificationsPage.innerHTML = '<div style="text-align: center; padding: 2rem;">No notifications yet.</div>';
          return;
        }
        
        querySnapshot.forEach((doc) => {
          const notification = doc.data();
          const notificationElement = document.createElement('div');
          notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
          
          // Determine icon based on notification type
          let iconClass = 'fas fa-bell';
          if (notification.type === 'like') {
            iconClass = 'fas fa-heart';
          } else if (notification.type === 'comment') {
            iconClass = 'fas fa-comment';
          } else if (notification.type === 'follow') {
            iconClass = 'fas fa-user-plus';
          } else if (notification.type === 'message') {
            iconClass = 'fas fa-envelope';
          }
          
          notificationElement.innerHTML = `
            <div class="notification-icon">
              <i class="${iconClass}"></i>
            </div>
            <div class="notification-content">
              <p class="notification-text">${notification.message}</p>
              <p class="notification-time">${formatDate(notification.timestamp.toDate())}</p>
              <div class="notification-actions">
                <button class="notification-action view-btn" data-reference-id="${notification.referenceId}" data-type="${notification.type}">View</button>
                <button class="notification-action mark-read-btn">${notification.read ? 'Mark as unread' : 'Mark as read'}</button>
              </div>
            </div>
          `;
          
          notificationsPage.appendChild(notificationElement);
          
          // Event listeners for notification actions
          const viewBtn = notificationElement.querySelector('.view-btn');
          viewBtn.addEventListener('click', () => {
            // Mark as read
            updateDoc(doc(db, 'notifications', doc.id), {
              read: true
            });
            
            // Navigate to the referenced content
            if (notification.type === 'like' || notification.type === 'comment') {
              // Navigate to the post
              setActiveNavItem('home');
              showPage('home-page');
              
              // Find and highlight the post
              loadSinglePost(notification.referenceId);
            } else if (notification.type === 'follow') {
              // Navigate to the user's profile
              loadUserProfile(notification.referenceId);
            } else if (notification.type === 'message') {
              // Open message sidebar and show conversation
              openChat(notification.referenceId, 'message');
            }
          });
          
          const markReadBtn = notificationElement.querySelector('.mark-read-btn');
          markReadBtn.addEventListener('click', () => {
            updateDoc(doc(db, 'notifications', doc.id), {
              read: !notification.read
            });
          });
        });
        
        // Update notification badge
        const unreadCount = querySnapshot.docs.filter(doc => !doc.data().read).length;
        updateNotificationBadge(unreadCount);
        
        // If notifications page is open, mark all as read
        if (notificationsOpened) {
          markAllNotificationsAsRead();
        }
      });
    }
    
    // Mark all notifications as read when notifications page is opened
    function markAllNotificationsAsRead() {
      const batch = writeBatch(db);
      
      getDocs(query(
        collection(db, 'notifications'),
        where('userId', '==', auth.currentUser.uid),
        where('read', '==', false)
      )).then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          batch.update(doc.ref, { read: true });
        });
        
        batch.commit().then(() => {
          updateNotificationBadge(0);
        });
      });
    }
    
    // Update notification badge
    function updateNotificationBadge(count) {
      // Remove existing badges
      const existingBadges = document.querySelectorAll('.notification-badge');
      existingBadges.forEach(badge => badge.remove());
      
      if (count > 0 && !notificationsOpened) {
        // Add badge to notification links
        const notificationLinks = [notificationsLink, mobileNotifications];
        notificationLinks.forEach(link => {
          const iconContainer = link.querySelector('i').parentElement;
          iconContainer.style.position = 'relative';
          
          const badge = document.createElement('span');
          badge.className = 'notification-badge';
          badge.style.cssText = `
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error-color);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.1rem 0.4rem;
            border-radius: var(--radius-full);
            transform: translate(50%, -50%);
          `;
          badge.textContent = count > 9 ? '9+' : count;
          iconContainer.appendChild(badge);
        });
      }
    }
    
    // Load Messages
    let unsubscribeMessages = null;
    
    function loadMessages() {
      if (unsubscribeMessages) {
        unsubscribeMessages();
      }
      
      const userId = auth.currentUser.uid;
      
      // Query for messages where user is sender or receiver
      const q = query(
        collection(db, 'messages'),
        orderBy('timestamp', 'desc')
      );
      
      unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
        // Clear message lists
        const container = messageSidebarList;
        const pageContainer = messageList;
        
        container.innerHTML = '';
        pageContainer.innerHTML = '';
        
        if (querySnapshot.empty) {
          const emptyMessage = 'No messages yet. Start a conversation!';
          
          container.innerHTML = `<div style="text-align: center; padding: 2rem;">${emptyMessage}</div>`;
          pageContainer.innerHTML = `<div style="text-align: center; padding: 2rem;">${emptyMessage}</div>`;
          return;
        }
        
        // Group messages by conversation (user)
        const conversations = new Map();
        
        querySnapshot.forEach(doc => {
          const message = doc.data();
          
          // Only include conversations where the current user is involved
          if (message.senderId === userId || message.receiverId === userId) {
            // Determine the other user in the conversation
            const otherUserId = message.senderId === userId ? message.receiverId : message.senderId;
            
            if (!conversations.has(otherUserId)) {
              conversations.set(otherUserId, {
                userId: otherUserId,
                messages: [],
                lastMessage: null,
                unreadCount: 0
              });
            }
            
            const conversation = conversations.get(otherUserId);
            conversation.messages.push({
              id: doc.id,
              ...message
            });
            
            // Update last message
            if (!conversation.lastMessage || message.timestamp.toDate() > conversation.lastMessage.timestamp.toDate()) {
              conversation.lastMessage = {
                id: doc.id,
                ...message
              };
            }
            
            // Count unread messages
            if (message.receiverId === userId && !message.read) {
              conversation.unreadCount++;
            }
          }
        });
        
        // Sort conversations by last message timestamp
        const sortedConversations = Array.from(conversations.values())
          .sort((a, b) => b.lastMessage.timestamp.toDate() - a.lastMessage.timestamp.toDate());
        
        // Render conversations
        sortedConversations.forEach(conversation => {
          // Get user data for the other user
          getDoc(doc(db, 'users', conversation.userId)).then(userDoc => {
            if (userDoc.exists()) {
              const userData = userDoc.data();
              const lastMessage = conversation.lastMessage;
              const isUserOnline = onlineUsers.get(conversation.userId) || false;
              
              // Create message item for sidebar
              const messageItem = document.createElement('div');
              messageItem.className = 'message-item';
              messageItem.dataset.userId = conversation.userId;
              
              // Format last message preview
              let messagePreview = lastMessage.text;
              if (messagePreview.length > 25) {
                messagePreview = messagePreview.substring(0, 25) + '...';
              }
              
              // Format time
              const messageTime = formatDate(lastMessage.timestamp.toDate());
              
              messageItem.innerHTML = `
                <div class="message-avatar-container">
                  <img src="${userData.photoURL || generateAvatarUrl(conversation.userId)}" alt="Profile Picture" class="message-avatar" data-user-id="${conversation.userId}">
                  <div class="message-online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>
                </div>
                <div class="message-info">
                  <div class="message-name">${userData.displayName}</div>
                  <div class="message-preview">${messagePreview}</div>
                </div>
                ${conversation.unreadCount > 0 ? 
                  `<div class="message-unread-badge">${conversation.unreadCount}</div>` : 
                  `<div class="message-time" data-user-id="${conversation.userId}">${messageTime}</div>`
                }
              `;
              
              // Add click event to open chat
              messageItem.addEventListener('click', () => {
                openChat(conversation.userId, 'message');
              });
              
              // Add to sidebar and page containers
              container.appendChild(messageItem.cloneNode(true));
              pageContainer.appendChild(messageItem);
              
              // Add click event to page container item
              const pageItem = pageContainer.lastElementChild;
              pageItem.addEventListener('click', () => {
                openChat(conversation.userId, 'message');
              });
              
              // Update online indicators
              updateOnlineIndicators();
              updateLastActiveTimestamps();
            }
          });
        });
      });
    }
    
    // Open Chat
    function openChat(userId, type = 'message') {
      currentChatUser = userId;
      currentChatType = 'message'; // Always use 'message' type since poke is now equivalent to message
      
      // Show message sidebar
      toggleMessageSidebar(true);
      
      // Show chat view
      messageChat.classList.add('show');
      
      // Update chat header
      getDoc(doc(db, 'users', userId)).then(userDoc => {
        if (userDoc.exists()) {
          const userData = userDoc.data();
          chatUserName.textContent = userData.displayName;
          
          // Update online status
          const isUserOnline = onlineUsers.get(userId) || false;
          if (isUserOnline) {
            chatUserStatus.textContent = 'Online';
            chatUserStatus.style.color = 'var(--online-color)';
          } else if (lastActiveTimestamps.has(userId)) {
            const lastActive = lastActiveTimestamps.get(userId);
            chatUserStatus.textContent = `Last active: ${formatLastActive(lastActive)}`;
            chatUserStatus.style.color = 'var(--text-secondary)';
          } else {
            chatUserStatus.textContent = 'Offline';
            chatUserStatus.style.color = 'var(--text-secondary)';
          }
        }
      });
      
      // Load chat messages
      loadChatMessages(userId);
      
      // Mark messages as read
      markMessagesAsRead(userId);
    }
    
    // Load Chat Messages
    let unsubscribeChatMessages = null;
    
    function loadChatMessages(userId) {
      if (unsubscribeChatMessages) {
        unsubscribeChatMessages();
      }
      
      chatMessages.innerHTML = '';
      
      // Query for messages between current user and selected user
      const q = query(
        collection(db, 'messages'),
        orderBy('timestamp', 'asc')
      );
      
      unsubscribeChatMessages = onSnapshot(q, (querySnapshot) => {
        // Clear chat messages
        chatMessages.innerHTML = '';
        
        // Filter messages for this conversation
        const messages = [];
        querySnapshot.forEach(doc => {
          const message = doc.data();
          if ((message.senderId === auth.currentUser.uid && message.receiverId === userId) ||
              (message.senderId === userId && message.receiverId === auth.currentUser.uid)) {
            messages.push({
              id: doc.id,
              ...message
            });
          }
        });
        
        // Sort messages by timestamp
        messages.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
        
        // Render messages
        messages.forEach(message => {
          const isSent = message.senderId === auth.currentUser.uid;
          const messageElement = document.createElement('div');
          messageElement.className = `chat-message ${isSent ? 'sent' : 'received'}`;
          
          // Format time
          const messageTime = formatDate(message.timestamp.toDate());
          
          messageElement.innerHTML = `
            <div class="chat-message-text">${message.text}</div>
            <div class="chat-message-time">${messageTime}</div>
          `;
          
          chatMessages.appendChild(messageElement);
        });
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Mark messages as read
        markMessagesAsRead(userId);
      });
    }
    
    // Mark Messages as Read
    function markMessagesAsRead(userId) {
      // Get unread messages from this user
      const q = query(
        collection(db, 'messages'),
        where('senderId', '==', userId),
        where('receiverId', '==', auth.currentUser.uid),
        where('read', '==', false)
      );
      
      getDocs(q).then(querySnapshot => {
        const batch = writeBatch(db);
        
        querySnapshot.forEach(doc => {
          batch.update(doc.ref, { read: true });
        });
        
        if (!querySnapshot.empty) {
          batch.commit();
        }
      });
    }
    
    // Load single post
    async function loadSinglePost(postId) {
      try {
        const postDoc = await getDoc(doc(db, 'posts', postId));
        
        if (!postDoc.exists()) {
          showToast('Post not found');
          return;
        }
        
        setActiveNavItem('home');
        showPage('home-page');
        
        tweetsContainer.innerHTML = '';
        
        const post = postDoc.data();
        const tweetElement = document.createElement('div');
        tweetElement.className = 'tweet';
        if (post.isAnonymous) {
          tweetElement.classList.add('anonymous-post');
        }
        tweetElement.dataset.postId = postDoc.id;
        
        // Check if current user is admin or post owner
        const isCurrentUserAdmin = isAdmin(auth.currentUser.email);
        const isPostOwner = post.userId === auth.currentUser.uid;
        
        // Determine if delete/edit buttons should be shown
        const showDeleteButton = isCurrentUserAdmin || isPostOwner;
        const showEditButton = isPostOwner;
        
        // Format date
        const postDate = post.timestamp?.toDate();
        const formattedDate = postDate ? formatDate(postDate) : '';
        
        // Check if user is admin to add badge
        const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
          return adminUsers[adminEmail] === post.userName;
        });
        
        const adminBadgeHtml = isUserAdmin ? 
          `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
        
        // Create tags HTML
        const tagsHtml = post.tags && post.tags.length > 0 ? 
          post.tags.map(tag => `<span class="tweet-tag">${tag}</span>`).join('') : '';
        
        // Create images HTML if post has images
        let imagesHtml = '';
        if (post.imageUrls && post.imageUrls.length > 0) {
          imagesHtml = '<div class="tweet-images">';
          post.imageUrls.forEach(imageUrl => {
            imagesHtml += `<img src="${imageUrl}" alt="Post image" class="tweet-image" data-full-image="${imageUrl}">`;
          });
          imagesHtml += '</div>';
        } else if (post.imageUrl) {
          // For backward compatibility with old posts
          imagesHtml = `<img src="${post.imageUrl}" alt="Post image" class="tweet-image" data-full-image="${post.imageUrl}">`;
        }
        
        // Check if user is online
        const isUserOnline = onlineUsers.get(post.userId) || false;
        
        // Get last active time
        let lastActiveHtml = '';
        if (!isUserOnline && lastActiveTimestamps.has(post.userId)) {
          const lastActive = lastActiveTimestamps.get(post.userId);
          lastActiveHtml = `<div class="last-active" data-user-id="${post.userId}">Last active: ${formatLastActive(lastActive)}</div>`;
        }
        
        // Handle anonymous posts
        const avatarHtml = post.isAnonymous ? 
          generateIncognitoAvatar() : 
          `<img src="${generateAvatarUrl(post.userId)}" alt="Profile Picture" class="tweet-avatar" data-user-id="${post.userId}">`;
        
        const userNameHtml = post.isAnonymous ? 
          `<p class="tweet-user-name">Anonymous</p>` : 
          `<p class="tweet-user-name" data-user-id="${post.userId}">${post.userName}</p>${adminBadgeHtml}`;
        
        const userHandleHtml = post.isAnonymous ? 
          `<span class="tweet-user-handle">@anonymous</span>` : 
          `<span class="tweet-user-handle">@${post.userName.toLowerCase().replace(/\s+/g, '')}</span>`;
        
        tweetElement.innerHTML = `
          <div class="tweet-header">
            <div class="tweet-avatar-container">
              ${avatarHtml}
              ${!post.isAnonymous ? `<div class="online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>` : ''}
            </div>
            <div class="tweet-user-info">
              <div>
                ${userNameHtml}
                ${userHandleHtml}
              </div>
              <p class="tweet-time">${formattedDate}</p>
              ${!post.isAnonymous ? lastActiveHtml : ''}
            </div>
            ${showDeleteButton || showEditButton ? `
              <div class="tweet-more-container" style="position: relative;">
                <button class="tweet-more">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="tweet-dropdown" style="position: absolute; right: 0; top: 30px; background: var(--secondary-color); border-radius: var(--radius-md); box-shadow: var(--shadow-md); width: 150px; z-index: 10; display: none;">
                  ${showEditButton ? `
                    <div class="dropdown-item edit-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                      <i class="fas fa-edit" style="margin-right: 0.8rem;"></i> Edit
                    </div>
                  ` : ''}
                  ${showDeleteButton ? `
                    <div class="dropdown-item delete-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer; color: var(--error-color);">
                      <i class="fas fa-trash" style="margin-right: 0.8rem;"></i> Delete
                    </div>
                  ` : ''}
                  <div class="dropdown-item report-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                    <i class="fas fa-flag" style="margin-right: 0.8rem;"></i> Report
                  </div>
                </div>
              </div>
            ` : `
              <div class="tweet-more-container" style="position: relative;">
                <button class="tweet-more">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="tweet-dropdown" style="position: absolute; right: 0; top: 30px; background: var(--secondary-color); border-radius: var(--radius-md); box-shadow: var(--shadow-md); width: 150px; z-index: 10; display: none;">
                  <div class="dropdown-item report-tweet-btn" style="padding: 0.8rem 1rem; display: flex; align-items: center; cursor: pointer;">
                    <i class="fas fa-flag" style="margin-right: 0.8rem;"></i> Report
                  </div>
                </div>
              </div>
            `}
          </div>
          <div class="tweet-content">
            <h3 class="tweet-title">${post.title}</h3>
            <p class="tweet-text">${post.content}</p>
            ${imagesHtml}
            <div style="margin-top: 0.8rem;">
              <span class="tweet-category">${post.category}</span>
              ${tagsHtml}
            </div>
          </div>
          <div class="tweet-actions">
            <button class="tweet-action comment-btn">
              <i class="far fa-comment"></i>
              <span class="comment-count">0</span>
            </button>
            <button class="tweet-action like-btn ${post.likedBy?.includes(auth.currentUser.uid) ? 'liked' : ''}">
              <i class="${post.likedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-heart"></i>
              <span class="like-count">${post.likes || 0}</span>
            </button>
            <button class="tweet-action dislike-btn ${post.dislikedBy?.includes(auth.currentUser.uid) ? 'disliked' : ''}">
              <i class="${post.dislikedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-thumbs-down"></i>
              <span class="dislike-count">${post.dislikes || 0}</span>
            </button>
            <button class="tweet-action share-btn">
              <i class="far fa-share-square"></i>
            </button>
          </div>
          <div class="comments-section">
            <div class="comments-container"></div>
            <form class="comment-form">
              <input type="text" class="comment-input" placeholder="Scrib your reply">
              <button type="submit" class="comment-submit">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          </div>
        `;
        
        tweetsContainer.appendChild(tweetElement);
        
        // Get comments count
        getCommentsCount(postDoc.id).then(count => {
          const commentCount = tweetElement.querySelector('.comment-count');
          if (commentCount) {
            commentCount.textContent = count;
          }
        });
        
        // Add event listeners
        if (!post.isAnonymous) {
          const tweetAvatar = tweetElement.querySelector('.tweet-avatar');
          const tweetUserName = tweetElement.querySelector('.tweet-user-name');
          
          if (tweetAvatar) {
            tweetAvatar.addEventListener('click', () => {
              loadUserProfile(tweetAvatar.dataset.userId);
            });
          }
          
          if (tweetUserName) {
            tweetUserName.addEventListener('click', () => {
              loadUserProfile(tweetUserName.dataset.userId);
            });
          }
        }
        
        // Image click event for lightbox
        const tweetImages = tweetElement.querySelectorAll('.tweet-image');
        if (tweetImages.length > 0) {
          tweetImages.forEach(img => {
            img.addEventListener('click', () => {
              lightboxImage.src = img.dataset.fullImage;
              lightboxOverlay.style.display = 'flex';
            });
          });
        }
        
        const commentsSection = tweetElement.querySelector('.comments-section');
        const commentBtn = tweetElement.querySelector('.comment-btn');
        commentBtn.addEventListener('click', () => {
          commentsSection.classList.toggle('show');
          if (commentsSection.classList.contains('show')) {
            loadComments(postDoc.id, commentsSection);
          }
        });
        
        const commentForm = tweetElement.querySelector('.comment-form');
        commentForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const commentInput = commentForm.querySelector('.comment-input');
          const commentContent = commentInput.value.trim();
          if (commentContent) {
            addComment(postDoc.id, commentContent);
            commentInput.value = '';
          } else {
            showToast('Comment cannot be empty');
          }
        });
        
        const tweetMore = tweetElement.querySelector('.tweet-more');
        const tweetDropdown = tweetElement.querySelector('.tweet-dropdown');
        
        if (tweetMore && tweetDropdown) {
          tweetMore.addEventListener('click', (e) => {
            e.stopPropagation();
            tweetDropdown.style.display = tweetDropdown.style.display === 'block' ? 'none' : 'block';
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            if (tweetDropdown) {
              tweetDropdown.style.display = 'none';
            }
          });
          
          const deleteBtn = tweetElement.querySelector('.delete-tweet-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
              if (confirm('Are you sure you want to delete this scrib?')) {
                deletePost(postDoc.id, post.imageUrls || (post.imageUrl ? [post.imageUrl] : []));
              }
            });
          }
          
          const editBtn = tweetElement.querySelector('.edit-tweet-btn');
          if (editBtn) {
            editBtn.addEventListener('click', () => {
              showEditModal(postDoc.id, post.title, post.content, post.imageUrls || (post.imageUrl ? [post.imageUrl] : []));
            });
          }
          
          const reportBtn = tweetElement.querySelector('.report-tweet-btn');
          if (reportBtn) {
            reportBtn.addEventListener('click', () => {
              showReportModal('post', postDoc.id);
            });
          }
        }
        
        const likeBtn = tweetElement.querySelector('.like-btn');
        const dislikeBtn = tweetElement.querySelector('.dislike-btn');
        
        likeBtn.addEventListener('click', async () => {
          if (likeBtn.disabled) return;
          likeBtn.disabled = true;
          dislikeBtn.disabled = true;
          
          try {
            await handleLike(postDoc.id);
            
            // Update UI immediately for better user experience
            const likeIcon = likeBtn.querySelector('i');
            const likeCount = likeBtn.querySelector('.like-count');
            const dislikeIcon = dislikeBtn.querySelector('i');
            const dislikeCount = dislikeBtn.querySelector('.dislike-count');
            
            if (likeBtn.classList.contains('liked')) {
              // Unlike
              likeBtn.classList.remove('liked');
              likeIcon.className = 'far fa-heart';
              likeCount.textContent = parseInt(likeCount.textContent) - 1;
            } else {
              // Like
              likeBtn.classList.add('liked');
              likeIcon.className = 'fas fa-heart';
              likeCount.textContent = parseInt(likeCount.textContent) + 1;
              
              // If was disliked, remove dislike
              if (dislikeBtn.classList.contains('disliked')) {
                dislikeBtn.classList.remove('disliked');
                dislikeIcon.className = 'far fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
              }
            }
          } catch (error) {
            console.error('Error updating like:', error);
            showToast('Failed to update like. Please try again.');
          } finally {
            likeBtn.disabled = false;
            dislikeBtn.disabled = false;
          }
        });
        
        dislikeBtn.addEventListener('click', async () => {
          if (dislikeBtn.disabled) return;
          dislikeBtn.disabled = true;
          likeBtn.disabled = true;
          
          try {
            await handleDislike(postDoc.id);
            
            // Update UI immediately for better user experience
            const dislikeIcon = dislikeBtn.querySelector('i');
            const dislikeCount = dislikeBtn.querySelector('.dislike-count');
            const likeIcon = likeBtn.querySelector('i');
            const likeCount = likeBtn.querySelector('.like-count');
            
            if (dislikeBtn.classList.contains('disliked')) {
              // Undislike
              dislikeBtn.classList.remove('disliked');
              dislikeIcon.className = 'far fa-thumbs-down';
              dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
            } else {
              // Dislike
              dislikeBtn.classList.add('disliked');
              dislikeIcon.className = 'fas fa-thumbs-down';
              dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
              
              // If was liked, remove like
              if (likeBtn.classList.contains('liked')) {
                likeBtn.classList.remove('liked');
                likeIcon.className = 'far fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
              }
            }
          } catch (error) {
            console.error('Error updating dislike:', error);
            showToast('Failed to update dislike. Please try again.');
          } finally {
            dislikeBtn.disabled = false;
            likeBtn.disabled = false;
          }
        });
        
        const shareBtn = tweetElement.querySelector('.share-btn');
        shareBtn.addEventListener('click', () => {
          // Simple share functionality - copy URL to clipboard
          const url = window.location.href.split('?')[0] + '?post=' + postDoc.id;
          navigator.clipboard.writeText(url).then(() => {
            showToast('Link copied to clipboard!');
          });
        });
        
        // Highlight the post
        tweetElement.style.backgroundColor = 'rgba(230, 81, 0, 0.05)';
        setTimeout(() => {
          tweetElement.style.backgroundColor = '';
        }, 2000);
        
        // Automatically open comments section
        commentBtn.click();
        
        // Update online indicators and last active timestamps
        updateOnlineIndicators();
        updateLastActiveTimestamps();
        
      } catch (error) {
        console.error('Error loading post:', error);
        showToast('Error loading post');
      }
    }

    // Search Functionality
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    function performSearch() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      if (searchTerm) {
        Promise.resolve().then(async () => {
          try {
            // Search in posts (title)
            const postsTitleQuery = query(
              collection(db, 'posts'),
              orderBy('title'),
              where('title', '>=', searchTerm),
              where('title', '<=', searchTerm + '\uf8ff')
            );
            
            // Search in posts (content)
            const postsContentQuery = query(
              collection(db, 'posts'),
              orderBy('content'),
              where('content', '>=', searchTerm),
              where('content', '<=', searchTerm + '\uf8ff')
            );
            
            // Search in posts (tags)
            const postsTagsQuery = query(
              collection(db, 'posts'),
              where('tags', 'array-contains', searchTerm)
            );

            const [postsTitleSnapshot, postsContentSnapshot, postsTagsSnapshot] = await Promise.all([
              getDocs(postsTitleQuery),
              getDocs(postsContentQuery),
              getDocs(postsTagsQuery)
            ]);

            // Combine post results and remove duplicates
            const postResults = new Map();
            
            function addPostToResults(doc) {
              if (!postResults.has(doc.id)) {
                postResults.set(doc.id, { id: doc.id, ...doc.data() });
              }
            }
            
            postsTitleSnapshot.forEach(addPostToResults);
            postsContentSnapshot.forEach(addPostToResults);
            postsTagsSnapshot.forEach(addPostToResults);

            // Display results
            tweetsContainer.innerHTML = '';
            
            pageTitle.textContent = `Search: ${searchTerm}`;
            
            if (postResults.size === 0) {
              tweetsContainer.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">No results found. Try a different search term.</p></div>';
              return;
            }
            
            // Convert Map to Array and sort by timestamp
            const sortedResults = Array.from(postResults.values())
              .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
            
            sortedResults.forEach(post => {
              const tweetElement = document.createElement('div');
              tweetElement.className = 'tweet';
              if (post.isAnonymous) {
                tweetElement.classList.add('anonymous-post');
              }
              tweetElement.dataset.postId = post.id;
              
              // Format date
              const postDate = post.timestamp?.toDate();
              const formattedDate = postDate ? formatDate(postDate) : '';
              
              // Check if user is admin to add badge
              const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
                return adminUsers[adminEmail] === post.userName;
              });
              
              const adminBadgeHtml = isUserAdmin ? 
                `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
              
              // Create tags HTML
              const tagsHtml = post.tags && post.tags.length > 0 ? 
                post.tags.map(tag => `<span class="tweet-tag">${tag}</span>`).join('') : '';
              
              // Create images HTML if post has images
              let imagesHtml = '';
              if (post.imageUrls && post.imageUrls.length > 0) {
                imagesHtml = '<div class="tweet-images">';
                post.imageUrls.forEach(imageUrl => {
                  imagesHtml += `<img src="${imageUrl}" alt="Post image" class="tweet-image" data-full-image="${imageUrl}">`;
                });
                imagesHtml += '</div>';
              } else if (post.imageUrl) {
                // For backward compatibility with old posts
                imagesHtml = `<img src="${post.imageUrl}" alt="Post image" class="tweet-image" data-full-image="${post.imageUrl}">`;
              }
              
              // Check if user is online
              const isUserOnline = onlineUsers.get(post.userId) || false;
              
              // Handle anonymous posts
              const avatarHtml = post.isAnonymous ? 
                generateIncognitoAvatar() : 
                `<img src="${generateAvatarUrl(post.userId)}" alt="Profile Picture" class="tweet-avatar" data-user-id="${post.userId}">`;
              
              const userNameHtml = post.isAnonymous ? 
                `<p class="tweet-user-name">Anonymous</p>` : 
                `<p class="tweet-user-name" data-user-id="${post.userId}">${post.userName}</p>${adminBadgeHtml}`;
              
              const userHandleHtml = post.isAnonymous ? 
                `<span class="tweet-user-handle">@anonymous</span>` : 
                `<span class="tweet-user-handle">@${post.userName.toLowerCase().replace(/\s+/g, '')}</span>`;
              
              tweetElement.innerHTML = `
                <div class="tweet-header">
                  <div class="tweet-avatar-container">
                    ${avatarHtml}
                    ${!post.isAnonymous ? `<div class="online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>` : ''}
                  </div>
                  <div class="tweet-user-info">
                    <div>
                      ${userNameHtml}
                      ${userHandleHtml}
                    </div>
                    <p class="tweet-time">${formattedDate}</p>
                  </div>
                </div>
                <div class="tweet-content">
                  <h3 class="tweet-title">${post.title}</h3>
                  <p class="tweet-text">${post.content}</p>
                  ${imagesHtml}
                  <div style="margin-top: 0.8rem;">
                    <span class="tweet-category">${post.category}</span>
                    ${tagsHtml}
                  </div>
                </div>
                <div class="tweet-actions">
                  <button class="tweet-action comment-btn">
                    <i class="far fa-comment"></i>
                    <span class="comment-count">0</span>
                  </button>
                  <button class="tweet-action like-btn ${post.likedBy?.includes(auth.currentUser.uid) ? 'liked' : ''}">
                    <i class="${post.likedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-heart"></i>
                    <span class="like-count">${post.likes || 0}</span>
                  </button>
                  <button class="tweet-action dislike-btn ${post.dislikedBy?.includes(auth.currentUser.uid) ? 'disliked' : ''}">
                    <i class="${post.dislikedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-thumbs-down"></i>
                    <span class="dislike-count">${post.dislikes || 0}</span>
                  </button>
                  <button class="tweet-action share-btn">
                    <i class="far fa-share-square"></i>
                  </button>
                </div>
              `;
              
              tweetsContainer.appendChild(tweetElement);
              
              // Add event listeners
              if (!post.isAnonymous) {
                const tweetAvatar = tweetElement.querySelector('.tweet-avatar');
                const tweetUserName = tweetElement.querySelector('.tweet-user-name');
                
                if (tweetAvatar) {
                  tweetAvatar.addEventListener('click', () => {
                    loadUserProfile(tweetAvatar.dataset.userId);
                  });
                }
                
                if (tweetUserName) {
                  tweetUserName.addEventListener('click', () => {
                    loadUserProfile(tweetUserName.dataset.userId);
                  });
                }
              }
              
              // Image click event for lightbox
              const tweetImages = tweetElement.querySelectorAll('.tweet-image');
              if (tweetImages.length > 0) {
                tweetImages.forEach(img => {
                  img.addEventListener('click', () => {
                    lightboxImage.src = img.dataset.fullImage;
                    lightboxOverlay.style.display = 'flex';
                  });
                });
              }
              
              // Get comments count
              getCommentsCount(post.id).then(count => {
                const commentCount = tweetElement.querySelector('.comment-count');
                if (commentCount) {
                  commentCount.textContent = count;
                }
              });
              
              // Add like/dislike event listeners
              const likeBtn = tweetElement.querySelector('.like-btn');
              const dislikeBtn = tweetElement.querySelector('.dislike-btn');
              
              likeBtn.addEventListener('click', async () => {
                if (likeBtn.disabled) return;
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
                
                try {
                  await handleLike(post.id);
                  
                  // Update UI immediately
                  const likeIcon = likeBtn.querySelector('i');
                  const likeCount = likeBtn.querySelector('.like-count');
                  const dislikeIcon = dislikeBtn.querySelector('i');
                  const dislikeCount = dislikeBtn.querySelector('.dislike-count');
                  
                  if (likeBtn.classList.contains('liked')) {
                    // Unlike
                    likeBtn.classList.remove('liked');
                    likeIcon.className = 'far fa-heart';
                    likeCount.textContent = parseInt(likeCount.textContent) - 1;
                  } else {
                    // Like
                    likeBtn.classList.add('liked');
                    likeIcon.className = 'fas fa-heart';
                    likeCount.textContent = parseInt(likeCount.textContent) + 1;
                    
                    // If was disliked, remove dislike
                    if (dislikeBtn.classList.contains('disliked')) {
                      dislikeBtn.classList.remove('disliked');
                      dislikeIcon.className = 'far fa-thumbs-down';
                      dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
                    }
                  }
                } catch (error) {
                  console.error('Error updating like:', error);
                  showToast('Failed to update like. Please try again.');
                } finally {
                  likeBtn.disabled = false;
                  dislikeBtn.disabled = false;
                }
              });
              
              dislikeBtn.addEventListener('click', async () => {
                if (dislikeBtn.disabled) return;
                dislikeBtn.disabled = true;
                likeBtn.disabled = true;
                
                try {
                  await handleDislike(post.id);
                  
                  // Update UI immediately
                  const dislikeIcon = dislikeBtn.querySelector('i');
                  const dislikeCount = dislikeBtn.querySelector('.dislike-count');
                  const likeIcon = likeBtn.querySelector('i');
                  const likeCount = likeBtn.querySelector('.like-count');
                  
                  if (dislikeBtn.classList.contains('disliked')) {
                    // Undislike
                    dislikeBtn.classList.remove('disliked');
                    dislikeIcon.className = 'far fa-thumbs-down';
                    dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
                  } else {
                    // Dislike
                    dislikeBtn.classList.add('disliked');
                    dislikeIcon.className = 'fas fa-thumbs-down';
                    dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
                    
                    // If was liked, remove like
                    if (likeBtn.classList.contains('liked')) {
                      likeBtn.classList.remove('liked');
                      likeIcon.className = 'far fa-heart';
                      likeCount.textContent = parseInt(likeCount.textContent) - 1;
                    }
                  }
                } catch (error) {
                  console.error('Error updating dislike:', error);
                  showToast('Failed to update dislike. Please try again.');
                } finally {
                  dislikeBtn.disabled = false;
                  likeBtn.disabled = false;
                }
              });
              
              // Add comment button event listener
              const commentsSection = tweetElement.querySelector('.comments-section');
              const commentBtn = tweetElement.querySelector('.comment-btn');
              commentBtn.addEventListener('click', () => {
                commentsSection.classList.toggle('show');
                if (commentsSection.classList.contains('show')) {
                  loadComments(post.id, commentsSection);
                }
              });
            });
            
          } catch (error) {
            console.error('Search error:', error);
            showToast('Search error: ' + error.message);
          }
        });
      } else {
        showToast('Please enter a search term');
      }
    }

    // Load User Profile
    async function loadUserProfile(userId) {
      try {
        // Update UI to show profile view
        pageTitle.textContent = 'Profile';
        setActiveNavItem('profile');
        showPage('profile-page');
        
        // Get user data
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (!userDoc.exists()) {
          showToast('User not found');
          return;
        }
        
        const userData = userDoc.data();
        
        // Update profile UI
        profileAvatar.src = userData.photoURL || generateAvatarUrl(userId);
        profileAvatar.dataset.userId = userId;
        profileName.textContent = userData.displayName;
        profileHandle.textContent = `@${(userData.displayName || userData.email || 'anonymous').toLowerCase().replace(/\s+/g, '')}`;
        profileBio.textContent = userData.bio || 'No bio yet.';
        
        // Update online status
        const isUserOnline = onlineUsers.get(userId) || false;
        profileOnlineIndicator.style.display = isUserOnline ? 'block' : 'none';
        
        // Update last active
        if (isUserOnline) {
          profileLastActive.textContent = 'Online now';
        } else if (lastActiveTimestamps.has(userId)) {
          const lastActive = lastActiveTimestamps.get(userId);
          profileLastActive.textContent = `Last active: ${formatLastActive(lastActive)}`;
        } else {
          profileLastActive.textContent = '';
        }
        
        // Get post count
        const postsQuery = query(collection(db, 'posts'), where('userId', '==', userId));
        const postsSnapshot = await getDocs(postsQuery);
        profilePostsCount.textContent = postsSnapshot.size;
        
        // Get followers and following counts
        profileFollowersCount.textContent = userData.followers?.length || 0;
        profileFollowingCount.textContent = userData.following?.length || 0;
        
        // Update profile actions
        if (userId === auth.currentUser.uid) {
          // Own profile
          profileActions.innerHTML = `
            <button class="profile-action-btn profile-action-primary" id="edit-profile-btn">Edit Profile</button>
          `;
          
          const editProfileBtn = document.getElementById('edit-profile-btn');
          editProfileBtn.addEventListener('click', () => {
            // Navigate to settings
            setActiveNavItem('settings');
            showPage('settings-page');
            
            // Load current settings
            loadUserSettings();
          });
        } else {
          // Other user's profile
          const isFollowing = userData.followers?.includes(auth.currentUser.uid) || false;
          
          profileActions.innerHTML = `
            <button class="profile-action-btn profile-action-primary" id="follow-btn">${isFollowing ? 'Following' : 'Follow'}</button>
            <button class="profile-action-btn profile-action-secondary" id="message-btn">
              <i class="fas fa-envelope"></i> Message
            </button>
            <button class="profile-action-btn profile-action-secondary" id="report-user-btn">
              <i class="fas fa-flag"></i> Report
            </button>
          `;
          
          const followBtn = document.getElementById('follow-btn');
          followBtn.addEventListener('click', () => {
            toggleFollow(userId, isFollowing);
          });
          
          const messageBtn = document.getElementById('message-btn');
          messageBtn.addEventListener('click', () => {
            openChat(userId, 'message');
          });
          
          const reportUserBtn = document.getElementById('report-user-btn');
          reportUserBtn.addEventListener('click', () => {
            showReportModal('user', userId);
          });
        }
        
        // Set up profile tabs
        profileTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            profileTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const tabName = tab.dataset.tab;
            
            if (tabName === 'posts') {
              // Load user's posts
              loadPosts(userId);
            } else if (tabName === 'likes') {
              // Load user's liked posts
              loadLikedPosts(userId);
            } else if (tabName === 'media') {
              // Load user's media posts (posts with images)
              loadMediaPosts(userId);
            }
          });
        });
        
        // Set up followers/following click events
        const followersStats = document.querySelector('.followers-stat');
        followersStats.addEventListener('click', () => {
          showFollowersModal(userId);
        });
        
        const followingStats = document.querySelector('.following-stat');
        followingStats.addEventListener('click', () => {
          showFollowingModal(userId);
        });
        
        // Load user's posts by default
        loadPosts(userId);
        
      } catch (error) {
        console.error('Error loading user profile:', error);
        showToast('Error loading user profile');
      }
    }
    
    // Toggle Follow
    async function toggleFollow(userId, isCurrentlyFollowing) {
      try {
        const currentUserId = auth.currentUser.uid;
        
        // Prevent multiple clicks
        const followBtn = document.getElementById('follow-btn');
        if (followBtn) {
          followBtn.disabled = true;
        }
        
        const batch = writeBatch(db);
        
        // Update target user's followers
        const targetUserRef = doc(db, 'users', userId);
        
        // Update current user's following
        const currentUserRef = doc(db, 'users', currentUserId);
        
        if (isCurrentlyFollowing) {
          // Unfollow
          batch.update(targetUserRef, {
            followers: arrayRemove(currentUserId)
          });
          
          batch.update(currentUserRef, {
            following: arrayRemove(userId)
          });
          
          await batch.commit();
          
          // Update UI
          if (followBtn) {
            followBtn.textContent = 'Follow';
            followBtn.disabled = false;
          }
          
          // Update follower count
          const currentCount = parseInt(profileFollowersCount.textContent);
          profileFollowersCount.textContent = currentCount - 1;
          
          showToast('Unfollowed successfully');
        } else {
          // Follow
          batch.update(targetUserRef, {
            followers: arrayUnion(currentUserId)
          });
          
          batch.update(currentUserRef, {
            following: arrayUnion(userId)
          });
          
          await batch.commit();
          
          // Add notification
          addNotification(userId, `${auth.currentUser.displayName || auth.currentUser.email} started following you.`, 'follow', currentUserId);
          
          // Update UI
          if (followBtn) {
            followBtn.textContent = 'Following';
            followBtn.disabled = false;
          }
          
          // Update follower count
          const currentCount = parseInt(profileFollowersCount.textContent);
          profileFollowersCount.textContent = currentCount + 1;
          
          showToast('Following successfully');
        }
      } catch (error) {
        console.error('Error toggling follow:', error);
        showToast('Error updating follow status');
        
        // Re-enable button on error
        const followBtn = document.getElementById('follow-btn');
        if (followBtn) {
          followBtn.disabled = false;
        }
      }
    }
    
    // Load Liked Posts
    async function loadLikedPosts(userId) {
      try {
        profileTweetsContainer.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading liked posts...</div>';
        
        // Get all posts
        const postsQuery = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
        const postsSnapshot = await getDocs(postsQuery);
        
        // Filter posts liked by the user
        const likedPosts = postsSnapshot.docs.filter(doc => {
          const post = doc.data();
          return post.likedBy && post.likedBy.includes(userId);
        });
        
        if (likedPosts.length === 0) {
          profileTweetsContainer.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">No liked posts found.</p></div>';
          return;
        }
        
        profileTweetsContainer.innerHTML = '';
        
        // Render liked posts
        likedPosts.forEach(doc => {
          const post = doc.data();
          const tweetElement = document.createElement('div');
          tweetElement.className = 'tweet';
          if (post.isAnonymous) {
            tweetElement.classList.add('anonymous-post');
          }
          tweetElement.dataset.postId = doc.id;
          
          // Format date
          const postDate = post.timestamp?.toDate();
          const formattedDate = postDate ? formatDate(postDate) : '';
          
          // Check if user is admin to add badge
          const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
            return adminUsers[adminEmail] === post.userName;
          });
          
          const adminBadgeHtml = isUserAdmin ? 
            `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
          
          // Create tags HTML
          const tagsHtml = post.tags && post.tags.length > 0 ? 
            post.tags.map(tag => `<span class="tweet-tag">${tag}</span>`).join('') : '';
          
          // Create images HTML if post has images
          let imagesHtml = '';
          if (post.imageUrls && post.imageUrls.length > 0) {
            imagesHtml = '<div class="tweet-images">';
            post.imageUrls.forEach(imageUrl => {
              imagesHtml += `<img src="${imageUrl}" alt="Post image" class="tweet-image" data-full-image="${imageUrl}">`;
            });
            imagesHtml += '</div>';
          } else if (post.imageUrl) {
            // For backward compatibility with old posts
            imagesHtml = `<img src="${post.imageUrl}" alt="Post image" class="tweet-image" data-full-image="${post.imageUrl}">`;
          }
          
          // Check if user is online
          const isUserOnline = onlineUsers.get(post.userId) || false;
          
          // Handle anonymous posts
          const avatarHtml = post.isAnonymous ? 
            generateIncognitoAvatar() : 
            `<img src="${generateAvatarUrl(post.userId)}" alt="Profile Picture" class="tweet-avatar" data-user-id="${post.userId}">`;
          
          const userNameHtml = post.isAnonymous ? 
            `<p class="tweet-user-name">Anonymous</p>` : 
            `<p class="tweet-user-name" data-user-id="${post.userId}">${post.userName}</p>${adminBadgeHtml}`;
          
          const userHandleHtml = post.isAnonymous ? 
            `<span class="tweet-user-handle">@anonymous</span>` : 
            `<span class="tweet-user-handle">@${post.userName.toLowerCase().replace(/\s+/g, '')}</span>`;
          
          tweetElement.innerHTML = `
            <div class="tweet-header">
              <div class="tweet-avatar-container">
                ${avatarHtml}
                ${!post.isAnonymous ? `<div class="online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>` : ''}
              </div>
              <div class="tweet-user-info">
                <div>
                  ${userNameHtml}
                  ${userHandleHtml}
                </div>
                <p class="tweet-time">${formattedDate}</p>
              </div>
            </div>
            <div class="tweet-content">
              <h3 class="tweet-title">${post.title}</h3>
              <p class="tweet-text">${post.content}</p>
              ${imagesHtml}
              <div style="margin-top: 0.8rem;">
                <span class="tweet-category">${post.category}</span>
                ${tagsHtml}
              </div>
            </div>
            <div class="tweet-actions">
              <button class="tweet-action comment-btn">
                <i class="far fa-comment"></i>
                <span class="comment-count">0</span>
              </button>
              <button class="tweet-action like-btn liked">
                <i class="fas fa-heart"></i>
                <span class="like-count">${post.likes || 0}</span>
              </button>
              <button class="tweet-action dislike-btn">
                <i class="far fa-thumbs-down"></i>
                <span class="dislike-count">${post.dislikes || 0}</span>
              </button>
              <button class="tweet-action share-btn">
                <i class="far fa-share-square"></i>
              </button>
            </div>
          `;
          
          profileTweetsContainer.appendChild(tweetElement);
          
          // Add event listeners
          if (!post.isAnonymous) {
            const tweetAvatar = tweetElement.querySelector('.tweet-avatar');
            const tweetUserName = tweetElement.querySelector('.tweet-user-name');
            
            if (tweetAvatar) {
              tweetAvatar.addEventListener('click', () => {
                loadUserProfile(tweetAvatar.dataset.userId);
              });
            }
            
            if (tweetUserName) {
              tweetUserName.addEventListener('click', () => {
                loadUserProfile(tweetUserName.dataset.userId);
              });
            }
          }
          
          // Image click event for lightbox
          const tweetImages = tweetElement.querySelectorAll('.tweet-image');
          if (tweetImages.length > 0) {
            tweetImages.forEach(img => {
              img.addEventListener('click', () => {
                lightboxImage.src = img.dataset.fullImage;
                lightboxOverlay.style.display = 'flex';
              });
            });
          }
          
          // Get comments count
          getCommentsCount(doc.id).then(count => {
            const commentCount = tweetElement.querySelector('.comment-count');
            if (commentCount) {
              commentCount.textContent = count;
            }
          });
          
          // Add like/dislike event listeners
          const likeBtn = tweetElement.querySelector('.like-btn');
          const dislikeBtn = tweetElement.querySelector('.dislike-btn');
          
          likeBtn.addEventListener('click', async () => {
            if (likeBtn.disabled) return;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;
            
            try {
              await handleLike(doc.id);
              
              // Update UI immediately
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              
              if (likeBtn.classList.contains('liked')) {
                // Unlike
                likeBtn.classList.remove('liked');
                likeIcon.className = 'far fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
              } else {
                // Like
                likeBtn.classList.add('liked');
                likeIcon.className = 'fas fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) + 1;
              }
            } catch (error) {
              console.error('Error updating like:', error);
              showToast('Failed to update like. Please try again.');
            } finally {
              likeBtn.disabled = false;
              dislikeBtn.disabled = false;
            }
          });
          
          dislikeBtn.addEventListener('click', async () => {
            if (dislikeBtn.disabled) return;
            dislikeBtn.disabled = true;
            likeBtn.disabled = true;
            
            try {
              await handleDislike(doc.id);
              
              // Update UI immediately
              const dislikeIcon = dislikeBtn.querySelector('i');
              const dislikeCount = dislikeBtn.querySelector('.dislike-count');
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              
              if (dislikeBtn.classList.contains('disliked')) {
                // Undislike
                dislikeBtn.classList.remove('disliked');
                dislikeIcon.className = 'far fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
              } else {
                // Dislike
                dislikeBtn.classList.add('disliked');
                dislikeIcon.className = 'fas fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
                
                // If was liked, remove like
                if (likeBtn.classList.contains('liked')) {
                  likeBtn.classList.remove('liked');
                  likeIcon.className = 'far fa-heart';
                  likeCount.textContent = parseInt(likeCount.textContent) - 1;
                }
              }
            } catch (error) {
              console.error('Error updating dislike:', error);
              showToast('Failed to update dislike. Please try again.');
            } finally {
              dislikeBtn.disabled = false;
              likeBtn.disabled = false;
            }
          });
          
          // Add comment button event listener
          const commentsSection = tweetElement.querySelector('.comments-section');
          const commentBtn = tweetElement.querySelector('.comment-btn');
          commentBtn.addEventListener('click', () => {
            commentsSection.classList.toggle('show');
            if (commentsSection.classList.contains('show')) {
              loadComments(doc.id, commentsSection);
            }
          });
        });
        
        // Update online indicators
        updateOnlineIndicators();
        
      } catch (error) {
        console.error('Error loading liked posts:', error);
        profileTweetsContainer.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">Error loading liked posts.</p></div>';
      }
    }
    
    // Load Media Posts
    async function loadMediaPosts(userId) {
      try {
        profileTweetsContainer.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading media posts...</div>';
        
        // Get user's posts
        const postsQuery = query(
          collection(db, 'posts'),
          where('userId', '==', userId),
          orderBy('timestamp', 'desc')
        );
        
        const postsSnapshot = await getDocs(postsQuery);
        
        // Filter posts with images
        const mediaPosts = postsSnapshot.docs.filter(doc => {
          const post = doc.data();
          return post.imageUrls?.length > 0 || post.imageUrl;
        });
        
        if (mediaPosts.length === 0) {
          profileTweetsContainer.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">No media posts found.</p></div>';
          return;
        }
        
        profileTweetsContainer.innerHTML = '';
        
        // Render media posts
        mediaPosts.forEach(doc => {
          const post = doc.data();
          const tweetElement = document.createElement('div');
          tweetElement.className = 'tweet';
          if (post.isAnonymous) {
            tweetElement.classList.add('anonymous-post');
          }
          tweetElement.dataset.postId = doc.id;
          
          // Format date
          const postDate = post.timestamp?.toDate();
          const formattedDate = postDate ? formatDate(postDate) : '';
          
          // Check if user is admin to add badge
          const isUserAdmin = Object.keys(adminUsers).some(adminEmail => {
            return adminUsers[adminEmail] === post.userName;
          });
          
          const adminBadgeHtml = isUserAdmin ? 
            `<span style="background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: var(--radius-full); margin-left: 0.3rem;">Admin</span>` : '';
          
          // Create tags HTML
          const tagsHtml = post.tags && post.tags.length > 0 ? 
            post.tags.map(tag => `<span class="tweet-tag">${tag}</span>`).join('') : '';
          
          // Create images HTML if post has images
          let imagesHtml = '';
          if (post.imageUrls && post.imageUrls.length > 0) {
            imagesHtml = '<div class="tweet-images">';
            post.imageUrls.forEach(imageUrl => {
              imagesHtml += `<img src="${imageUrl}" alt="Post image" class="tweet-image" data-full-image="${imageUrl}">`;
            });
            imagesHtml += '</div>';
          } else if (post.imageUrl) {
            // For backward compatibility with old posts
            imagesHtml = `<img src="${post.imageUrl}" alt="Post image" class="tweet-image" data-full-image="${post.imageUrl}">`;
          }
          
          // Check if user is online
          const isUserOnline = onlineUsers.get(post.userId) || false;
          
          // Handle anonymous posts
          const avatarHtml = post.isAnonymous ? 
            generateIncognitoAvatar() : 
            `<img src="${generateAvatarUrl(post.userId)}" alt="Profile Picture" class="tweet-avatar" data-user-id="${post.userId}">`;
          
          const userNameHtml = post.isAnonymous ? 
            `<p class="tweet-user-name">Anonymous</p>` : 
            `<p class="tweet-user-name" data-user-id="${post.userId}">${post.userName}</p>${adminBadgeHtml}`;
          
          const userHandleHtml = post.isAnonymous ? 
            `<span class="tweet-user-handle">@anonymous</span>` : 
            `<span class="tweet-user-handle">@${post.userName.toLowerCase().replace(/\s+/g, '')}</span>`;
          
          tweetElement.innerHTML = `
            <div class="tweet-header">
              <div class="tweet-avatar-container">
                ${avatarHtml}
                ${!post.isAnonymous ? `<div class="online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>` : ''}
              </div>
              <div class="tweet-user-info">
                <div>
                  ${userNameHtml}
                  ${userHandleHtml}
                </div>
                <p class="tweet-time">${formattedDate}</p>
              </div>
            </div>
            <div class="tweet-content">
              <h3 class="tweet-title">${post.title}</h3>
              <p class="tweet-text">${post.content}</p>
              ${imagesHtml}
              <div style="margin-top: 0.8rem;">
                <span class="tweet-category">${post.category}</span>
                ${tagsHtml}
              </div>
            </div>
            <div class="tweet-actions">
              <button class="tweet-action comment-btn">
                <i class="far fa-comment"></i>
                <span class="comment-count">0</span>
              </button>
              <button class="tweet-action like-btn ${post.likedBy?.includes(auth.currentUser.uid) ? 'liked' : ''}">
                <i class="${post.likedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-heart"></i>
                <span class="like-count">${post.likes || 0}</span>
              </button>
              <button class="tweet-action dislike-btn ${post.dislikedBy?.includes(auth.currentUser.uid) ? 'disliked' : ''}">
                <i class="${post.dislikedBy?.includes(auth.currentUser.uid) ? 'fas' : 'far'} fa-thumbs-down"></i>
                <span class="dislike-count">${post.dislikes || 0}</span>
              </button>
              <button class="tweet-action share-btn">
                <i class="far fa-share-square"></i>
              </button>
            </div>
          `;
          
          profileTweetsContainer.appendChild(tweetElement);
          
          // Add event listeners
          if (!post.isAnonymous) {
            const tweetAvatar = tweetElement.querySelector('.tweet-avatar');
            const tweetUserName = tweetElement.querySelector('.tweet-user-name');
            
            if (tweetAvatar) {
              tweetAvatar.addEventListener('click', () => {
                loadUserProfile(tweetAvatar.dataset.userId);
              });
            }
            
            if (tweetUserName) {
              tweetUserName.addEventListener('click', () => {
                loadUserProfile(tweetUserName.dataset.userId);
              });
            }
          }
          
          // Image click event for lightbox
          const tweetImages = tweetElement.querySelectorAll('.tweet-image');
          if (tweetImages.length > 0) {
            tweetImages.forEach(img => {
              img.addEventListener('click', () => {
                lightboxImage.src = img.dataset.fullImage;
                lightboxOverlay.style.display = 'flex';
              });
            });
          }
          
          // Get comments count
          getCommentsCount(doc.id).then(count => {
            const commentCount = tweetElement.querySelector('.comment-count');
            if (commentCount) {
              commentCount.textContent = count;
            }
          });
          
          // Add like/dislike event listeners
          const likeBtn = tweetElement.querySelector('.like-btn');
          const dislikeBtn = tweetElement.querySelector('.dislike-btn');
          
          likeBtn.addEventListener('click', async () => {
            if (likeBtn.disabled) return;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;
            
            try {
              await handleLike(doc.id);
              
              // Update UI immediately
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              const dislikeIcon = dislikeBtn.querySelector('i');
              const dislikeCount = dislikeBtn.querySelector('.dislike-count');
              
              if (likeBtn.classList.contains('liked')) {
                // Unlike
                likeBtn.classList.remove('liked');
                likeIcon.className = 'far fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
              } else {
                // Like
                likeBtn.classList.add('liked');
                likeIcon.className = 'fas fa-heart';
                likeCount.textContent = parseInt(likeCount.textContent) + 1;
                
                // If was disliked, remove dislike
                if (dislikeBtn.classList.contains('disliked')) {
                  dislikeBtn.classList.remove('disliked');
                  dislikeIcon.className = 'far fa-thumbs-down';
                  dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
                }
              }
            } catch (error) {
              console.error('Error updating like:', error);
              showToast('Failed to update like. Please try again.');
            } finally {
              likeBtn.disabled = false;
              dislikeBtn.disabled = false;
            }
          });
          
          dislikeBtn.addEventListener('click', async () => {
            if (dislikeBtn.disabled) return;
            dislikeBtn.disabled = true;
            likeBtn.disabled = true;
            
            try {
              await handleDislike(doc.id);
              
              // Update UI immediately
              const dislikeIcon = dislikeBtn.querySelector('i');
              const dislikeCount = dislikeBtn.querySelector('.dislike-count');
              const likeIcon = likeBtn.querySelector('i');
              const likeCount = likeBtn.querySelector('.like-count');
              
              if (dislikeBtn.classList.contains('disliked')) {
                // Undislike
                dislikeBtn.classList.remove('disliked');
                dislikeIcon.className = 'far fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
              } else {
                // Dislike
                dislikeBtn.classList.add('disliked');
                dislikeIcon.className = 'fas fa-thumbs-down';
                dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
                
                // If was liked, remove like
                if (likeBtn.classList.contains('liked')) {
                  likeBtn.classList.remove('liked');
                  likeIcon.className = 'far fa-heart';
                  likeCount.textContent = parseInt(likeCount.textContent) - 1;
                }
              }
            } catch (error) {
              console.error('Error updating dislike:', error);
              showToast('Failed to update dislike. Please try again.');
            } finally {
              dislikeBtn.disabled = false;
              likeBtn.disabled = false;
            }
          });
          
          // Add comment button event listener
          const commentsSection = tweetElement.querySelector('.comments-section');
          const commentBtn = tweetElement.querySelector('.comment-btn');
          commentBtn.addEventListener('click', () => {
            commentsSection.classList.toggle('show');
            if (commentsSection.classList.contains('show')) {
              loadComments(doc.id, commentsSection);
            }
          });
        });
        
        // Update online indicators
        updateOnlineIndicators();
        
      } catch (error) {
        console.error('Error loading media posts:', error);
        profileTweetsContainer.innerHTML = '<div class="tweet"><p style="text-align: center; padding: 2rem;">Error loading media posts.</p></div>';
      }
    }
    
    // Show Followers Modal
    async function showFollowersModal(userId) {
      try {
        // Show modal
                followersModal.style.display = 'block';
        followersModalOverlay.style.display = 'block';
        
        // Clear previous content
        followersList.innerHTML = '<div style="text-align: center; padding: 1rem;">Loading followers...</div>';
        
        // Get user data
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (!userDoc.exists()) {
          followersList.innerHTML = '<div style="text-align: center; padding: 1rem;">User not found</div>';
          return;
        }
        
        const userData = userDoc.data();
        const followers = userData.followers || [];
        
        if (followers.length === 0) {
          followersList.innerHTML = '<div style="text-align: center; padding: 1rem;">No followers yet</div>';
          return;
        }
        
        // Clear loading message
        followersList.innerHTML = '';
        
        // Get follower data
        const followerPromises = followers.map(followerId => getDoc(doc(db, 'users', followerId)));
        const followerDocs = await Promise.all(followerPromises);
        
        // Render followers
        followerDocs.forEach(followerDoc => {
          if (followerDoc.exists()) {
            const follower = followerDoc.data();
            const isUserOnline = onlineUsers.get(followerDoc.id) || false;
            
            const followerItem = document.createElement('div');
            followerItem.className = 'user-list-item';
            
            followerItem.innerHTML = `
              <div class="user-list-avatar-container">
                <img src="${follower.photoURL || generateAvatarUrl(followerDoc.id)}" alt="Profile Picture" class="user-list-avatar" data-user-id="${followerDoc.id}">
                <div class="user-list-online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>
              </div>
              <div class="user-list-info">
                <div class="user-list-name">${follower.displayName}</div>
                <div class="user-list-handle">@${follower.displayName ? follower.displayName.toLowerCase().replace(/\s+/g, '') : 'anonymous'}</div>
                <div class="user-list-last-active" data-user-id="${followerDoc.id}">
                  ${isUserOnline ? 'Online now' : lastActiveTimestamps.has(followerDoc.id) ? `Last active: ${formatLastActive(lastActiveTimestamps.get(followerDoc.id))}` : ''}
                </div>
              </div>
              <button class="follow-btn" data-user-id="${followerDoc.id}" data-following="${follower.followers?.includes(auth.currentUser.uid) ? 'true' : 'false'}">
                ${follower.followers?.includes(auth.currentUser.uid) ? 'Following' : 'Follow'}
              </button>
            `;
            
            followersList.appendChild(followerItem);
            
            // Add event listeners
            const followerAvatar = followerItem.querySelector('.user-list-avatar');
            followerAvatar.addEventListener('click', () => {
              loadUserProfile(followerDoc.id);
              closeFollowersModal();
            });
            
            const followerName = followerItem.querySelector('.user-list-name');
            followerName.addEventListener('click', () => {
              loadUserProfile(followerDoc.id);
              closeFollowersModal();
            });
            
            const followBtn = followerItem.querySelector('.follow-btn');
            followBtn.addEventListener('click', () => {
              const isFollowing = followBtn.dataset.following === 'true';
              toggleFollow(followerDoc.id, isFollowing);
              
              // Update button
              followBtn.textContent = isFollowing ? 'Follow' : 'Following';
              followBtn.dataset.following = isFollowing ? 'false' : 'true';
            });
          }
        });
        
        // Update online indicators
        updateOnlineIndicators();
        
      } catch (error) {
        console.error('Error loading followers:', error);
        followersList.innerHTML = '<div style="text-align: center; padding: 1rem;">Error loading followers</div>';
      }
    }
    
    // Close Followers Modal
    function closeFollowersModal() {
      followersModal.style.display = 'none';
      followersModalOverlay.style.display = 'none';
    }
    
    followersModalClose.addEventListener('click', closeFollowersModal);
    followersModalOverlay.addEventListener('click', closeFollowersModal);
    
    // Show Following Modal
    async function showFollowingModal(userId) {
      try {
        // Show modal
        followingModal.style.display = 'block';
        followingModalOverlay.style.display = 'block';
        
        // Clear previous content
        followingList.innerHTML = '<div style="text-align: center; padding: 1rem;">Loading following...</div>';
        
        // Get user data
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (!userDoc.exists()) {
          followingList.innerHTML = '<div style="text-align: center; padding: 1rem;">User not found</div>';
          return;
        }
        
        const userData = userDoc.data();
        const following = userData.following || [];
        
        if (following.length === 0) {
          followingList.innerHTML = '<div style="text-align: center; padding: 1rem;">Not following anyone yet</div>';
          return;
        }
        
        // Clear loading message
        followingList.innerHTML = '';
        
        // Get following data
        const followingPromises = following.map(followingId => getDoc(doc(db, 'users', followingId)));
        const followingDocs = await Promise.all(followingPromises);
        
        // Render following
        followingDocs.forEach(followingDoc => {
          if (followingDoc.exists()) {
            const followingUser = followingDoc.data();
            const isUserOnline = onlineUsers.get(followingDoc.id) || false;
            
            const followingItem = document.createElement('div');
            followingItem.className = 'user-list-item';
            
            followingItem.innerHTML = `
              <div class="user-list-avatar-container">
                <img src="${followingUser.photoURL || generateAvatarUrl(followingDoc.id)}" alt="Profile Picture" class="user-list-avatar" data-user-id="${followingDoc.id}">
                <div class="user-list-online-indicator" style="display: ${isUserOnline ? 'block' : 'none'}"></div>
              </div>
              <div class="user-list-info">
                <div class="user-list-name">${followingUser.displayName}</div>
                <div class="user-list-handle">@${followingUser.displayName.toLowerCase().replace(/\s+/g, '')}</div>
                <div class="user-list-last-active" data-user-id="${followingDoc.id}">
                  ${isUserOnline ? 'Online now' : lastActiveTimestamps.has(followingDoc.id) ? `Last active: ${formatLastActive(lastActiveTimestamps.get(followingDoc.id))}` : ''}
                </div>
              </div>
              <button class="follow-btn" data-user-id="${followingDoc.id}" data-following="${followingUser.followers?.includes(auth.currentUser.uid) ? 'true' : 'false'}">
                ${followingUser.followers?.includes(auth.currentUser.uid) ? 'Following' : 'Follow'}
              </button>
            `;
            
            followingList.appendChild(followingItem);
            
            // Add event listeners
            const followingAvatar = followingItem.querySelector('.user-list-avatar');
            followingAvatar.addEventListener('click', () => {
              loadUserProfile(followingDoc.id);
              closeFollowingModal();
            });
            
            const followingName = followingItem.querySelector('.user-list-name');
            followingName.addEventListener('click', () => {
              loadUserProfile(followingDoc.id);
              closeFollowingModal();
            });
            
            const followBtn = followingItem.querySelector('.follow-btn');
            followBtn.addEventListener('click', () => {
              const isFollowing = followBtn.dataset.following === 'true';
              toggleFollow(followingDoc.id, isFollowing);
              
              // Update button
              followBtn.textContent = isFollowing ? 'Follow' : 'Following';
              followBtn.dataset.following = isFollowing ? 'false' : 'true';
            });
          }
        });
        
        // Update online indicators
        updateOnlineIndicators();
        
      } catch (error) {
        console.error('Error loading following:', error);
        followingList.innerHTML = '<div style="text-align: center; padding: 1rem;">Error loading following</div>';
      }
    }
    
    // Close Following Modal
    function closeFollowingModal() {
      followingModal.style.display = 'none';
      followingModalOverlay.style.display = 'none';
    }
    
    followingModalClose.addEventListener('click', closeFollowingModal);
    followingModalOverlay.addEventListener('click', closeFollowingModal);
    
    // Load User Settings
    async function loadUserSettings() {
      try {
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        
        if (!userDoc.exists()) {
          showToast('User data not found');
          return;
        }
        
        const userData = userDoc.data();
        
        // Update form fields
        settingsUsername.value = userData.displayName || '';
        settingsBio.value = userData.bio || '';
        
        // Update toggles
        const settings = userData.settings || {};
        emailNotifications.checked = settings.emailNotifications || false;
        pushNotifications.checked = settings.pushNotifications || true;
        privateAccount.checked = settings.privateAccount || false;
        activityStatus.checked = settings.activityStatus || true;
        
      } catch (error) {
        console.error('Error loading user settings:', error);
        showToast('Error loading settings');
      }
    }
    
    // Save User Settings
    saveSettings.addEventListener('click', async () => {
      try {
        const username = settingsUsername.value.trim();
        const bio = settingsBio.value.trim();
        
        if (!username) {
          showToast('Username cannot be empty');
          return;
        }
        
        // Update user data
        await updateDoc(doc(db, 'users', auth.currentUser.uid), {
          displayName: username,
          bio: bio,
          settings: {
            emailNotifications: emailNotifications.checked,
            pushNotifications: pushNotifications.checked,
            privateAccount: privateAccount.checked,
            activityStatus: activityStatus.checked
          }
        });
        
        // Update UI
        sidebarName.textContent = username;
        sidebarHandle.textContent = '@' + username.toLowerCase().replace(/\s+/g, '');
        
        showToast('Settings saved successfully');
        
      } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Error saving settings');
      }
    });
    
    // Load Active Followers
    async function loadActiveFollowers() {
      try {
        // Clear previous content
        activeFollowersList.innerHTML = '';
        
        // Get current user's followers
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        
        if (!userDoc.exists()) {
          activeFollowersList.innerHTML = '<div style="padding: 1rem; text-align: center;">No data available</div>';
          return;
        }
        
        const userData = userDoc.data();
        const followers = userData.followers || [];
        
        if (followers.length === 0) {
          activeFollowersList.innerHTML = '<div style="padding: 1rem; text-align: center;">No followers yet</div>';
          return;
        }
        
        // Get follower data
        const followerPromises = followers.map(followerId => getDoc(doc(db, 'users', followerId)));
        const followerDocs = await Promise.all(followerPromises);
        
        // Sort followers by online status and last active time
        const sortedFollowers = followerDocs
          .filter(doc => doc.exists())
          .map(doc => ({
            id: doc.id,
            ...doc.data(),
            isOnline: onlineUsers.get(doc.id) || false,
            lastActive: lastActiveTimestamps.get(doc.id) || new Date(0)
          }))
          .sort((a, b) => {
            // Online users first
            if (a.isOnline && !b.isOnline) return -1;
            if (!a.isOnline && b.isOnline) return 1;
            
            // Then sort by last active time
            return b.lastActive - a.lastActive;
          });
        
        // Render active followers (limit to 5)
        sortedFollowers.slice(0, 5).forEach(follower => {
          const followerItem = document.createElement('div');
          followerItem.className = 'active-followers-item';
          followerItem.dataset.userId = follower.id;
          
          followerItem.innerHTML = `
            <div class="active-followers-avatar-container">
              <img src="${follower.photoURL || generateAvatarUrl(follower.id)}" alt="Profile Picture" class="active-followers-avatar" data-user-id="${follower.id}">
              <div class="active-followers-online-indicator" style="display: ${follower.isOnline ? 'block' : 'none'}"></div>
            </div>
            <div class="active-followers-info">
              <div class="active-followers-name">${follower.displayName || 'Anonymous'}</div>
              <div class="active-followers-handle">@${follower.displayName ? follower.displayName.toLowerCase().replace(/\s+/g, '') : 'anonymous'}</div>
              <div class="active-followers-last-active" data-user-id="${follower.id}">
                ${follower.isOnline ? 'Online now' : `Last active: ${formatLastActive(follower.lastActive)}`}
              </div>
            </div>
          `;
          
          activeFollowersList.appendChild(followerItem);
          
          // Add click event to view profile
          followerItem.addEventListener('click', () => {
            loadUserProfile(follower.id);
          });
        });
        
      } catch (error) {
        console.error('Error loading active followers:', error);
        activeFollowersList.innerHTML = '<div style="padding: 1rem; text-align: center;">Error loading followers</div>';
      }
    }
    
    // Navigation
    function setActiveNavItem(item) {
      // Remove active class from all nav links
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));
      
      // Remove active class from all mobile nav links
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
      mobileNavLinks.forEach(link => link.classList.remove('active'));
      
      // Add active class to selected nav link
      if (item === 'home') {
        document.getElementById('home-link').classList.add('active');
        document.getElementById('mobile-home').classList.add('active');
      } else if (item === 'notifications') {
        document.getElementById('notifications-link').classList.add('active');
        document.getElementById('mobile-notifications').classList.add('active');
        notificationsOpened = true;
      } else if (item === 'messages') {
        document.getElementById('messages-link').classList.add('active');
        document.getElementById('mobile-messages').classList.add('active');
      } else if (item === 'profile') {
        document.getElementById('profile-link').classList.add('active');
      } else if (item === 'settings') {
        document.getElementById('settings-link').classList.add('active');
      }
    }
    
    function showPage(pageId) {
      // Hide all pages
      homePage.style.display = 'none';
      notificationsPage.style.display = 'none';
      messagesPage.style.display = 'none';
      profilePage.style.display = 'none';
      settingsPage.style.display = 'none';
      
      // Show selected page
      document.getElementById(pageId).style.display = 'block';
      
      // Close sidebar on mobile
      if (window.innerWidth < 992) {
        document.getElementById('sidebar').classList.remove('show');
      }
      
      // Reset notifications opened flag if not on notifications page
      if (pageId !== 'notifications-page') {
        notificationsOpened = false;
      }
    }
    
    // Navigation Event Listeners
    homeLink.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Home';
      setActiveNavItem('home');
      showPage('home-page');
      loadPosts();
    });
    
    notificationsLink.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Notifications';
      setActiveNavItem('notifications');
      showPage('notifications-page');
      markAllNotificationsAsRead();
    });
    
    messagesLink.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Messages';
      setActiveNavItem('messages');
      showPage('messages-page');
    });
    
    profileLink.addEventListener('click', (e) => {
      e.preventDefault();
      loadUserProfile(auth.currentUser.uid);
    });
    
    settingsLink.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Settings';
      setActiveNavItem('settings');
      showPage('settings-page');
      loadUserSettings();
    });
    
    // Mobile Navigation
    mobileHome.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Home';
      setActiveNavItem('home');
      showPage('home-page');
      loadPosts();
    });
    
    mobileNotifications.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Notifications';
      setActiveNavItem('notifications');
      showPage('notifications-page');
      markAllNotificationsAsRead();
    });
    
    mobileMessages.addEventListener('click', (e) => {
      e.preventDefault();
      pageTitle.textContent = 'Messages';
      setActiveNavItem('messages');
      showPage('messages-page');
    });
    
    // Floating Tweet Button
    floatTweetBtn.addEventListener('click', () => {
      // Scroll to top and focus on compose tweet
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setTimeout(() => {
        tweetContent.focus();
      }, 500);
    });
    
    // Compose Button
    composeBtn.addEventListener('click', () => {
      // Make sure we're on the home page
      pageTitle.textContent = 'Home';
      setActiveNavItem('home');
      showPage('home-page');
      
      // Focus on compose tweet
      tweetContent.focus();
    });
    
    // Mobile Sidebar Toggle
    document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('show');
    });
    
    // Initialize
    function init() {
      // Check for post ID in URL
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get('post');
      
      if (postId) {
        loadSinglePost(postId);
      } else {
        // Default to home page
        pageTitle.textContent = 'Home';
        setActiveNavItem('home');
        showPage('home-page');
      }
    }
    
    // Call init after auth state change
    auth.onAuthStateChanged(user => {
      if (user) {
        init();
      }
    });
  </script>
</body>
</html>