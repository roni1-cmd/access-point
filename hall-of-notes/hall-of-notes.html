<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Student Uploads</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card-container { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 15px; }
    .card { padding: 20px; background: #f3f3f3; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; }
    .card:hover { background: #ddd; }
    #subjectPage { display: none; }
    #backBtn { margin-bottom: 15px; }
    .file-item { margin: 8px 0; }
  </style>
</head>
<body>
  <h2>Student File Sharing</h2>

  <!-- Auth -->
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <!-- Main subject card view -->
  <div id="mainPage" style="display:none;">
    <h3>Select a Subject</h3>
    <div class="card-container" id="subjectCards"></div>
  </div>

  <!-- Subject view -->
  <div id="subjectPage">
    <button id="backBtn">‚Üê Back</button>
    <h3 id="subjectTitle"></h3>
    <input type="hidden" role="uploadcare-uploader" id="fileUploader" />
    <div id="fileList"></div>
  </div>

  <script>
    // ===== Firebase Setup =====
    const firebaseConfig = {
      apiKey: "AIzaSyAsynsRyRVwNYzOtqG4yDdcy5HWw74aOzY",
      authDomain: "student-s-helpdesk.firebaseapp.com",
      databaseURL: "https://student-s-helpdesk-default-rtdb.firebaseio.com",
      projectId: "student-s-helpdesk",
      storageBucket: "student-s-helpdesk.appspot.com",
      messagingSenderId: "270861175145",
      appId: "1:270861175145:web:b66a5f9fef8ac3104855f8",
      measurementId: "G-VRKD5P955F"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Subjects
    const subjects = [
      "COMMUNICATION",
      "CULTURE & SOCIETY",
      "INTERPERSONAL COMMUNICATION IN DEVELOPMENT",
      "THE CONTEMPORARY WORLD",
      "PURPOSIVE COMMUNICATION",
      "ETHICS",
      "INTRODUCTION TO COMMUNICATION MEDIA"
    ];

    // Auth
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const mainPage = document.getElementById("mainPage");

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        mainPage.style.display = "block";
      } else {
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        mainPage.style.display = "none";
        document.getElementById("subjectPage").style.display = "none";
      }
    });

    // Render subject cards
    const subjectCards = document.getElementById("subjectCards");
    subjects.forEach(sub => {
      const card = document.createElement("div");
      card.className = "card";
      card.textContent = sub;
      card.onclick = () => openSubject(sub);
      subjectCards.appendChild(card);
    });

    // Subject page logic
    const subjectPage = document.getElementById("subjectPage");
    const subjectTitle = document.getElementById("subjectTitle");
    const fileList = document.getElementById("fileList");
    const backBtn = document.getElementById("backBtn");

    let currentSubject = null;
    let uploader = uploadcare.Widget("#fileUploader");

    function openSubject(subject) {
      currentSubject = subject;
      subjectTitle.textContent = subject;
      mainPage.style.display = "none";
      subjectPage.style.display = "block";
      fileList.innerHTML = "";

      // Listen for files in this subject only
      db.ref("files").orderByChild("subject").equalTo(subject).on("child_added", snap => {
        const data = snap.val();
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `<a href="${data.url}" target="_blank">${data.name}</a>`;
        fileList.appendChild(div);
      });
    }

    backBtn.onclick = () => {
      subjectPage.style.display = "none";
      mainPage.style.display = "block";
      db.ref("files").off(); // detach old listener
    };

    // Upload handling
    uploader.onUploadComplete(fileInfo => {
      if (!currentSubject) {
        alert("Please open a subject before uploading.");
        return;
      }
      db.ref("files").push({
        subject: currentSubject,
        url: fileInfo.cdnUrl,
        name: fileInfo.name,
        uploadedAt: Date.now()
      });
    });
  </script>
</body>
</html>
