<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Point - Messaging Portal</title>
    <link rel="icon" href="/src/godc.png">
    
    <!-- Updated to use Google Sans font only -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        :root {
            /* Updated to use custom color scheme */
            --primary-dark: #353539;
            --green-dark: #0e3521;
            --green-medium: #006936;
            --green-light: #5fb14c;
            --accent-yellow: #f1ec33;
            --green-muted: #4a7c59;
            --surface: #ffffff;
            --text: #0f172a;
            --text-light: #64748b;
            --background: #f8fafc;
            --background-alt: #f1f5f9;
            --border: #e2e8f0;
            --status-received: #fef3c7;
            --status-inprogress: #dcfce7;
            --status-resolved: #dbeafe;
            --shadow: 0 4px 20px -1px rgba(0, 0, 0, 0.1), 0 2px 10px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 15px -4px rgba(0, 0, 0, 0.05);
            --radius: 0.5rem;
            --radius-lg: 1rem;
            --radius-full: 9999px;
            --transition: all 0.3s ease;
            --header-height: 64px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
            /* Updated to use Google Sans font */
            font-family: 'Google Sans', sans-serif;
            overflow-x: hidden;
        }
        
        /* Removed glass UI effects */
        
        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: sticky;
            top: 1.5rem;
            z-index: 10;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            height: 40px;
            border-radius: var(--radius);
        }
        
        .site-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--green-medium);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
        }
        
        .header-btn:hover {
            background: var(--background-alt);
            border-color: var(--green-medium);
        }
        
        .header-btn.primary {
            background: var(--green-medium);
            color: white;
            border-color: var(--green-medium);
        }
        
        .header-btn.primary:hover {
            background: var(--green-dark);
        }
        
        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .stat-icon {
            padding: 0.5rem;
            border-radius: var(--radius);
            background: var(--background-alt);
            color: var(--green-medium);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .stat-change {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--green-medium);
        }
        
        /* Tabs */
        .tabs-container {
            margin-bottom: 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            /* Replaced glass effect with solid background */
            background: var(--background-alt);
            border-radius: var(--radius-lg);
            padding: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            background: transparent;
            color: var(--text-light);
            border: none;
        }
        
        .tab:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .tab.active {
            background: var(--green-medium);
            color: white;
            box-shadow: var(--shadow);
        }
        
        /* Filters */
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }
        
        .search-bar {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            width: 16px;
            height: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            transition: var(--transition);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--green-medium);
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .filter-select {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--green-medium);
        }
        
        /* Messages */
        .messages-container {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message-card {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 5px solid transparent;
        }
        
        .message-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-3px);
        }
        
        .message-card.active {
            border-color: var(--green-medium);
            background: var(--background-alt);
        }
        
        .message-card.unread {
            border-left-color: var(--green-medium);
            background: var(--background-alt);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .message-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .message-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
        }
        
        .message-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--text);
            font-size: 0.9375rem;
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tracking-code {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8125rem;
            color: var(--text-light);
            background: var(--background-alt);
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-full);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.875rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-Received {
            background-color: var(--status-received);
            color: #d97706;
        }
        
        .status-In\.Progress {
            background-color: var(--status-inprogress);
            color: #16a34a;
        }
        
        .status-Resolved {
            background-color: var(--status-resolved);
            color: #2563eb;
        }
        
        .message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            opacity: 0;
            transition: var(--transition);
        }
        
        .message-card:hover .message-actions {
            opacity: 1;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--green-medium);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--green-dark);
        }
        
        .btn-secondary {
            background: var(--background-alt);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--surface);
            border-color: var(--green-medium);
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: var(--transition);
        }
        
        .modal-overlay.active .modal-container {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .modal-close {
            padding: 0.5rem;
            border-radius: var(--radius);
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: var(--background-alt);
            color: var(--text);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Message Detail */
        .detail-title {
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--green-medium);
        }
        
        .detail-meta {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            /* Replaced glass effect with solid background */
            background: var(--background-alt);
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: var(--radius);
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .detail-icon {
            color: var(--green-medium);
            background-color: var(--background-alt);
            padding: 0.5rem;
            border-radius: var(--radius);
        }
        
        .detail-content {
            display: flex;
            flex-direction: column;
            font-size: 0.875rem;
        }
        
        .detail-label {
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .message-body {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            line-height: 1.7;
            position: relative;
            font-size: 0.9375rem;
        }
        
        /* Added styles for reply functionality */
        .replies-section {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }
        
        .replies-container {
            margin-top: 1rem;
        }
        
        .reply-item {
            background: var(--background-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .reply-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--green-medium);
        }
        
        .reply-author i {
            width: 16px;
            height: 16px;
        }
        
        .reply-date {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .reply-content {
            color: var(--text);
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .no-replies {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-style: italic;
            padding: 1rem;
            text-align: center;
            justify-content: center;
        }
        
        .reply-form-section {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }
        
        .reply-form {
            margin-top: 1rem;
        }
        
        .reply-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Google Sans', sans-serif;
            font-size: 0.875rem;
            line-height: 1.5;
            resize: vertical;
            transition: var(--transition);
        }
        
        .reply-textarea:focus {
            outline: none;
            border-color: var(--green-medium);
            box-shadow: 0 0 0 3px rgba(95, 177, 76, 0.1);
        }
        
        .reply-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .reply-actions .btn {
            gap: 0.5rem;
        }
        
        .action-panel {
            /* Replaced glass effect with solid background */
            background: var(--background-alt);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--green-medium);
        }
        
        .action-row {
            margin-bottom: 1rem;
        }
        
        .action-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }
        
        .select-status {
            width: 100%;
            max-width: 200px;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            /* Replaced glass effect with solid background */
            background: var(--surface);
            margin-bottom: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
            cursor: pointer;
        }
        
        .select-status:focus {
            outline: none;
            border-color: var(--green-medium);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }
        
        .empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--text-light);
        }
        
        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .empty-message {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--green-medium);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* User Cards */
        .user-card {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }
        
        .user-card:hover {
            box-shadow: var(--shadow);
        }
        
        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar-lg {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--green-medium);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .user-email {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .message-count {
            background: var(--green-medium);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .user-messages {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .user-message {
            padding: 1rem;
            background: var(--background-alt);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
        }
        
        .user-message:hover {
            background: var(--surface);
            border-color: var(--green-medium);
        }
        
        .user-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .user-message-subject {
            font-weight: 500;
            color: var(--text);
        }
        
        .user-message-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-light);
        }
        
        /* Help Cards */
        .help-card {
            /* Replaced glass effect with solid background */
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .help-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: var(--background-alt);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--green-medium);
        }
        
        .help-content {
            padding: 1.5rem;
            line-height: 1.6;
        }
        
        .help-content p {
            margin-bottom: 1rem;
        }
        
        .help-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .help-content li {
            margin-bottom: 0.5rem;
        }
        
        .highlight {
            background: var(--accent-yellow);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .filters-container {
                flex-direction: column;
            }
            
            .search-bar {
                min-width: auto;
            }
            
            .message-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .message-footer {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            
            .detail-meta {
                grid-template-columns: 1fr;
            }
            
            .modal-container {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            .user-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .user-message-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            
            .user-message-footer {
                flex-direction: column;
                gap: 0.25rem;
            }
        }
        
        /* Animation */
        .message-card {
            animation: slideInUp 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <img src="/src/helpdesk.png" alt="ANG SILAKBO Logo" class="logo">
                <h1 class="site-title">Access Point | Message Portal</h1>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="help-btn">
                    <i data-feather="help-circle"></i>
                    Help
                </button>
                <button class="header-btn primary" id="refresh-btn">
                    <i data-feather="refresh-cw"></i>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total Messages</span>
                    <div class="stat-icon">
                        <i data-feather="message-square"></i>
                    </div>
                </div>
                <div class="stat-value" id="total-messages">0</div>
                <div class="stat-change">All time</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">In Progress</span>
                    <div class="stat-icon">
                        <i data-feather="clock"></i>
                    </div>
                </div>
                <div class="stat-value" id="in-progress">0</div>
                <div class="stat-change">Active cases</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Resolved</span>
                    <div class="stat-icon">
                        <i data-feather="check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="resolved">0</div>
                <div class="stat-change">Completed</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="messages">
                    <i data-feather="inbox"></i>
                    Messages
                </button>
                <button class="tab" data-tab="users">
                    <i data-feather="users"></i>
                    User History
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters-container">
            <div class="search-bar">
                <i data-feather="search" class="search-icon"></i>
                <input type="text" class="search-input" id="search-messages" placeholder="Search messages...">
            </div>
            
            <div class="filter-group">
                <select class="filter-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="Received">Received</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                </select>
                
                <select class="filter-select" id="sort-filter">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="unread">Unread First</option>
                </select>
            </div>
        </div>
        
        <div class="content-container">
            <!-- Messages Container -->
            <div class="messages-container">
                <div class="message-list" id="message-list">
                    <div class="empty-state">
                        <i data-feather="inbox" class="empty-icon"></i>
                        <h3 class="empty-title">Loading messages...</h3>
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Message Detail Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-feather="message-square"></i>
                    Message Detail
                </h2>
                <button class="modal-close" id="close-detail-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" id="detail-content">
                <div class="empty-state">
                    <i data-feather="inbox" class="empty-icon"></i>
                    <h3 class="empty-title">Loading message details...</h3>
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div class="modal-overlay" id="users-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-feather="users"></i>
                    User Message History
                </h2>
                <button class="modal-close" id="close-users-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="search-bar" style="margin-bottom: 1.5rem;">
                    <i data-feather="search" class="search-icon"></i>
                    <input type="text" class="search-input" id="search-users" placeholder="Search users by name or email...">
                </div>
                
                <div id="users-container">
                    <div class="empty-state">
                        <i data-feather="users" class="empty-icon"></i>
                        <h3 class="empty-title">Loading user data...</h3>
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-feather="help-circle"></i>
                    Help Center
                </h2>
                <button class="modal-close" id="close-help-modal">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-card">
                    <div class="help-header">
                        <i data-feather="info"></i>
                        Getting Started
                    </div>
                    <div class="help-content">
                        <p>Welcome to the Access Point! This platform helps you manage and respond to user messages efficiently.</p>
                        <p>Here's how to get started:</p>
                        <ul>
                            <li>The <span class="highlight">Messages</span> tab displays all incoming messages from users</li>
                            <li>The <span class="highlight">User History</span> tab shows message history grouped by user</li>
                            <li>Use filters and search to quickly find specific messages</li>
                            <li>Click on any message to view details and respond</li>
                        </ul>
                    </div>
                </div>
                
                <div class="help-card">
                    <div class="help-header">
                        <i data-feather="message-square"></i>
                        Managing Messages
                    </div>
                    <div class="help-content">
                        <p>Each message can be managed through the following status options:</p>
                        <ul>
                            <li><span class="highlight">Received</span> - New messages that haven't been processed</li>
                            <li><span class="highlight">In Progress</span> - Messages currently being worked on</li>
                            <li><span class="highlight">Resolved</span> - Messages that have been completed</li>
                        </ul>
                        <p>Click on any message to view full details and update its status.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <div class="help-header">
                        <i data-feather="filter"></i>
                        Using Filters
                    </div>
                    <div class="help-content">
                        <p>Use the search and filter options to quickly find specific messages:</p>
                        <ul>
                            <li>Search by name, email, subject, or message content</li>
                            <li>Filter by status (Received, In Progress, Resolved)</li>
                            <li>Sort by date (newest/oldest first) or priority (unread first)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Feather Icons
        feather.replace();
        
        // Modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Modal controls
            const modals = {
                'detail-modal': 'close-detail-modal',
                'users-modal': 'close-users-modal',
                'help-modal': 'close-help-modal'
            };
            
            Object.entries(modals).forEach(([modalId, closeId]) => {
                const modal = document.getElementById(modalId);
                const closeBtn = document.getElementById(closeId);
                
                closeBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabType = tab.getAttribute('data-tab');
                    if (tabType === 'users') {
                        document.getElementById('users-modal').classList.add('active');
                        loadUserHistory();
                    }
                });
            });
            
            // Help button
            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('active');
            });
            
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadMessages();
            });
            
            // Search functionality
            document.getElementById('search-messages').addEventListener('input', (e) => {
                filterMessages();
            });
            
            document.getElementById('status-filter').addEventListener('change', () => {
                filterMessages();
            });
            
            document.getElementById('sort-filter').addEventListener('change', () => {
                filterMessages();
            });
            
            // User search
            document.getElementById('search-users').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                searchUsers(searchTerm);
            });
            
            // Filter messages function
            function filterMessages() {
                const searchTerm = document.getElementById('search-messages').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;
                const sortFilter = document.getElementById('sort-filter').value;
                
                let filteredMessages = [...allMessages];
                
                // Apply search filter
                if (searchTerm) {
                    filteredMessages = filteredMessages.filter(message => 
                        message.name.toLowerCase().includes(searchTerm) ||
                        message.email.toLowerCase().includes(searchTerm) ||
                        message.subject.toLowerCase().includes(searchTerm) ||
                        (message.message && message.message.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply status filter
                if (statusFilter) {
                    filteredMessages = filteredMessages.filter(message => 
                        (message.status || 'Received') === statusFilter
                    );
                }
                
                // Apply sorting
                if (sortFilter === 'oldest') {
                    filteredMessages.sort((a, b) => a.timestamp - b.timestamp);
                } else if (sortFilter === 'unread') {
                    filteredMessages.sort((a, b) => {
                        if (a.read === b.read) {
                            return b.timestamp - a.timestamp;
                        }
                        return a.read ? 1 : -1;
                    });
                } else {
                    filteredMessages.sort((a, b) => b.timestamp - a.timestamp);
                }
                
                renderMessages(filteredMessages);
            }
        });
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsynsRyRVwNYzOtqG4yDdcy5HWw74aOzY",
            authDomain: "student-s-helpdesk.firebaseapp.com",
            projectId: "student-s-helpdesk",
            storageBucket: "student-s-helpdesk.firebasestorage.app",
            messagingSenderId: "270861175145",
            appId: "1:270861175145:web:b66a5f9fef8ac3104855f8",
            measurementId: "G-VRKD5P955F"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Reference to the database
        const database = firebase.database();
        const messagesRef = database.ref('messages');
        
        // Global variables
        let currentMessageId = null;
        let allMessages = [];
        let userHistoryData = {};
        
        // Format date function
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return `Today at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffDays === 1) {
                return `Yesterday at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString([], {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
        
        // Update stats
        function updateStats(messages) {
            const total = messages.length;
            const inProgress = messages.filter(m => (m.status || 'Received') === 'In Progress').length;
            const resolved = messages.filter(m => (m.status || 'Received') === 'Resolved').length;
            
            document.getElementById('total-messages').textContent = total;
            document.getElementById('in-progress').textContent = inProgress;
            document.getElementById('resolved').textContent = resolved;
        }
        
        // Load all messages
        function loadMessages() {
            messagesRef.on('value', (snapshot) => {
                const messageList = document.getElementById('message-list');
                messageList.innerHTML = '';
                
                const messages = snapshot.val();
                if (messages) {
                    // Sort messages by timestamp (newest first)
                    allMessages = Object.entries(messages).map(([key, value]) => {
                        return {
                            id: key,
                            ...value
                        };
                    }).sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Update stats
                    updateStats(allMessages);
                    
                    // Organize messages by user for history
                    organizeUserHistory(allMessages);
                    
                    renderMessages(allMessages);
                } else {
                    messageList.innerHTML = `
                        <div class="empty-state">
                            <i data-feather="inbox" class="empty-icon"></i>
                            <h3 class="empty-title">No messages found</h3>
                            <p class="empty-message">When messages are received, they will appear here</p>
                        </div>
                    `;
                    
                    // Reset stats
                    document.getElementById('total-messages').textContent = '0';
                    document.getElementById('in-progress').textContent = '0';
                    document.getElementById('resolved').textContent = '0';
                    
                    feather.replace();
                }
            });
        }
        
        // Organize messages by user for history view
        function organizeUserHistory(messages) {
            userHistoryData = {};
            
            messages.forEach(message => {
                // Skip if email is undefined
                if (!message || !message.email) return;
                
                const email = message.email.toLowerCase();
                
                if (!userHistoryData[email]) {
                    userHistoryData[email] = {
                        name: message.name,
                        email: message.email,
                        messages: []
                    };
                }
                
                userHistoryData[email].messages.push({
                    id: message.id,
                    subject: message.subject,
                    message: message.message,
                    status: message.status || 'Received',
                    timestamp: message.timestamp,
                    trackingCode: message.trackingCode,
                    read: message.read
                });
            });
        }
        
        // Load user history
        function loadUserHistory() {
            const usersContainer = document.getElementById('users-container');
            usersContainer.innerHTML = '';
            
            if (Object.keys(userHistoryData).length === 0) {
                usersContainer.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="users" class="empty-icon"></i>
                        <h3 class="empty-title">No user data available</h3>
                        <p class="empty-message">No message history found for any users</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            // Sort users by most recent message
            const sortedUsers = Object.values(userHistoryData).sort((a, b) => {
                const aLatest = a.messages.reduce((latest, msg) => Math.max(latest, msg.timestamp), 0);
                const bLatest = b.messages.reduce((latest, msg) => Math.max(latest, msg.timestamp), 0);
                return bLatest - aLatest;
            });
            
            sortedUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                // Sort messages by timestamp (newest first)
                const sortedMessages = [...user.messages].sort((a, b) => b.timestamp - a.timestamp);
                
                // Get initials for avatar
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                let messageHistoryHTML = '';
                sortedMessages.forEach(msg => {
                    const formattedDate = formatDate(msg.timestamp);
                    const statusClass = `status-${msg.status.replace(' ', '.')}`;
                    
                    messageHistoryHTML += `
                        <div class="user-message" data-id="${msg.id}">
                            <div class="user-message-header">
                                <div class="user-message-subject">${msg.subject}</div>
                                <span class="status-badge ${statusClass}">${msg.status}</span>
                            </div>
                            <div class="user-message-footer">
                                <span>${formattedDate}</span>
                                <span>Tracking: ${msg.trackingCode}</span>
                            </div>
                        </div>
                    `;
                });
                
                userCard.innerHTML = `
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-avatar-lg">${initials}</div>
                            <div class="user-details">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        <span class="message-count">${user.messages.length}</span>
                    </div>
                    <div class="user-messages">
                        ${messageHistoryHTML}
                    </div>
                `;
                
                usersContainer.appendChild(userCard);
            });
            
            // Add click event to user messages
            document.querySelectorAll('.user-message').forEach(item => {
                item.addEventListener('click', () => {
                    const messageId = item.getAttribute('data-id');
                    viewMessageDetail(messageId);
                    document.getElementById('users-modal').classList.remove('active');
                    document.querySelector('.tab.active').classList.remove('active');
                    document.querySelector('.tab:first-child').classList.add('active');
                });
            });
            
            feather.replace();
        }
        
        // Search users
        function searchUsers(searchTerm) {
            const usersContainer = document.getElementById('users-container');
            
            if (searchTerm === '') {
                loadUserHistory();
                return;
            }
            
            const filteredUsers = Object.values(userHistoryData).filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            usersContainer.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                usersContainer.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="search" class="empty-icon"></i>
                        <h3 class="empty-title">No users match your search</h3>
                        <p class="empty-message">Try a different search term</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            filteredUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                // Sort messages by timestamp (newest first)
                const sortedMessages = [...user.messages].sort((a, b) => b.timestamp - a.timestamp);
                
                // Get initials for avatar
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                let messageHistoryHTML = '';
                sortedMessages.forEach(msg => {
                    const formattedDate = formatDate(msg.timestamp);
                    const statusClass = `status-${msg.status.replace(' ', '.')}`;
                    
                    messageHistoryHTML += `
                        <div class="user-message" data-id="${msg.id}">
                            <div class="user-message-header">
                                <div class="user-message-subject">${msg.subject}</div>
                                <span class="status-badge ${statusClass}">${msg.status}</span>
                            </div>
                            <div class="user-message-footer">
                                <span>${formattedDate}</span>
                                <span>Tracking: ${msg.trackingCode}</span>
                            </div>
                        </div>
                    `;
                });
                
                userCard.innerHTML = `
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-avatar-lg">${initials}</div>
                            <div class="user-details">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        <span class="message-count">${user.messages.length}</span>
                    </div>
                    <div class="user-messages">
                        ${messageHistoryHTML}
                    </div>
                `;
                
                usersContainer.appendChild(userCard);
            });
            
            // Add click event to user messages
            document.querySelectorAll('.user-message').forEach(item => {
                item.addEventListener('click', () => {
                    const messageId = item.getAttribute('data-id');
                    viewMessageDetail(messageId);
                    document.getElementById('users-modal').classList.remove('active');
                    document.querySelector('.tab.active').classList.remove('active');
                    document.querySelector('.tab:first-child').classList.add('active');
                });
            });
            
            feather.replace();
        }
        
        // Render messages
        function renderMessages(messages) {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            if (messages.length === 0) {
                messageList.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="search" class="empty-icon"></i>
                        <h3 class="empty-title">No messages match your criteria</h3>
                        <p class="empty-message">Try changing your filters or search term</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            messages.forEach((message, index) => {
                const messageElement = document.createElement('div');
                messageElement.className = message.read ? 'message-card' : 'message-card unread';
                messageElement.id = `message-${message.id}`;
                messageElement.setAttribute('data-id', message.id);
                messageElement.style.animationDelay = `${index * 0.05}s`;
                
                const status = message.status || 'Received';
                const statusClass = `status-${status.replace(' ', '.')}`;
                const formattedDate = formatDate(message.timestamp);
                
                // Fix for the substr error - check if message.message exists before using substr
                const messagePreview = message.message ? 
                    (message.message.length > 200 ? message.message.substring(0, 200) + '...' : message.message) : 
                    'No message content';
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-title">${message.subject}</div>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                    <div class="message-meta">
                        <div class="meta-item">
                            <i data-feather="user"></i>
                            <span>${message.name}</span>
                        </div>
                        <div class="meta-item">
                            <i data-feather="mail"></i>
                            <span>${message.email}</span>
                        </div>
                        <div class="meta-item">
                            <i data-feather="clock"></i>
                            <span>${formattedDate}</span>
                        </div>
                    </div>
                    <div class="message-content">${messagePreview}</div>
                    <div class="message-footer">
                        <div class="tracking-code">
                            <i data-feather="hash"></i>
                            <span>${message.trackingCode}</span>
                        </div>
                        <div class="message-actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewMessageDetail('${message.id}')">
                                <i data-feather="eye"></i>
                                View
                            </button>
                            <!-- Added delete button to message card actions -->
                            <button class="btn btn-sm btn-danger" onclick="deleteMessage('${message.id}', event)">
                                <i data-feather="trash-2"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                
                messageList.appendChild(messageElement);
                
                // Add click event to the entire card
                messageElement.addEventListener('click', () => {
                    viewMessageDetail(message.id);
                });
            });
            
            feather.replace();
        }
        
        // View message detail
        function viewMessageDetail(messageId) {
            currentMessageId = messageId;
            const message = allMessages.find(m => m.id === messageId);
            
            if (!message) return;
            
            // Mark as read
            if (!message.read) {
                messagesRef.child(messageId).update({ read: true });
            }
            
            const detailContent = document.getElementById('detail-content');
            const formattedDate = formatDate(message.timestamp);
            const status = message.status || 'Received';
            
            detailContent.innerHTML = `
                <div class="detail-title">${message.subject}</div>
                
                <div class="detail-meta">
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i data-feather="user"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${message.name}</div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i data-feather="mail"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${message.email}</div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i data-feather="clock"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${formattedDate}</div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i data-feather="hash"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Tracking Code</div>
                            <div class="detail-value">${message.trackingCode}</div>
                        </div>
                    </div>
                </div>
                
                <div class="message-body">
                    ${message.message || 'No message content'}
                </div>
                
                <!-- Added replies section to display existing replies -->
                <div class="replies-section" id="replies-section-${messageId}">
                    <div class="panel-header">
                        <i data-feather="message-circle"></i>
                        <span class="panel-title">Replies</span>
                    </div>
                    <div class="replies-container" id="replies-container-${messageId}">
                        <!-- Replies will be loaded here -->
                    </div>
                </div>
                
                <!-- Added reply form for admin to respond -->
                <div class="reply-form-section">
                    <div class="panel-header">
                        <i data-feather="reply"></i>
                        <span class="panel-title">Send Reply</span>
                    </div>
                    <div class="reply-form">
                        <textarea 
                            class="reply-textarea" 
                            id="reply-text-${messageId}" 
                            placeholder="Type your reply to the student..."
                            rows="4"
                        ></textarea>
                        <div class="reply-actions">
                            <button class="btn btn-primary" onclick="sendReply('${messageId}')">
                                <i data-feather="send"></i>
                                Send Reply
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="action-panel">
                    <div class="panel-header">
                        <i data-feather="settings"></i>
                        <span class="panel-title">Message Actions</span>
                    </div>
                    
                    <div class="action-row">
                        <div class="action-label">Update Status</div>
                        <select class="select-status" id="message-status" onchange="updateMessageStatus('${messageId}', this.value)">
                            <option value="Received" ${status === 'Received' ? 'selected' : ''}>Received</option>
                            <option value="In Progress" ${status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Resolved" ${status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                    </div>
                    
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="copyTrackingCode('${message.trackingCode}')">
                            <i data-feather="copy"></i>
                            Copy Tracking Code
                        </button>
                    </div>
                    
                    <!-- Added delete button to detail modal actions -->
                    <div class="action-row">
                        <button class="btn btn-danger" onclick="deleteMessage('${messageId}')">
                            <i data-feather="trash-2"></i>
                            Delete Message
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').classList.add('active');
            feather.replace();
            
            loadReplies(messageId);
        }
        
        function loadReplies(messageId) {
            const repliesRef = database.ref(`messages/${messageId}/replies`);
            
            repliesRef.on('value', (snapshot) => {
                const replies = snapshot.val();
                const repliesContainer = document.getElementById(`replies-container-${messageId}`);
                
                if (!replies) {
                    repliesContainer.innerHTML = `
                        <div class="no-replies">
                            <i data-feather="message-circle"></i>
                            <span>No replies yet</span>
                        </div>
                    `;
                    feather.replace();
                    return;
                }
                
                // Convert replies object to array and sort by timestamp
                const repliesArray = Object.entries(replies).map(([id, reply]) => ({
                    id,
                    ...reply
                })).sort((a, b) => a.timestamp - b.timestamp);
                
                let repliesHTML = '';
                repliesArray.forEach(reply => {
                    const replyDate = formatDate(reply.timestamp);
                    repliesHTML += `
                        <div class="reply-item">
                            <div class="reply-header">
                                <div class="reply-author">
                                    <i data-feather="user-check"></i>
                                    <span>Admin</span>
                                </div>
                                <div class="reply-date">${replyDate}</div>
                            </div>
                            <div class="reply-content">${reply.message}</div>
                        </div>
                    `;
                });
                
                repliesContainer.innerHTML = repliesHTML;
                feather.replace();
            });
        }
        
        function sendReply(messageId) {
            const replyTextarea = document.getElementById(`reply-text-${messageId}`);
            const replyText = replyTextarea.value.trim();
            
            if (!replyText) {
                showNotification('Please enter a reply message', 'error');
                return;
            }
            
            const replyData = {
                message: replyText,
                timestamp: Date.now(),
                author: 'admin'
            };
            
            // Generate a unique reply ID
            const replyId = Date.now().toString();
            
            // Save reply to Firebase
            database.ref(`messages/${messageId}/replies/${replyId}`).set(replyData)
                .then(() => {
                    // Clear the textarea
                    replyTextarea.value = '';
                    
                    // Update message status to "In Progress" if it's still "Received"
                    const message = allMessages.find(m => m.id === messageId);
                    if (message && message.status === 'Received') {
                        updateMessageStatus(messageId, 'In Progress');
                    }
                    
                    showNotification('Reply sent successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error sending reply:', error);
                    showNotification('Error sending reply', 'error');
                });
        }
        
        // Update message status
        function updateMessageStatus(messageId, newStatus) {
            messagesRef.child(messageId).update({ 
                status: newStatus,
                lastUpdated: Date.now()
            }).then(() => {
                // Update the message card in the list
                const messageCard = document.getElementById(`message-${messageId}`);
                if (messageCard) {
                    const statusBadge = messageCard.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${newStatus.replace(' ', '.')}`;
                        statusBadge.textContent = newStatus;
                    }
                }
                
                // Show success message
                showNotification('Status updated successfully!', 'success');
            }).catch((error) => {
                console.error('Error updating status:', error);
                showNotification('Error updating status', 'error');
            });
        }
        
        // Copy tracking code
        function copyTrackingCode(trackingCode) {
            navigator.clipboard.writeText(trackingCode).then(() => {
                showNotification('Tracking code copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy tracking code', 'error');
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--green-medium)' : type === 'error' ? '#ef4444' : 'var(--primary-dark)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--radius);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                transform: translateX(100%);
                transition: var(--transition);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        function deleteMessage(messageId, event) {
            // Prevent event bubbling if called from card
            if (event) {
                event.stopPropagation();
            }
            
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;
            
            // Show confirmation dialog
            if (confirm(`Are you sure you want to delete this message?\n\nSubject: ${message.subject}\nFrom: ${message.name}\n\nThis action cannot be undone.`)) {
                // Delete from Firebase
                messagesRef.child(messageId).remove()
                    .then(() => {
                        // Remove from local array
                        allMessages = allMessages.filter(m => m.id !== messageId);
                        
                        // Remove from UI
                        const messageCard = document.getElementById(`message-${messageId}`);
                        if (messageCard) {
                            messageCard.remove();
                        }
                        
                        // Close modal if this message was being viewed
                        if (currentMessageId === messageId) {
                            closeModal();
                        }
                        
                        // Update message count
                        updateMessageCount();
                        
                        showNotification('Message deleted successfully!', 'success');
                    })
                    .catch((error) => {
                        console.error('Error deleting message:', error);
                        showNotification('Error deleting message', 'error');
                    });
            }
        }
        
        function updateMessageCount() {
            const messageCountElement = document.querySelector('.stat-number');
            if (messageCountElement) {
                messageCountElement.textContent = allMessages.length;
            }
        }
        
        // Initialize the application
        loadMessages();
    </script>
</body>
</html>
